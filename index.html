<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šçŸ¥è­˜å¤§å†’éšª</title>
    <!-- React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); } 20%, 40%, 60%, 80% { transform: translate(5px, 0); } }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        body { background-color: #312e81; color: white; margin: 0; overflow-x: hidden; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-select { user-select: none; -webkit-user-select: none; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body class="no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. æ™ºèƒ½å¥å‹æ¨¡çµ„ ---
        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I can see the ___.", hint: "æˆ‘çœ‹è¦‹é‚£å€‹..." }, { text: "Do you like the ___?", hint: "ä½ å–œæ­¡é€™å€‹...å—ï¼Ÿ" }, { text: "The ___ is over there.", hint: "é‚£å€‹...åœ¨é‚£é‚Š" }, { text: "I have a ___.", hint: "æˆ‘æœ‰ä¸€å€‹..." }],
            verb: [{ text: "I like to ___.", hint: "æˆ‘å–œæ­¡..." }, { text: "Can you ___?", hint: "ä½ æœƒ...å—ï¼Ÿ" }, { text: "Let's ___ together.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }, { text: "Please ___ now.", hint: "è«‹ç¾åœ¨..." }, { text: "Don't ___ here.", hint: "ä¸è¦åœ¨é€™è£¡..." }],
            adj: [{ text: "It looks very ___.", hint: "å®ƒçœ‹èµ·ä¾†å¾ˆ..." }, { text: "Are you ___?", hint: "ä½ è¦ºå¾—...å—ï¼Ÿ" }, { text: "The cat is ___.", hint: "é€™éš»è²“å¾ˆ..." }, { text: "I feel ___ today.", hint: "æˆ‘ä»Šå¤©è¦ºå¾—å¾ˆ..." }]
        };

        // --- 2. 50å€‹åŸºç¤å–®å­—åº« ---
        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "pig", type: "noun", mean: "è±¬" }, { word: "bird", type: "noun", mean: "é³¥" }, { word: "duck", type: "noun", mean: "é´¨å­" }, { word: "lion", type: "noun", mean: "ç…å­" }, { word: "fish", type: "noun", mean: "é­š" }, { word: "monkey", type: "noun", mean: "çŒ´å­" }, { word: "tiger", type: "noun", mean: "è€è™" }, { word: "zebra", type: "noun", mean: "æ–‘é¦¬" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "banana", type: "noun", mean: "é¦™è•‰" }, { word: "egg", type: "noun", mean: "è›‹" }, { word: "cake", type: "noun", mean: "è›‹ç³•" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶" }, { word: "water", type: "noun", mean: "æ°´" }, { word: "rice", type: "noun", mean: "ç±³é£¯" }, { word: "candy", type: "noun", mean: "ç³–æœ" },
            { word: "sun", type: "noun", mean: "å¤ªé™½" }, { word: "moon", type: "noun", mean: "æœˆäº®" }, { word: "star", type: "noun", mean: "æ˜Ÿæ˜Ÿ" }, { word: "tree", type: "noun", mean: "æ¨¹" }, { word: "flower", type: "noun", mean: "èŠ±" }, { word: "book", type: "noun", mean: "æ›¸" }, { word: "pen", type: "noun", mean: "ç­†" }, { word: "bag", type: "noun", mean: "æ›¸åŒ…" }, { word: "bus", type: "noun", mean: "å…¬è»Š" }, { word: "car", type: "noun", mean: "è»Šå­" },
            { word: "eye", type: "noun", mean: "çœ¼ç›" }, { word: "nose", type: "noun", mean: "é¼»å­" }, { word: "mouth", type: "noun", mean: "å˜´å·´" }, { word: "hand", type: "noun", mean: "æ‰‹" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" }, { word: "walk", type: "verb", mean: "èµ°è·¯" }, { word: "swim", type: "verb", mean: "æ¸¸æ³³" }, { word: "fly", type: "verb", mean: "é£›" }, { word: "eat", type: "verb", mean: "åƒ" }, { word: "drink", type: "verb", mean: "å–" }, { word: "sleep", type: "verb", mean: "ç¡è¦º" }, { word: "draw", type: "verb", mean: "ç•«ç•«" }, { word: "sing", type: "verb", mean: "å”±æ­Œ" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" }, { word: "hot", type: "adj", mean: "ç†±çš„" }, { word: "cold", type: "adj", mean: "å†·çš„" }, { word: "happy", type: "adj", mean: "å¿«æ¨‚çš„" }, { word: "sad", type: "adj", mean: "é›£éçš„" }, { word: "red", type: "adj", mean: "ç´…è‰²çš„" }, { word: "blue", type: "adj", mean: "è—è‰²çš„" }
        ];

        const SCENARIOS = [
            { text: "å¤±ç«äº†ï¼å¿«å¹«å¿™æ»…ç«ï¼", emoji: "ğŸ”¥", type: "tense" }, { text: "æœ‰å°å·ï¼å¿«æŠ“ä½ä»–ï¼", emoji: "ğŸ¦¹", type: "tense" }, { text: "ç—…äººéœ€è¦æ€¥æ•‘ï¼", emoji: "ğŸš‘", type: "tense" }, { text: "å¤–é€è¨‚å–®å¿«é²åˆ°äº†ï¼", emoji: "ğŸ›µ", type: "happy" }, { text: "æˆ¿é–“å¤ªäº‚äº†ï¼", emoji: "ğŸ§¹", type: "happy" }, { text: "è‚šå­å¥½é¤“å–”ï¼", emoji: "ğŸ±", type: "happy" }, { text: "é‡ç”Ÿå™´ç«é¾å‡ºç¾ï¼", emoji: "ğŸ‰", type: "battle" }, { text: "ç™¼ç¾ç¥ç§˜å¯¶ç®±ï¼", emoji: "ğŸ’", type: "battle" }, { text: "æœ€å¾Œä¸€ç§’æŠ•ç±ƒï¼", emoji: "ğŸ€", type: "tense" }, { text: "å¹«çˆ¸çˆ¸æ¥èƒŒï¼", emoji: "ğŸ‘¨", type: "happy" }
        ];

        const INITIAL_STATS = {
            daughter: { lastPlayedDate: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, weeklyHistory: [] },
            son: { lastPlayedDate: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, weeklyHistory: [] }
        };

        const INITIAL_MATH_SETTINGS = {
            daughter: { slots: [{ range: 10, weight: 5 }, { range: 20, weight: 3 }, { range: 50, weight: 2 }] },
            son: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } }
        };

        const CHARACTERS = { daughter: { id: 'daughter', name: 'å°å“æ¦•', avatar: 'ğŸ‘§' }, son: { id: 'son', name: 'å°æ™¨å¸Œ', avatar: 'ğŸ‘¦' } };
        const PARENT_PASSWORD = "28825252";

        // --- éŸ³æ¨‚å¼•æ“ ---
        let audioCtx = null;
        let musicInterval = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, d, w = 'sine', v = 0.05) => { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = w; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d); };
        const stopMusic = () => { if (musicInterval) clearInterval(musicInterval); };
        const playMusic = (style) => {
            stopMusic(); if (!audioCtx) return;
            let scale = [261, 329, 392, 523]; let tempo = 400; let wave = 'sine';
            if (style === 'battle') { scale = [130, 155, 196, 261]; tempo = 200; wave = 'sawtooth'; }
            else if (style === 'tense') { scale = [110, 116, 130]; tempo = 150; wave = 'square'; }
            musicInterval = setInterval(() => { if (Math.random() > 0.4) playTone(scale[Math.floor(Math.random() * scale.length)], tempo / 1000, wave); }, tempo);
        };
        const playSFX = (t) => { if (!audioCtx) return; const n = audioCtx.currentTime; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); if (t === 'attack') { o.frequency.setValueAtTime(200, n); o.frequency.linearRampToValueAtTime(800, n + 0.1); g.gain.setValueAtTime(0.1, n); o.start(); o.stop(n + 0.1); } else if (t === 'win') { [0, 0.1, 0.2].forEach((s, i) => { const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain(); o2.connect(g2); g2.connect(audioCtx.destination); o2.frequency.setValueAtTime(440 + i * 110, n + s); g2.gain.setValueAtTime(0.1, n + s); o2.start(n + s); o2.stop(n + s + 0.3); }); } };

        const speakWord = (text) => { const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [vocabMap, setVocabMap] = useState({ daughter: [...BASE_VOCAB], son: [...BASE_VOCAB] });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [rewards, setRewards] = useState({ levelRewards: {}, dailyScore: Array(5).fill({score:0, reward:""}) });
            const [audioStarted, setAudioStarted] = useState(false);
            
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [hp, setHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [inputMode, setInputMode] = useState('select');
            const [scenario, setScenario] = useState(SCENARIOS[0]);
            const timerRef = useRef(null);

            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('fh_v4_github_complete'));
                if (saved) { setStats(saved.stats); setVocabMap(saved.vocabMap); setMathSettings(saved.mathSettings); setRewards(saved.rewards); }
            }, []);

            useEffect(() => {
                localStorage.setItem('fh_v4_github_complete', JSON.stringify({ stats, vocabMap, mathSettings, rewards }));
            }, [stats, vocabMap, mathSettings, rewards]);

            const pickWeighted = (options) => {
                const total = options.reduce((acc, cur) => acc + cur.weight, 0);
                if(total === 0) return options[0].item;
                let random = Math.random() * total;
                for (let opt of options) { if (random < opt.weight) return opt.item; random -= opt.weight; }
                return options[0].item;
            };

            const generateMathQuestion = (pKey) => {
                if (pKey === 'daughter') {
                    const range = pickWeighted(mathSettings.daughter.slots.map(s => ({ item: s.range, weight: s.weight })));
                    const n1 = Math.floor(Math.random() * range) + 1;
                    const n2 = Math.floor(Math.random() * range) + 1;
                    const op = Math.random() > 0.5 ? '+' : '-';
                    let ans, text;
                    if (op === '+') { ans = n1 + n2; text = `${n1} + ${n2} = ?`; }
                    else { const b = Math.max(n1, n2), s = Math.min(n1, n2); ans = b - s; text = `${b} - ${s} = ?`; }
                    return { text, answer: ans.toString(), time: 30 };
                } else {
                    const mode = pickWeighted(Object.keys(mathSettings.son.weights).map(k => ({ item: k, weight: mathSettings.son.weights[k] })));
                    let n1, n2, ans, text, time = 60;
                    switch (mode) {
                        case 'div-exact': n2 = Math.floor(Math.random() * 8) + 2; ans = Math.floor(Math.random() * 9) + 1; n1 = n2 * ans; text = `${n1} Ã· ${n2} = ?`; ans = ans.toString(); break;
                        case 'div-remain': n2 = Math.floor(Math.random() * 8) + 2; const q = Math.floor(Math.random() * 9) + 1; const r = Math.floor(Math.random() * (n2 - 1)) + 1; n1 = (n2 * q) + r; text = `${n1} Ã· ${n2} = ?`; ans = `${q}r${r}`; time = 90; break;
                        case '2-digit-mult': n1 = Math.floor(Math.random() * 40) + 10; n2 = Math.floor(Math.random() * 20) + 10; ans = n1 * n2; text = `${n1} Ã— ${n2} = ?`; time = 120; break;
                        case '3-digit-add-sub': n1 = Math.floor(Math.random() * 900) + 100; n2 = Math.floor(Math.random() * 900) + 100; if (Math.random() > 0.5) { ans = n1 + n2; text = `${n1} + ${n2} = ?`; } else { ans = Math.max(n1, n2) - Math.min(n1, n2); text = `${Math.max(n1, n2)} - ${Math.min(n1, n2)} = ?`; } time = 90; break;
                        default: n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 90) + 10; ans = Math.random() > 0.5 ? n1 + n2 : Math.max(n1, n2) - Math.min(n1, n2); text = Math.random() > 0.5 ? `${n1} + ${n2} = ?` : `${Math.max(n1, n2)} - ${Math.min(n1, n2)} = ?`; break;
                    }
                    return { text, answer: ans.toString(), time, isRemain: mode === 'div-remain' };
                }
            };

            const generateEnglishQuestion = (pKey) => {
                const pool = vocabMap[pKey] || BASE_VOCAB;
                const wordObj = pool[Math.floor(Math.random() * pool.length)];
                const templates = SENTENCE_TEMPLATES[wordObj.type] || SENTENCE_TEMPLATES['noun'];
                const template = templates[Math.floor(Math.random() * templates.length)];
                const distractors = pool.filter(w => w.word !== wordObj.word).sort(() => 0.5 - Math.random()).slice(0, 3).map(w => w.word);
                while(distractors.length < 3) distractors.push(["sun", "red", "run", "eye"][distractors.length]);
                const options = [wordObj.word, ...distractors].sort(() => 0.5 - Math.random());
                return { text: template.text, answer: wordObj.word, display: template.text.replace('___', '_____'), hint: `${wordObj.mean} (${template.hint})`, options, time: 30, wordObj };
            };

            const handleStart = (mode) => {
                initAudio(); setAudioStarted(true);
                const p = stats[playerKey];
                const myLv = mode === 'daily_math' ? p.dailyMathLevel : p.dailyEnglishLevel;
                const otherLv = mode === 'daily_math' ? p.dailyEnglishLevel : p.dailyMathLevel;
                if (myLv > 0 && myLv % 20 === 0 && otherLv < myLv) {
                    alert(`ğŸš§ éšæ®µæ€§æŒ‘æˆ°ï¼è«‹å…ˆæŠŠå¦ä¸€ç§‘ç›®çš„æŒ‘æˆ°(ç›®å‰ Lv.${otherLv})è¿½ä¸Šä¾†åˆ° Lv.${myLv} æ‰èƒ½è§£é–ä¸‹ä¸€éšæ®µå–”ï¼`);
                    return;
                }
                setGameMode(mode); setPlayerHp(100); setHp(100); setScore(p.dailyScore);
                const startLv = Math.floor(myLv / 10) * 10 + 1;
                setDailyLevel(startLv); nextTurn(mode); setScreen('game');
            };

            const nextTurn = (mode) => {
                const q = mode.includes('math') ? generateMathQuestion(playerKey) : generateEnglishQuestion(playerKey);
                setQuestion(q); setTimer(q.time); setUserAnswer(''); setFeedback(null); setHp(100);
                const sc = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
                setScenario(sc); playMusic(sc.type);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => setTimer(t => t > 0 ? t - 1 : 0), 1000);
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const target = question.answer.toLowerCase();
                const input = val.trim().toLowerCase();
                let isCorrect = question.isRemain ? input.replace(/[\.\s]+/g, 'r') === target : input === target;
                
                if (isCorrect) { playSFX('attack'); setScore(s => s + timer * 10); setFeedback('correct'); if(question.wordObj) speakWord(question.answer); }
                else { playSFX('hurt'); setPlayerHp(h => h - 34); setFeedback('wrong'); }
                
                setTimeout(() => {
                    if (playerHp <= (isCorrect ? 0 : 34)) setScreen('result');
                    else if (isCorrect) {
                        if (dailyLevel % 10 === 0) {
                            const newStats = { ...stats };
                            if (gameMode === 'daily_math') newStats[playerKey].dailyMathLevel = dailyLevel;
                            else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                            setStats(newStats); setScreen('result'); playSFX('win');
                        } else { setDailyLevel(l => l + 1); nextTurn(gameMode); }
                    } else nextTurn(gameMode);
                }, 1500);
            };

            // --- ç•«é¢æ¸²æŸ“ ---
            return (
                <div className="w-full h-screen bg-indigo-900 flex flex-col overflow-hidden relative">
                    {/* éŸ³æ¨‚å•Ÿå‹•é®ç½© */}
                    {screen === 'menu' && !audioStarted && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={()=>{initAudio(); setAudioStarted(true); playMusic('menu');}}>
                            <div className="text-center animate-pulse">
                                <div className="text-6xl mb-4">ğŸµ</div>
                                <h2 className="text-2xl font-bold text-white">é»æ“Šç•«é¢é–‹å§‹éŠæˆ²</h2>
                                <p className="text-gray-400 text-sm mt-2">é–‹å•ŸéŸ³æ•ˆèˆ‡èƒŒæ™¯éŸ³æ¨‚</p>
                            </div>
                        </div>
                    )}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center justify-center h-full">
                            <h1 className="text-4xl font-black text-yellow-400 mb-6 drop-shadow-lg">âš”ï¸ å°å®¶è‹±é›„æ¦œ âš”ï¸</h1>
                            
                            {/* è§’è‰²é¸æ“‡ */}
                            <div className="flex gap-2 mb-6 bg-black/20 p-1 rounded-xl w-full max-w-sm">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={() => setPlayerKey(c.id)} className={`flex-1 py-3 rounded-lg flex items-center justify-center gap-2 font-bold transition-all ${playerKey === c.id ? 'bg-yellow-500 text-black' : 'text-gray-400'}`}>
                                        <span className="text-xl">{c.avatar}</span> {c.name}
                                    </button>
                                ))}
                            </div>

                            {/* ä¸»è¦æ“ä½œå€ */}
                            <div className="bg-white/10 p-6 rounded-[2.5rem] border-4 border-white/20 flex flex-col items-center backdrop-blur-sm w-full max-w-sm mb-6">
                                <div className="text-7xl mb-2 transform hover:scale-110 transition-transform">{CHARACTERS[playerKey].avatar}</div>
                                <div className="grid grid-cols-2 gap-3 w-full mt-4">
                                    <button onClick={() => handleStart('daily_math')} className="bg-orange-500 p-4 rounded-2xl font-bold flex flex-col items-center relative shadow-lg active:translate-y-1 transition-all hover:bg-orange-400">
                                        <div className="text-3xl mb-1">ğŸ§®</div>
                                        <span>æŒ‘æˆ°æ•¸å­¸</span>
                                        <div className="text-xs opacity-70 bg-black/20 px-2 rounded-full mt-1">Lv.{stats[playerKey].dailyMathLevel}</div>
                                    </button>
                                    <button onClick={() => handleStart('daily_english')} className="bg-blue-500 p-4 rounded-2xl font-bold flex flex-col items-center relative shadow-lg active:translate-y-1 transition-all hover:bg-blue-400">
                                        <div className="text-3xl mb-1">ğŸ—£ï¸</div>
                                        <span>æŒ‘æˆ°è‹±æ–‡</span>
                                        <div className="text-xs opacity-70 bg-black/20 px-2 rounded-full mt-1">Lv.{stats[playerKey].dailyEnglishLevel}</div>
                                    </button>
                                </div>
                            </div>

                            {/* åº•éƒ¨æŒ‰éˆ• */}
                            <div className="flex gap-6 text-sm font-bold text-gray-400">
                                <button onClick={() => setScreen('vocab')} className="flex items-center gap-1 hover:text-white bg-white/5 px-4 py-2 rounded-full"><span className="text-lg">ğŸ“–</span> å–®å­—æœ¬</button>
                                <button onClick={() => { const p = prompt("å¯†ç¢¼?"); if (p === PARENT_PASSWORD) setScreen('settings'); }} className="flex items-center gap-1 hover:text-white bg-white/5 px-4 py-2 rounded-full"><span className="text-lg">âš™ï¸</span> ç®¡ç†ä¸­å¿ƒ</button>
                            </div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full flex flex-col bg-slate-900 text-white">
                            {/* é ‚éƒ¨ç‹€æ…‹æ¬„ */}
                            <div className="p-4 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/10">
                                <div className="flex items-center gap-2">
                                    <div className="text-3xl">{CHARACTERS[playerKey].avatar}</div>
                                    <div className="h-3 w-24 bg-gray-700 rounded-full overflow-hidden border border-gray-600"><div className="h-full bg-green-500 transition-all duration-300" style={{width: `${playerHp}%`}}/></div>
                                </div>
                                <div className="text-center font-mono">
                                    <div className="text-yellow-400 text-xs uppercase font-bold tracking-wider">LEVEL {dailyLevel}</div>
                                    <div className={`text-4xl font-bold ${timer < 10 ? 'text-red-500 animate-pulse' : 'text-white'}`}>{timer}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl">{scenario.emoji}</div>
                                    <div className="text-[10px] text-gray-400">{scenario.text}</div>
                                </div>
                            </div>

                            {/* éŠæˆ²ä¸»å€åŸŸ */}
                            <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                                <div className="bg-white/10 backdrop-blur-lg p-8 rounded-[2rem] w-full max-w-xl text-center border border-white/20 shadow-2xl relative overflow-hidden">
                                    {/* ç­”é¡Œåé¥‹é®ç½© */}
                                    {feedback && <div className={`absolute inset-0 bg-black/80 flex items-center justify-center text-8xl font-bold z-20 ${feedback==='correct'?'text-green-500':'text-red-500'} animate-pulse`}>{feedback === 'correct' ? 'â­•' : 'âŒ'}</div>}
                                    
                                    <h3 className="text-blue-300 text-sm font-bold mb-4 uppercase tracking-widest bg-black/30 inline-block px-3 py-1 rounded-full">{gameMode.includes('math') ? 'MATH MISSION' : `ENGLISH: ${question.hint}`}</h3>
                                    
                                    <h2 className="text-4xl md:text-5xl font-black mb-8 leading-tight drop-shadow-md">{gameMode.includes('math') ? question.text : question.display}</h2>
                                    
                                    {gameMode.includes('english') && inputMode === 'select' ? (
                                        <div className="grid grid-cols-2 gap-4">
                                            {question.options.map(opt => (
                                                <button key={opt} onClick={()=>handleAnswer(opt)} className="bg-white/10 hover:bg-indigo-600 py-4 rounded-xl text-xl font-bold border-2 border-white/10 active:scale-95 transition-all shadow-lg">{opt}</button>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="flex gap-2">
                                            <input value={userAnswer} onChange={e => setUserAnswer(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAnswer(userAnswer)} placeholder="è¼¸å…¥ç­”æ¡ˆ..." className="flex-1 bg-black/50 border-2 border-white/30 p-4 text-3xl rounded-xl text-center outline-none focus:border-yellow-400 transition-colors text-white placeholder-gray-600" autoFocus type={gameMode.includes('math') && !question.isRemain ? "tel" : "text"} />
                                            <button onClick={() => handleAnswer(userAnswer)} className="bg-yellow-400 text-black px-8 rounded-xl font-black text-xl shadow-lg active:scale-95">GO</button>
                                        </div>
                                    )}
                                    
                                    {gameMode.includes('english') && (
                                        <div className="mt-8 flex justify-center gap-2 text-xs font-bold">
                                            <button onClick={()=>setInputMode('select')} className={`px-4 py-2 rounded-full transition-colors ${inputMode==='select'?'bg-blue-600 text-white':'bg-white/10 text-gray-400'}`}>é¸æ“‡é¡Œ</button>
                                            <button onClick={()=>setInputMode('type')} className={`px-4 py-2 rounded-full transition-colors ${inputMode==='type'?'bg-purple-600 text-white':'bg-white/10 text-gray-400'}`}>æ‹¼å­—é¡Œ (åŠ åˆ†)</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'vocab' && (
                        <div className="h-full bg-slate-900 p-6 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                                <h2 className="text-2xl font-bold flex items-center gap-2">ğŸ“– å–®å­—æœ¬</h2>
                                <button onClick={() => setScreen('menu')} className="bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold">è¿”å›</button>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                {(vocabMap[playerKey]||BASE_VOCAB).map((v, i) => (
                                    <div key={i} onClick={()=>speakWord(v.word)} className="bg-white/10 p-4 rounded-xl cursor-pointer hover:bg-white/20 border border-white/5 transition-colors active:scale-95">
                                        <div className="font-bold text-blue-300 text-lg mb-1">{v.word}</div>
                                        <div className="text-sm text-gray-400">{v.mean}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {screen === 'settings' && (
                        <div className="h-full p-6 bg-slate-900 overflow-y-auto">
                            <div className="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
                                <h2 className="text-2xl font-bold text-yellow-400 flex items-center gap-2">âš™ï¸ å®¶é•·ç®¡ç†ä¸­å¿ƒ</h2>
                                <button onClick={() => setScreen('menu')} className="bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold">é€€å‡º</button>
                            </div>
                            <div className="space-y-6">
                                <div className="bg-white/5 p-6 rounded-2xl border border-white/10">
                                    <h3 className="font-bold mb-4 flex items-center gap-2 text-lg">ğŸ’¾ é€²åº¦å‚™ä»½èˆ‡åŒæ­¥</h3>
                                    <div className="flex flex-col gap-3">
                                        <button onClick={() => { const code = btoa(JSON.stringify({ stats, vocabMap, mathSettings, rewards })); navigator.clipboard.writeText(code); alert("å­˜æª”ä»£ç¢¼å·²è¤‡è£½ï¼è«‹å‚³é€åˆ°å¦ä¸€å°è£ç½®ã€‚"); }} className="w-full bg-blue-600 p-4 rounded-xl font-bold shadow-lg active:scale-95">è¤‡è£½å­˜æª”ä»£ç¢¼ (åŒ¯å‡º)</button>
                                        <button onClick={() => { const code = prompt("è«‹è²¼ä¸Šå­˜æª”ä»£ç¢¼"); if (code) { try { const d = JSON.parse(atob(code)); setStats(d.stats); setVocabMap(d.vocabMap); setMathSettings(d.mathSettings); setRewards(d.rewards); alert("è®€å–æˆåŠŸï¼é€²åº¦å·²åŒæ­¥ã€‚"); } catch(e){alert("ä»£ç¢¼éŒ¯èª¤ï¼");} } }} className="w-full bg-orange-600 p-4 rounded-xl font-bold shadow-lg active:scale-95">è®€å–å­˜æª”ä»£ç¢¼ (åŒ¯å…¥)</button>
                                    </div>
                                    <p className="text-xs text-gray-500 text-center mt-3">æç¤ºï¼šæƒ³åœ¨é›»è…¦ç© iPad çš„é€²åº¦ï¼Ÿåœ¨ iPad æŒ‰è¤‡è£½ï¼Œå‚³çµ¦é›»è…¦è²¼ä¸Šè®€å–å³å¯ã€‚</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'result' && (
                        <div className="h-full flex flex-col items-center justify-center p-8 text-center animate-in fade-in zoom-in duration-500">
                            {dailyLevel % 10 === 0 && playerHp > 0 ? (
                                <>
                                    <div className="text-8xl mb-4 animate-bounce">ğŸ†</div>
                                    <h2 className="text-5xl font-black text-yellow-400 mb-4 drop-shadow-lg">å¤§ç²å…¨å‹ï¼</h2>
                                    <p className="text-gray-300 mb-10 text-xl font-bold">æ­å–œé€šéç¬¬ <span className="text-white text-3xl">{dailyLevel}</span> é—œ</p>
                                </>
                            ) : (
                                <>
                                    <div className="text-8xl mb-4 text-gray-500">ğŸ’€</div>
                                    <h2 className="text-4xl font-black text-gray-400 mb-4">å†æ¥å†å²...</h2>
                                    <p className="text-gray-500 mb-10 text-xl">è‹±é›„ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†ä¾†æŒ‘æˆ°ï¼</p>
                                </>
                            )}
                            <button onClick={() => setScreen('menu')} className="bg-white text-indigo-900 px-16 py-5 rounded-2xl font-black text-2xl shadow-2xl hover:scale-105 transition-all">è¿”å›åŸºåœ°</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
