<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šæ€ªç¸å¤§è¨ä¼</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- è«‹ç¢ºèªæ‚¨çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCagXSigdL09-OK4G5jF20Hj3iXnRVQs-M",
            authDomain: "family-hero-f89f7.firebaseapp.com",
            projectId: "family-hero-f89f7",
            storageBucket: "family-hero-f89f7.firebasestorage.app",
            messagingSenderId: "900050172486",
            appId: "1:900050172486:web:bdb1904fd5bc7cf9eba847",
            measurementId: "G-G3FBB69BBD"
        };

        try {
            // ç°¡å–®æª¢æŸ¥æ˜¯å¦å·²å¡«å¯« Configï¼Œé¿å…å ±éŒ¯
            if (firebaseConfig.apiKey.includes("AIzaSy")) {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.provider = new GoogleAuthProvider();
                window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; 
                window.onSnapshot = onSnapshot; window.updateDoc = updateDoc; window.increment = increment;
                window.signInWithPopup = signInWithPopup; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
                console.log("ğŸ”¥ Firebase Ready");
            } else {
                console.log("âš ï¸ Firebase Config æœªå¡«å¯«ï¼Œå°‡ä»¥å–®æ©Ÿæ¨¡å¼é‹è¡Œ");
            }
        } catch (e) { console.error("Firebase Init Error", e); }
    </script>

    <style>
        /* --- å‹•ç•«ç‰¹æ•ˆå€ --- */
        body { background-color: #0f172a; color: white; margin: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        @keyframes idle-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .anim-idle { animation: idle-float 3s ease-in-out infinite; }
        
        @keyframes snow-fall { 0% { transform: translateY(-10px) rotate(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(100px) rotate(360deg); opacity: 0; } }
        .effect-snow { position: absolute; animation: snow-fall 1s linear forwards; pointer-events: none; }

        @keyframes ice-blast { 0% { transform: scale(0); opacity: 1; filter: blur(0); } 100% { transform: scale(4); opacity: 0; filter: blur(10px); } }
        .effect-ice { position: absolute; top: 40%; left: 70%; width: 60px; height: 60px; background: radial-gradient(circle, white, #7dd3fc); animation: ice-blast 0.5s ease-out forwards; z-index: 50; border-radius: 50%; box-shadow: 0 0 30px #0ea5e9; }
        
        @keyframes beetle-crush { 0% { transform: scale(0.5); opacity: 0; } 20% { opacity: 1; } 50% { transform: scale(1.5); } 100% { transform: scale(1.2); opacity: 0; } }
        .effect-crush { position: absolute; top: 40%; left: 70%; font-size: 6rem; animation: beetle-crush 0.4s ease-out forwards; z-index: 50; filter: drop-shadow(0 0 10px #22c55e); }

        @keyframes screen-shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, -5px); } }
        .shake-active { animation: screen-shake 0.2s infinite; }

        /* èƒŒæ™¯æµå‹• */
        .bg-ice-castle { background: linear-gradient(to bottom, #1e3a8a, #0c4a6e, #082f49); }
        .bg-beetle-forest { background: linear-gradient(to bottom, #064e3b, #14532d, #022c22); }
        
        /* è§’è‰²èº«é«”æ§‹é€  */
        .char-container { position: relative; width: 100px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        .char-head { font-size: 3.5rem; z-index: 10; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }
        .char-body { width: 38px; height: 48px; border-radius: 8px; position: relative; z-index: 5; margin-top: -10px; }
        .char-body.princess { background: linear-gradient(180deg, #bae6fd, #0284c7); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .char-body.hero { background: linear-gradient(180deg, #4ade80, #166534); border: 2px solid #bbf7d0; }
        .char-limb { width: 8px; height: 26px; background: #fda4af; position: absolute; border-radius: 4px; }
        .arm-l { left: -6px; top: 5px; transform: rotate(20deg); }
        .arm-r { right: -6px; top: 5px; transform: rotate(-20deg); }
        .leg-l { left: 8px; bottom: -20px; height: 32px; background: #334155; }
        .leg-r { right: 8px; bottom: -20px; height: 32px; background: #334155; }
        
        .slot-hat { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 20; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .slot-weapon { position: absolute; top: 30px; right: -25px; font-size: 2rem; z-index: 20; transform: rotate(-15deg); filter: drop-shadow(0 0 5px gold); }
        .slot-pet { position: absolute; bottom: 0; left: -40px; font-size: 1.8rem; animation: idle-float 3s infinite; }

        input:focus { border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); }
    </style>
</head>
<body>
    <div id="root" class="flex h-screen w-full items-center justify-center text-xl font-bold">
        <div class="animate-pulse">ğŸš€ éŠæˆ²è¼‰å…¥ä¸­...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- éŒ¯èª¤é‚Šç•Œ (Error Boundary) ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Game Crashed:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen w-full flex flex-col items-center justify-center bg-red-900 text-white p-8 text-center">
                            <h1 className="text-4xl font-bold mb-4">âš ï¸ å“å‘€ï¼éŠæˆ²å¡ä½äº†</h1>
                            <p className="mb-6">å¯èƒ½æ˜¯å­˜æª”è³‡æ–™ç™¼ç”Ÿäº†è¡çªã€‚</p>
                            <button 
                                onClick={() => { localStorage.clear(); window.location.reload(); }}
                                className="bg-white text-red-900 px-8 py-4 rounded-2xl font-bold text-xl shadow-lg active:scale-95"
                            >
                                é‡ç½®å­˜æª”ä¸¦ä¿®å¾©
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- æ ¸å¿ƒè³‡æ–™ ---
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'å†°é›ªå¥³ç‹æ¦•', avatar: 'ğŸ‘¸', theme: 'princess', color: 'text-cyan-300', bg: 'bg-ice-castle', attackType: 'ice', needPwd: true }, 
            son: { id: 'son', name: 'ç”²èŸ²ç‹è€…å¸Œ', avatar: 'ğŸ‘¦', theme: 'hero', color: 'text-green-400', bg: 'bg-beetle-forest', attackType: 'beetle', needPwd: true }, 
            mom: { id: 'mom', name: 'ç¥åŠ›å¥³è¶…äºº', avatar: 'ğŸ‘©', theme: 'hero', color: 'text-yellow-400', bg: 'bg-slate-800', attackType: 'magic', needPwd: true }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', theme: 'hero', color: 'text-blue-400', bg: 'bg-slate-900', attackType: 'slash', needPwd: false } 
        };

        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I see a ___.", hint: "æˆ‘çœ‹è¦‹ä¸€å€‹..." }],
            verb: [{ text: "I can ___.", hint: "æˆ‘æœƒ..." }, { text: "Let's ___.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }],
            adj: [{ text: "It is ___.", hint: "å®ƒå¾ˆ..." }],
            number: [{ text: "Count to ___.", hint: "æ•¸åˆ°..." }]
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "lion", type: "noun", mean: "ç…å­" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶", u:true },
            { word: "book", type: "noun", mean: "æ›¸" }, { word: "car", type: "noun", mean: "è»Š" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" },
            { word: "happy", type: "adj", mean: "å¿«æ¨‚" }, { word: "red", type: "adj", mean: "ç´…" }
        ];

        const NUMBERS_1_10 = [{ word: "one", type: "number", mean: "ä¸€", isFocus:true }, { word: "two", type: "number", mean: "äºŒ", isFocus:true }, { word: "three", type: "number", mean: "ä¸‰", isFocus:true }, { word: "four", type: "number", mean: "å››", isFocus:true }, { word: "five", type: "number", mean: "äº”", isFocus:true }, { word: "six", type: "number", mean: "å…­", isFocus:true }, { word: "seven", type: "number", mean: "ä¸ƒ", isFocus:true }, { word: "eight", type: "number", mean: "å…«", isFocus:true }, { word: "nine", type: "number", mean: "ä¹", isFocus:true }, { word: "ten", type: "number", mean: "å", isFocus:true }];
        const BROTHER_EXTRAS = [{ word: "tired", type: "adj", mean: "ç´¯çš„", isFocus:true }, { word: "angry", type: "adj", mean: "ç”Ÿæ°£çš„", isFocus:true }, { word: "strong", type: "adj", mean: "å¼·å£¯çš„", isFocus:true }, { word: "thin", type: "adj", mean: "ç˜¦çš„", isFocus:true }, { word: "short", type: "adj", mean: "çŸ­/çŸ®çš„", isFocus:true }, { word: "tall", type: "adj", mean: "é«˜çš„", isFocus:true }];

        const ITEMS_DB = {
            princess: {
                math: [{ id: 'pm1', icon: 'ğŸª„', type: 'weapon', effect: 'magic' }, { id: 'pm2', icon: 'ğŸ‘‘', type: 'head' }, { id: 'pm3', icon: 'ğŸ§šâ€â™€ï¸', type: 'pet' }, { id: 'pm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'pm5', icon: 'ğŸ§ª', type: 'skill_heal', name:'è–æ°´' }],
                english: [{ id: 'pe1', icon: 'ğŸŒŸ', type: 'weapon', effect: 'magic' }, { id: 'pe2', icon: 'ğŸ‘’', type: 'head' }, { id: 'pe3', icon: 'ğŸ¦„', type: 'pet' }, { id: 'pe4', icon: 'ğŸ“–', type: 'shield' }, { id: 'pe5', icon: 'â³', type: 'skill_time', name:'æ‡·éŒ¶' }]
            },
            hero: {
                math: [{ id: 'hm1', icon: 'âš”ï¸', type: 'weapon', effect: 'slash' }, { id: 'hm2', icon: 'â›‘ï¸', type: 'head' }, { id: 'hm3', icon: 'ğŸ²', type: 'pet' }, { id: 'hm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'hm5', icon: 'ğŸ–', type: 'skill_heal', name:'çƒ¤è‚‰' }],
                english: [{ id: 'he1', icon: 'ğŸ—¡ï¸', type: 'weapon', effect: 'slash' }, { id: 'he2', icon: 'ğŸ§¢', type: 'head' }, { id: 'he3', icon: 'ğŸº', type: 'pet' }, { id: 'he4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'he5', icon: 'â°', type: 'skill_time', name:'é¬§é˜' }]
            }
        };

        const MONSTERS = ["ğŸ‘¾","ğŸ‘½","ğŸ¦–","ğŸ¦•","ğŸ™","ğŸ¦‘","ğŸ¦‚","ğŸ•·ï¸","ğŸ¦Ÿ","ğŸª³","ğŸ‘¹","ğŸ‘º","ğŸ²","ğŸ‰"];
        
        // å®‰å…¨çš„åˆå§‹åŒ–è³‡æ–™
        const getInitialStat = () => ({ dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, earnedItems: [], monsterBook: [] });
        const INITIAL_STATS = { daughter: getInitialStat(), son: getInitialStat(), mom: getInitialStat(), challenger: getInitialStat() };
        
        const INITIAL_MATH_SETTINGS = { daughter: { slots: [{ range: 10, weight: 5 }, { range: 20, weight: 3 }, { range: 50, weight: 2 }] }, son: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } }, challenger: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } } };
        const PARENT_PASSWORD = "28825252";
        const FAMILY_PASSWORD = "168";

        let audioCtx = null;
        let bgmInterval = null;

        const initAudio = () => { 
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
        };

        const playTone = (f, t, v=0.2, d=0.1) => { 
            if(!audioCtx) return; 
            const o=audioCtx.createOscillator(); 
            const g=audioCtx.createGain(); 
            o.type=t; 
            o.frequency.value=f; 
            g.gain.value=v * 2.0; 
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); 
            o.connect(g); 
            g.connect(audioCtx.destination); 
            o.start(); 
            o.stop(audioCtx.currentTime+d); 
        };

        const playSFX = (t) => { 
            if(!audioCtx) return; 
            if(t==='ice'){playTone(1000,'sine',0.3,0.5);setTimeout(()=>playTone(1200,'sine',0.2,0.4),100);} 
            else if(t==='hit'){playTone(80,'sawtooth',0.5,0.2);} 
            else if(t==='win'){[440,554,659].forEach((f,i)=>setTimeout(()=>playTone(f,'sine',0.3,0.3),i*100));} 
        };

        const playBGM = () => {
            if(bgmInterval) clearInterval(bgmInterval);
            if(!audioCtx) return;
            let note = 0;
            bgmInterval = setInterval(() => {
                if(Math.random() > 0.7) playTone(220 + (note%3)*100, 'triangle', 0.05, 0.2);
                note++;
            }, 500);
        };

        const stopBGM = () => { if(bgmInterval) clearInterval(bgmInterval); };

        const speakWord = (text) => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.85; u.volume = 1.0; window.speechSynthesis.speak(u); } };

        const LucideIcon = ({ name }) => {
            const [Icon, setIcon] = useState(null);
            useEffect(() => { if(window.lucide && window.lucide.icons) { const n = name.replace(/-([a-z])/g, g=>g[1].toUpperCase()); const N = n.charAt(0).toUpperCase() + n.slice(1); setIcon(window.lucide.icons[N]); } }, [name]);
            return Icon ? <Icon size={24} /> : <span>âš™ï¸</span>;
        };

        const FullBodyChar = ({ charId, items, isAnimating }) => {
            const char = CHARACTERS[charId];
            const theme = char.theme;
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            const myGear = allItems.filter(i => items && items.includes(i.id));
            const hat = myGear.find(i => i.type === 'head');
            const weapon = myGear.find(i => i.type === 'weapon');
            const shield = myGear.find(i => i.type === 'shield');
            const pet = myGear.find(i => i.type === 'pet');

            return (
                <div className={`char-container transition-transform duration-200 ${isAnimating === 'attack' ? 'translate-x-10' : ''} ${isAnimating === 'hurt' ? 'animate-shake' : ''}`}>
                    {hat && <div className="slot-hat">{hat.icon}</div>}
                    <div className="char-head">{char.avatar}</div>
                    <div className={`char-body ${theme}`}>
                        <div className="char-limb arm-l"></div><div className="char-limb arm-r"></div><div className="char-limb leg-l"></div><div className="char-limb leg-r"></div>
                    </div>
                    {weapon && <div className="slot-weapon">{weapon.icon}</div>}
                    {shield && <div className="slot-shield">{shield.icon}</div>}
                    {pet && <div className="slot-pet">{pet.icon}</div>}
                </div>
            );
        };

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [momMode, setMomMode] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [vocabMap, setVocabMap] = useState({ daughter: [], son: [], mom: [], challenger: [] });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [userObj, setUserObj] = useState(null);
            
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [monsterHp, setMonsterHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [inputMode, setInputMode] = useState('select');
            const [showModeChoice, setShowModeChoice] = useState(false);
            const [animState, setAnimState] = useState('idle');
            const [effectType, setEffectType] = useState(null);
            const [audioEnabled, setAudioEnabled] = useState(false);
            const timerRef = useRef(null);

            const getInitialVocab = (role) => {
                let list = [...BASE_VOCAB];
                if (role === 'daughter' || role === 'son') list = [...list, ...NUMBERS_1_10];
                if (role === 'son') {
                    list = [...list, ...BROTHER_EXTRAS];
                    list = list.map(v => (['happy','sad'].includes(v.word) ? { ...v, isFocus: true } : v));
                }
                const unique = []; const map = new Map();
                for (const item of list) { if(!map.has(item.word)){ map.set(item.word, true); unique.push(item); } else if (item.isFocus) { const idx = unique.findIndex(u => u.word === item.word); unique[idx] = item; } }
                return unique;
            };

            // --- Robust Data Loading ---
            useEffect(() => {
                try {
                    // Force reset vocab maps to default first to avoid empty screen
                    const defaultVocab = { 
                        daughter: getInitialVocab('daughter'), 
                        son: getInitialVocab('son'), 
                        mom: getInitialVocab('mom'), 
                        challenger: getInitialVocab('challenger') 
                    };
                    setVocabMap(defaultVocab);

                    const saved = JSON.parse(localStorage.getItem('fh_v15_stable'));
                    if (saved) {
                        // Merge saved data safely
                        const safeStats = { ...INITIAL_STATS };
                        Object.keys(INITIAL_STATS).forEach(role => {
                            if (saved.stats && saved.stats[role]) safeStats[role] = { ...INITIAL_STATS[role], ...saved.stats[role] };
                        });
                        setStats(safeStats);
                        if (saved.vocabMap) setVocabMap(prev => ({ ...prev, ...saved.vocabMap }));
                        if (saved.mathSettings) setMathSettings(saved.mathSettings);
                    }

                    if (window.auth) {
                        window.onAuthStateChanged(window.auth, async (u) => {
                            setUserObj(u);
                            if(u) {
                                try {
                                    const snap = await window.getDoc(window.doc(window.db, "users", u.uid));
                                    if (snap.exists()) {
                                        const d = snap.data();
                                        if (d.stats) setStats(d.stats); // Simplified merge for cloud
                                    }
                                } catch(e) { console.warn("Cloud load warning", e); }
                            }
                        });
                    }
                } catch (e) {
                    console.error("Critical Init Error", e);
                    // Critical failure? Fallback to defaults
                }
            }, []);

            const saveAll = (newStats) => {
                const updated = newStats || stats;
                setStats(updated);
                const dataToSave = { stats: updated, vocabMap, mathSettings };
                localStorage.setItem('fh_v15_stable', JSON.stringify(dataToSave));
                if (userObj && window.db) {
                    try { window.setDoc(window.doc(window.db, "users", userObj.uid), dataToSave); } catch(e){}
                }
            };

            const toggleAudio = () => { if (!audioEnabled) { initAudio(); setAudioEnabled(true); playBGM(); } else { stopBGM(); setAudioEnabled(false); } };

            const pickWeighted = (opts) => { let total = opts.reduce((a,c)=>a+c.weight,0); let r = Math.random()*total; for(let o of opts){ if(r<o.weight)return o.item; r-=o.weight; } return opts[0].item; };
            
            const generateMathQuestion = (role) => {
                const sRole = role === 'challenger' ? 'son' : role;
                if (sRole === 'daughter') {
                    const range = pickWeighted(mathSettings.daughter.slots.map(s => ({ item: s.range, weight: s.weight })));
                    const n1 = Math.floor(Math.random()*range)+1; const n2 = Math.floor(Math.random()*range)+1;
                    return Math.random()>0.5 ? {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:30} : {text:`${Math.max(n1,n2)}-${Math.min(n1,n2)}=?`, answer:(Math.max(n1,n2)-Math.min(n1,n2)).toString(), time:30};
                } else {
                    const settings = mathSettings[sRole] || mathSettings.son;
                    const mode = pickWeighted(Object.keys(settings.weights).map(k=>({item:k, weight:settings.weights[k]})));
                    if(mode.includes('mult')) { const n1=Math.floor(Math.random()*9)+1; const n2=Math.floor(Math.random()*9)+1; return {text:`${n1}x${n2}=?`, answer:(n1*n2).toString(), time:60}; }
                    else if(mode.includes('div')) { const n2=Math.floor(Math.random()*8)+2; const ans=Math.floor(Math.random()*9)+1; const r=mode==='div-remain'?Math.floor(Math.random()*(n2-1))+1:0; return {text:`${n2*ans+r}Ã·${n2}=?`, answer:mode==='div-remain'?`${ans}r${r}`:ans.toString(), time:90, isRemain:mode==='div-remain'}; }
                    else { const n1=Math.floor(Math.random()*50)+10; const n2=Math.floor(Math.random()*50)+10; return {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:60}; }
                }
            };

            const generateEnglishQuestion = (role) => {
                const pool = vocabMap[role] || BASE_VOCAB;
                const w = pool[Math.floor(Math.random()*pool.length)];
                const tmpl = SENTENCE_TEMPLATES[w.type] ? SENTENCE_TEMPLATES[w.type][0] : SENTENCE_TEMPLATES.noun[0];
                let txt = tmpl.text.replace('___', '_____');
                if (txt.includes("a _____")) { if (w.u) txt=txt.replace("a _____","some _____"); else if(['a','e','i','o','u'].includes(w.word[0])) txt=txt.replace("a _____","an _____"); }
                const full = tmpl.text.replace('___', w.word);
                const opts = pool.filter(v=>v.word!==w.word).sort(()=>0.5-Math.random()).slice(0,3).map(v=>v.word);
                return { text:txt, fullSentence:full, answer:w.word, options:[w.word,...opts].sort(()=>0.5-Math.random()), time:30, wordObj:w, hint:tmpl.hint };
            };

            const handleStartClick = (mode) => { if (mode === 'daily_english') setShowModeChoice(true); else startGame('math', 'select'); };
            const startGame = (mode, iMode) => {
                if (CHARACTERS[playerKey].needPwd && prompt("å®¶äººå¯†ç¢¼ (168)") !== FAMILY_PASSWORD) return alert("å¯†ç¢¼éŒ¯èª¤");
                if (!audioEnabled) toggleAudio();
                const curLv = mode.includes('math') ? stats[playerKey].dailyMathLevel : stats[playerKey].dailyEnglishLevel;
                const finalInputMode = (curLv >= 60 && mode.includes('english')) ? 'type' : iMode;
                setGameMode(mode); setInputMode(finalInputMode); setPlayerHp(100); setDailyLevel(curLv + 1);
                nextTurn(mode); setScreen('game'); setShowModeChoice(false);
            };

            const nextTurn = (mode) => {
                setAnimState('idle'); setEffectType(null); setUserAnswer(''); setFeedback(null);
                const q = generateQuestion(mode.includes('math')?'math':'english');
                setQuestion(q); setTimer(q.time);
                if (mode.includes('english')) setTimeout(()=>speakWord(q.fullSentence), 500);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000);
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const isCorrect = val.toString().toLowerCase().trim() === question.answer.toLowerCase();
                if (isCorrect) {
                    setAnimState('playerAttack'); setEffectType(CHARACTERS[playerKey].attackType); playSFX(CHARACTERS[playerKey].attackType === 'ice' ? 'ice' : 'hit');
                    setFeedback('correct'); const base = 100 + timer * 5; const bonus = inputMode === 'type' ? 1.5 : 1; const pts = Math.round(base * bonus); setScore(s => s + pts);
                    if(question.wordObj) speakWord(question.fullSentence);
                    setTimeout(() => {
                        const newStats = JSON.parse(JSON.stringify(stats)); 
                        if (gameMode.includes('math')) newStats[playerKey].dailyMathLevel = dailyLevel; else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                        newStats[playerKey].dailyScore += pts; saveAll(newStats);
                        if (dailyLevel % 5 === 0) setScreen('result'); else { setDailyLevel(l=>l+1); nextTurn(gameMode); }
                    }, 1200);
                } else {
                    setAnimState('hurt'); playSFX('hit'); setFeedback('wrong'); setPlayerHp(h => Math.max(0, h - 34));
                    setTimeout(() => { if (playerHp <= 34) setScreen('result'); else nextTurn(gameMode); }, 1000);
                }
            };

            return (
                <div className={`w-full h-screen flex flex-col overflow-hidden relative ${CHARACTERS[playerKey].bg} transition-all duration-1000`}>
                    {screen === 'menu' && !audioEnabled && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={toggleAudio}>
                            <div className="text-center animate-pulse"><div className="text-6xl mb-4 text-yellow-400">ğŸ”Š</div><h2 className="text-3xl font-black text-white">é»æ“Šé–‹å•ŸéŸ³æ•ˆ</h2></div>
                        </div>
                    )}

                    {screen === 'menu' && (
                        <div className="p-6 flex flex-col items-center justify-center h-full z-10 space-y-6">
                            <div className="w-full flex justify-end px-4"><button onClick={toggleAudio} className="bg-black/30 p-2 rounded-full text-white">{audioEnabled ? <LucideIcon name="volume-2" /> : <LucideIcon name="volume-x" />}</button></div>
                            <h1 className="text-4xl font-black text-yellow-400 drop-shadow-lg tracking-widest">å°å®¶è‹±é›„æ¦œ</h1>
                            <div className="flex gap-4">{Object.values(CHARACTERS).map(c => (<button key={c.id} onClick={()=>setPlayerKey(c.id)} className={`flex flex-col items-center p-3 rounded-2xl border-2 transition-all ${playerKey===c.id?'border-yellow-400 bg-white/20 scale-110 shadow-xl':'border-transparent opacity-50'}`}><div className="text-4xl anim-idle">{c.avatar}</div><div className="text-xs font-bold mt-2">{c.name}</div></button>))}</div>
                            <div className="bg-white/10 p-8 rounded-[3rem] w-full max-w-sm border-2 border-white/20 backdrop-blur-md text-center">
                                <div className={`text-9xl mb-6 anim-idle ${CHARACTERS[playerKey].color}`}>{CHARACTERS[playerKey].avatar}</div>
                                <div className="grid grid-cols-1 gap-4">
                                    <button onClick={()=>handleStartClick('daily_math')} className="bg-orange-600 p-4 rounded-2xl font-bold flex items-center justify-between px-8 shadow-lg active:scale-95"><div className="flex items-center gap-3"><span className="text-2xl">ğŸ§®</span> æ•¸å­¸æŒ‘æˆ°</div><div className="text-xs bg-black/30 px-2 py-1 rounded">Lv.{stats[playerKey].dailyMathLevel}</div></button>
                                    <button onClick={()=>handleStartClick('daily_english')} className="bg-blue-600 p-4 rounded-2xl font-bold flex items-center justify-between px-8 shadow-lg active:scale-95"><div className="flex items-center gap-3"><span className="text-2xl">ğŸ—£ï¸</span> è‹±æ–‡æŒ‘æˆ°</div><div className="text-xs bg-black/30 px-2 py-1 rounded">Lv.{stats[playerKey].dailyEnglishLevel}</div></button>
                                </div>
                            </div>
                            {showModeChoice && (
                                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50 animate-pop">
                                    <div className="bg-slate-800 w-full max-w-md rounded-3xl p-6 border-2 border-blue-400">
                                        <h3 className="text-2xl font-bold text-center mb-6 text-blue-300">é¸æ“‡è‹±æ–‡æˆ°é¬¥é¢¨æ ¼</h3>
                                        <div className="space-y-4">
                                            {stats[playerKey].dailyEnglishLevel < 60 && <button onClick={()=>startGame('daily_english', 'select')} className="w-full bg-white/10 p-4 rounded-2xl border border-white/20 hover:bg-white/20 text-left"><div className="font-bold text-lg text-white">ğŸŸ¢ é¸æ“‡é¡Œæ¨¡å¼ (Easy)</div><div className="text-xs text-gray-400">åˆ©ï¼šé»æ“Šé€Ÿåº¦å¿«ã€‚</div></button>}
                                            <button onClick={()=>startGame('daily_english', 'type')} className="w-full bg-blue-600/50 p-4 rounded-2xl border-2 border-blue-400 text-left"><div className="font-bold text-lg text-yellow-400">ğŸ”¥ æ‹¼å­—é¡Œæ¨¡å¼ (Hard)</div><div className="text-xs text-blue-100">1.5 å€åˆ†æ•¸åŠ æˆï¼</div></button>
                                        </div>
                                        <button onClick={()=>setShowModeChoice(false)} className="mt-6 w-full py-2 text-gray-400">è¿”å›</button>
                                    </div>
                                </div>
                            )}
                            <div className="flex gap-4 text-sm text-gray-400"><button onClick={()=>{if(prompt("å¯†ç¢¼")===PARENT_PASSWORD) setScreen('settings')}} className="hover:text-white">âš™ï¸ ç®¡ç†ä¸­å¿ƒ</button></div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full flex flex-col relative z-10">
                            <div className="p-4 flex justify-between items-center bg-black/40 backdrop-blur-md">
                                <div className="flex items-center gap-3"><div className="text-3xl">{CHARACTERS[playerKey].avatar}</div><div className="w-24 h-4 bg-gray-700 rounded-full overflow-hidden border border-white/20"><div className="h-full bg-green-500 transition-all duration-500" style={{width: playerHp+'%'}} /></div></div>
                                <div className="text-center"><div className="text-xs font-bold text-yellow-400 tracking-widest">LEVEL {dailyLevel}</div><div className={`text-4xl font-mono font-bold ${timer<5?'text-red-500 animate-pulse':''}`}>{timer}</div></div>
                                <div className="text-4xl">ğŸ‘¹</div>
                            </div>
                            <div className={`flex-1 relative flex items-center justify-between px-8 sm:px-20 overflow-hidden ${animState==='hurt'?'shake-active':''}`}>
                                <div className={`transition-transform duration-200 ${animState==='playerAttack'?'translate-x-20 scale-110':''}`}><FullBodyChar charId={playerKey} items={[]} isAnimating={animState} /></div>
                                {effectType === 'ice' && <div className="effect-ice"></div>}{effectType === 'beetle' && <div className="effect-crush">ğŸª²</div>}
                                <div className={`text-9xl anim-idle transition-all duration-300 ${animState==='playerAttack'?'anim-damage opacity-50':''}`}>{MONSTERS[dailyLevel % MONSTERS.length]}</div>
                            </div>
                            <div className="bg-slate-900/90 p-6 rounded-t-[3rem] border-t-2 border-white/10 pb-12 shadow-2xl">
                                <div className="text-center mb-6">
                                    <div className="text-xs font-bold text-blue-400 mb-2 uppercase tracking-tighter">{gameMode.includes('math')?'MATH':`ENGLISH`}</div>
                                    {gameMode.includes('english') ? (<div onClick={() => speakWord(question.fullSentence)} className="cursor-pointer active:scale-95 transition-transform bg-white/5 p-4 rounded-2xl border border-white/10 flex items-center justify-center gap-3"><LucideIcon name="volume-2" className="text-yellow-400 w-6 h-6 animate-pulse"/><div><h2 className="text-3xl font-black">{question.text}</h2><div className="text-sm text-gray-400 mt-1">{question.hint} (é»æ“Šé‡è½)</div></div></div>) : (<h2 className="text-3xl font-black mb-1">{question.text}</h2>)}
                                </div>
                                {inputMode === 'select' ? (<div className="grid grid-cols-2 gap-4 max-w-md mx-auto">{question.options.map(o => (<button key={o} onClick={()=>handleAnswer(o)} className="bg-white/10 p-5 rounded-2xl font-bold text-xl border-2 border-white/5 active:bg-blue-600 transition-colors">{o}</button>))}</div>) : (<div className="flex flex-col gap-4 max-w-md mx-auto"><input value={userAnswer} onChange={e=>setUserAnswer(e.target.value)} onKeyDown={e=>e.key==='Enter' && handleAnswer(userAnswer)} className="w-full bg-black/60 border-2 border-white/20 p-5 text-3xl rounded-2xl text-center outline-none text-white font-bold" placeholder="æ‹¼å‡ºå–®å­—..." autoFocus autoCapitalize="none" autoCorrect="off" spellCheck="false" inputMode="text"/><button onClick={()=>handleAnswer(userAnswer)} className="bg-yellow-400 text-black py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95">æ”»æ“Š (GO!)</button></div>)}
                                {feedback && <div className={`absolute inset-0 flex items-center justify-center bg-black/60 z-50 pointer-events-none rounded-t-[3rem]`}><div className={`text-9xl font-black ${feedback==='correct'?'text-green-500':'text-red-500'} pop-in`}>{feedback==='correct'?'â­•':'âŒ'}</div></div>}
                            </div>
                        </div>
                    )}

                    {screen === 'settings' && (
                        <div className="h-full bg-slate-900 p-6 overflow-y-auto">
                            <div className="flex justify-between mb-6"><h2 className="text-xl font-bold text-yellow-400">ç®¡ç†ä¸­å¿ƒ</h2><button onClick={()=>setScreen('menu')} className="bg-gray-700 px-4 rounded">é€€å‡º</button></div>
                            <div className="bg-white/5 p-4 rounded-xl mb-4">
                                <h3 className="font-bold mb-2">â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                                {userObj ? <button onClick={async ()=>{await window.signOut(window.auth); setUserObj(null);}} className="bg-red-600 px-4 py-2 rounded font-bold w-full">ç™»å‡º: {userObj.email}</button> : <button onClick={handleLogin} className="bg-white text-black px-4 py-2 rounded font-bold w-full">Google ç™»å…¥</button>}
                            </div>
                        </div>
                    )}

                    {screen === 'result' && (
                        <div className="h-full flex flex-col items-center justify-center p-8 bg-slate-900 text-center animate-pop">
                            {playerHp > 0 ? <div className="text-9xl mb-6">ğŸ†</div> : <div className="text-9xl mb-6">ğŸ’€</div>}
                            <h2 className="text-4xl font-black text-yellow-400 mb-4">{playerHp > 0 ? 'å¤§ç²å…¨å‹ï¼' : 'å†æ¥å†å²ï¼'}</h2>
                            <p className="text-gray-400 mb-10">é”æˆç­‰ç´šï¼šLv.{dailyLevel}</p>
                            <button onClick={()=>setScreen('menu')} className="bg-white text-black px-16 py-5 rounded-3xl font-black text-2xl shadow-2xl hover:scale-105 active:scale-95 transition-all">è¿”å›åŸºåœ°</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        // Error Boundary Wrapper
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
