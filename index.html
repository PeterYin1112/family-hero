<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šV20</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCagXSigdL09-OK4G5jF20Hj3iXnRVQs-M",
            authDomain: "family-hero-f89f7.firebaseapp.com",
            projectId: "family-hero-f89f7",
            storageBucket: "family-hero-f89f7.firebasestorage.app",
            messagingSenderId: "900050172486",
            appId: "1:900050172486:web:bdb1904fd5bc7cf9eba847",
            measurementId: "G-G3FBB69BBD"
        };

        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey.includes("AIzaSy")) {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                window.provider = new GoogleAuthProvider();
                window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; 
                window.onSnapshot = onSnapshot; window.updateDoc = updateDoc; window.increment = increment;
                window.signInWithPopup = signInWithPopup; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
                console.log("ğŸ”¥ Firebase Ready");
            }
        } catch (e) { console.warn("Firebase Init Skipped:", e); }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; background-color: #0f172a; color: white; user-select: none; -webkit-tap-highlight-color: transparent; }
        .bg-forest { background: linear-gradient(to bottom, #14532d, #064e3b); }
        .bg-desert { background: linear-gradient(to bottom, #7c2d12, #451a03); }
        .bg-ice-castle { background: linear-gradient(to bottom, #1e3a8a, #082f49); }
        .bg-volcano { background: linear-gradient(to bottom, #7f1d1d, #450a0a); }
        .bg-beetle-forest { background: linear-gradient(to bottom, #064e3b, #022c22); }
        
        .char-container { position: relative; width: 100px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        .char-head { font-size: 3.5rem; z-index: 10; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }
        .char-body { width: 36px; height: 45px; border-radius: 8px; position: relative; z-index: 5; margin-top: -10px; }
        .char-body.princess { background: linear-gradient(180deg, #ec4899, #be185d); }
        .char-body.hero { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
        .char-limb { width: 8px; height: 25px; background: #fda4af; position: absolute; border-radius: 4px; }
        .arm-l { left: -6px; top: 5px; transform: rotate(20deg); }
        .arm-r { right: -6px; top: 5px; transform: rotate(-20deg); }
        .leg-l { left: 6px; bottom: -20px; height: 32px; background: #334155; }
        .leg-r { right: 6px; bottom: -20px; height: 32px; background: #334155; }
        
        .slot-hat { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 20; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .slot-weapon { position: absolute; top: 30px; right: -25px; font-size: 2rem; z-index: 20; transform: rotate(-15deg); filter: drop-shadow(0 0 5px gold); }
        .slot-pet { position: absolute; bottom: 0; left: -40px; font-size: 1.8rem; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-pulse-fast { animation: pulse 1s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(-5px,0); } 75% { transform: translate(5px,0); } 100% { transform: translate(0,0); } }
        .animate-shake { animation: shake 0.3s; }
        .animate-attack { transform: translateX(50px); transition: transform 0.2s; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        input:focus { border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- Error Boundary (å®‰å…¨ç¶²) ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, info) { console.error("Game Error:", error); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex flex-col items-center justify-center bg-red-900 text-white p-8 text-center">
                            <h1 className="text-3xl font-bold mb-4">âš ï¸ éŠæˆ²ç™¼ç”ŸéŒ¯èª¤</h1>
                            <p className="mb-4">å­˜æª”å¯èƒ½è¡çªï¼Œè«‹å˜—è©¦é‡ç½®ã€‚</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-white text-red-900 px-6 py-3 rounded-xl font-bold">é‡ç½®ä¿®å¾©</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Data ---
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'å†°é›ªå¥³ç‹æ¦•', avatar: 'ğŸ‘¸', theme: 'princess', color: 'text-cyan-300', bg: 'bg-ice-castle', attackType: 'ice', needPwd: true }, 
            son: { id: 'son', name: 'ç”²èŸ²ç‹è€…å¸Œ', avatar: 'ğŸ‘¦', theme: 'hero', color: 'text-green-400', bg: 'bg-beetle-forest', attackType: 'beetle', needPwd: true }, 
            mom: { id: 'mom', name: 'ç¥åŠ›å¥³è¶…äºº', avatar: 'ğŸ‘©', theme: 'princess', color: 'text-yellow-400', bg: 'bg-desert', attackType: 'magic', needPwd: true }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', theme: 'hero', color: 'text-blue-400', bg: 'bg-volcano', attackType: 'slash', needPwd: false } 
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "book", type: "noun", mean: "æ›¸" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" },
            { word: "happy", type: "adj", mean: "å¿«æ¨‚" }, { word: "big", type: "adj", mean: "å¤§" }
        ];

        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I see a ___.", hint: "æˆ‘çœ‹è¦‹ä¸€å€‹..." }],
            verb: [{ text: "I can ___.", hint: "æˆ‘æœƒ..." }, { text: "Let's ___.", hint: "æˆ‘å€‘ä¸€èµ·..." }],
            adj: [{ text: "It is ___.", hint: "å®ƒå¾ˆ..." }],
            number: [{ text: "Count to ___.", hint: "æ•¸åˆ°..." }]
        };

        const ITEMS_DB = {
            princess: { math: [{id:'pm1', icon:'ğŸª„', type:'weapon'}, {id:'pm2', icon:'ğŸ‘‘', type:'head'}, {id:'pm3', icon:'ğŸ§šâ€â™€ï¸', type:'pet'}], english: [{id:'pe1', icon:'ğŸŒŸ', type:'weapon'}, {id:'pe2', icon:'ğŸ‘’', type:'head'}, {id:'pe3', icon:'ğŸ¦„', type:'pet'}] },
            hero: { math: [{id:'hm1', icon:'âš”ï¸', type:'weapon'}, {id:'hm2', icon:'â›‘ï¸', type:'head'}, {id:'hm3', icon:'ğŸ²', type:'pet'}], english: [{id:'he1', icon:'ğŸ—¡ï¸', type:'weapon'}, {id:'he2', icon:'ğŸ§¢', type:'head'}, {id:'he3', icon:'ğŸº', type:'pet'}] }
        };

        const MONSTERS = ["ğŸ‘¾","ğŸ‘½","ğŸ¦–","ğŸ¦•","ğŸ™","ğŸ‰","ğŸ‘¹","ğŸ‘º"];
        const PARENT_PASSWORD = "28825252";
        const FAMILY_PASSWORD = "168";

        // Safe Defaults
        const getWeekId = () => { const d = new Date(); const year = d.getFullYear(); const firstJan = new Date(year, 0, 1); const week = Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay() + 1) / 7); return `${year}-W${week}`; };
        const getInitialStat = () => ({ dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, earnedItems: [], monsterBook: [], weeklyHistory: [], lastWeekId: getWeekId(), lastPlayedDate: new Date().toISOString().split('T')[0] });
        // Use a function to ensure deep copy
        const getInitialDb = () => ({ daughter: getInitialStat(), son: getInitialStat(), mom: getInitialStat(), challenger: getInitialStat() });
        const INITIAL_MATH_SETTINGS = { daughter: { slots: [{ range: 10, weight: 1 }] }, son: { weights: { '2-digit-add-sub': 1 } }, challenger: { weights: { '2-digit-add-sub': 1 } } };

        // --- Audio ---
        let audioCtx = null;
        const initAudio = () => { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} } if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, t) => { if(!audioCtx) return; try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1); }catch(e){} };
        const playSFX = (t) => { if(t==='win') playTone(440,'sine'); else playTone(200,'square'); };
        const speakWord = (text) => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); } };

        // --- Components ---
        const LucideIcon = ({ name }) => {
            const [Icon, setIcon] = useState(null);
            useEffect(() => { if(window.lucide && window.lucide.icons) { const n = name.replace(/-([a-z])/g, g=>g[1].toUpperCase()); const N = n.charAt(0).toUpperCase() + n.slice(1); setIcon(window.lucide.icons[N]); } }, [name]);
            return Icon ? <Icon size={20} /> : <span>â€¢</span>;
        };

        const FullBodyChar = ({ charId, items }) => {
            const char = CHARACTERS[charId] || CHARACTERS.daughter;
            const theme = char.theme || 'hero';
            const allItems = [ ...(ITEMS_DB.princess?.math||[]), ...(ITEMS_DB.princess?.english||[]), ...(ITEMS_DB.hero?.math||[]), ...(ITEMS_DB.hero?.english||[]) ];
            const safeItems = Array.isArray(items) ? items : [];
            const hat = allItems.find(i => safeItems.includes(i.id) && i.type === 'head');
            const weapon = allItems.find(i => safeItems.includes(i.id) && i.type === 'weapon');
            const pet = allItems.find(i => safeItems.includes(i.id) && i.type === 'pet');

            return (
                <div className="char-container">
                    {hat && <div className="slot-hat">{hat.icon}</div>}
                    <div className="char-head">{char.avatar}</div>
                    <div className={`char-body ${theme}`}>
                        <div className="char-limb arm-l"></div><div className="char-limb arm-r"></div><div className="char-limb leg-l"></div><div className="char-limb leg-r"></div>
                    </div>
                    {weapon && <div className="slot-weapon">{weapon.icon}</div>}
                    {pet && <div className="slot-pet">{pet.icon}</div>}
                </div>
            );
        };

        const LeaderboardModal = ({ stats, onClose }) => {
            // Safety check for stats
            if (!stats) return null;
            const list = Object.entries(stats).map(([k, v]) => ({ 
                name: CHARACTERS[k]?.name || k, 
                score: v?.dailyScore || 0, 
                lv: Math.max(v?.dailyMathLevel || 0, v?.dailyEnglishLevel || 0) 
            })).sort((a,b)=>b.score-a.score);
            
            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50 animate-pop">
                    <div className="bg-slate-800 w-full max-w-sm rounded-2xl p-4 text-white border-2 border-yellow-400 shadow-2xl">
                        <div className="flex justify-between mb-4 border-b border-gray-600 pb-2">
                            <h2 className="text-xl font-bold text-yellow-400">ğŸ† ä»Šæ—¥è‹±é›„æ¦œ</h2>
                            <button onClick={onClose} className="text-gray-400"><LucideIcon name="x"/></button>
                        </div>
                        {list.map((p,i)=>(
                            <div key={i} className="flex justify-between items-center p-3 mb-2 bg-white/10 rounded-xl">
                                <div className="flex items-center gap-3">
                                    <span className={`font-bold w-6 text-center ${i===0?'text-yellow-400':''}`}>{i+1}</span>
                                    <span>{p.name} <span className="text-xs text-gray-400">Lv.{p.lv}</span></span>
                                </div>
                                <span className="font-mono font-bold text-green-400">{p.score}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const GameManual = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50 animate-pop">
                <div className="bg-slate-800 w-full max-w-md rounded-2xl p-6 text-white border-2 border-blue-400 max-h-[80vh] overflow-y-auto shadow-2xl">
                    <div className="flex justify-between mb-4 border-b border-gray-600 pb-2">
                        <h2 className="text-xl font-bold text-blue-300">ğŸ“– å†’éšªæŒ‡å—</h2>
                        <button onClick={onClose}><LucideIcon name="x"/></button>
                    </div>
                    <ul className="list-disc pl-5 space-y-3 text-sm text-gray-300">
                        <li><strong>é›™è»Œåˆ¶ï¼š</strong>æ•¸å­¸å’Œè‹±æ–‡è¦å¹³è¡¡ç™¼å±•ã€‚å¦‚æœå–®ç§‘ç­‰ç´šå¤ªé«˜ï¼ˆ20, 40...ï¼‰ï¼Œå¿…é ˆæŠŠå¦ä¸€ç§‘ä¹Ÿç·´ä¸Šä¾†æ‰èƒ½è§£é–æ–°é—œå¡ã€‚</li>
                        <li><strong>æ¯é€±é‡ç½®ï¼š</strong>ç‚ºäº†ä¿æŒæŒ‘æˆ°æ€§ï¼Œè£å‚™æ¯é€±ä¸€æœƒæ­¸é›¶ï¼Œé‡æ–°æŒ‘æˆ°æ”¶é›†å…¨å¥—å‚³èªªè£å‚™ï¼</li>
                        <li><strong>BOSSæˆ°ï¼š</strong>æ¯ 10 é—œæœƒå‡ºç¾å·¨å¤§æ€ªç¸ï¼Œæ‰“è´æœ‰æ©Ÿæœƒæ‰è½å¯¶ç®±ã€‚</li>
                        <li><strong>Fever Modeï¼š</strong>é€£çºŒç­”å°æœƒé€²å…¥ç‹‚ç†±æ¨¡å¼ï¼Œåˆ†æ•¸åŠ å€ï¼</li>
                    </ul>
                </div>
            </div>
        );

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [stats, setStats] = useState(getInitialDb());
            const [vocabMap, setVocabMap] = useState({ daughter: BASE_VOCAB, son: BASE_VOCAB, mom: BASE_VOCAB, challenger: BASE_VOCAB });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [audioEnabled, setAudioEnabled] = useState(false);
            const [userObj, setUserObj] = useState(null);

            // Game State
            const [gameMode, setGameMode] = useState('math');
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [question, setQuestion] = useState({ text: "Ready?", answer: "" });
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [showLeaderboard, setShowLeaderboard] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [showModeChoice, setShowModeChoice] = useState(false);
            const [inputMode, setInputMode] = useState('select');
            const [effectType, setEffectType] = useState(null);
            const [animState, setAnimState] = useState('idle');
            const timerRef = useRef(null);

            // --- Init Data ---
            useEffect(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('fh_v20_stable'));
                    if (saved) {
                        // Deep merge stats to prevent missing keys if structure changes
                        const safeStats = getInitialDb();
                        if (saved.stats) {
                            Object.keys(safeStats).forEach(k => {
                                if (saved.stats[k]) safeStats[k] = { ...safeStats[k], ...saved.stats[k] };
                            });
                        }
                        setStats(safeStats);
                        
                        if (saved.vocabMap) setVocabMap(prev => ({ ...prev, ...saved.vocabMap }));
                        if (saved.mathSettings) setMathSettings(saved.mathSettings);
                    }

                    if (window.auth) {
                        window.onAuthStateChanged(window.auth, async (u) => {
                            setUserObj(u);
                            if(u) {
                                try {
                                    const snap = await window.getDoc(window.doc(window.db, "users", u.uid));
                                    if (snap.exists()) {
                                        const d = snap.data();
                                        if (d.stats) setStats(prev => {
                                            const merged = { ...prev };
                                            Object.keys(merged).forEach(k => { if(d.stats[k]) merged[k] = { ...merged[k], ...d.stats[k] }; });
                                            return merged;
                                        });
                                        if (d.vocabMap) setVocabMap(prev => ({ ...prev, ...d.vocabMap }));
                                        if (d.mathSettings) setMathSettings(d.mathSettings);
                                    }
                                } catch(e) {}
                            }
                        });
                    }
                } catch(e) { console.error("Init Error", e); }
            }, []);

            const saveAll = (newStats) => {
                const updated = newStats || stats;
                setStats(updated);
                const data = { stats: updated, vocabMap, mathSettings };
                localStorage.setItem('fh_v20_stable', JSON.stringify(data));
                if(userObj && window.db) { try { window.setDoc(window.doc(window.db, "users", userObj.uid), data); } catch(e){} }
            };

            const toggleAudio = () => { initAudio(); setAudioEnabled(true); playTone(440, 'sine'); };

            const handleStartClick = (mode) => { if (mode === 'daily_english') setShowModeChoice(true); else startGame('math', 'select'); };
            
            const startGame = (mode, iMode) => {
                if (CHARACTERS[playerKey].needPwd && prompt("å®¶äººå¯†ç¢¼ (168)") !== FAMILY_PASSWORD) return alert("å¯†ç¢¼éŒ¯èª¤");
                if(!audioEnabled) toggleAudio();
                
                const pStat = stats[playerKey] || getInitialStat(); // Guard
                const curLv = mode.includes('math') ? pStat.dailyMathLevel : pStat.dailyEnglishLevel;
                // ç°¡å–®çš„é›™è»Œæª¢æŸ¥
                const otherLv = mode.includes('math') ? pStat.dailyEnglishLevel : pStat.dailyMathLevel;
                if (curLv > 0 && curLv % 20 === 0 && otherLv < curLv) { alert(`ğŸš§ è«‹å…ˆå°‡å¦ä¸€ç§‘ç·´åˆ° Lv.${curLv}ï¼`); return; }

                setGameMode(mode);
                setInputMode(iMode || 'select');
                setDailyLevel(curLv + 1);
                nextTurn(mode);
                setScreen('game');
                setShowModeChoice(false);
            };

            const nextTurn = (mode) => {
                setAnimState('idle'); setEffectType(null); setUserAnswer(''); setFeedback(null);
                const n1 = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1;
                const q = mode.includes('math') ? {text:`${n1}+${n2}=?`, answer:(n1+n2).toString()} : {text:"Apple", answer:"apple"};
                
                const currentVocab = vocabMap[playerKey] || BASE_VOCAB;
                if (mode.includes('english') && currentVocab.length > 0) {
                    const w = currentVocab[Math.floor(Math.random()*currentVocab.length)];
                    q.text = w.word.replace(/[a-z]/g, '_'); q.answer = w.word; q.full = w.word;
                    q.options = [w.word, ...currentVocab.filter(v=>v.word!==w.word).sort(()=>0.5-Math.random()).slice(0,3).map(v=>v.word)].sort(()=>0.5-Math.random());
                    setTimeout(()=>speakWord(w.word), 500);
                } else if (mode.includes('english')) {
                    // Fallback if vocab empty
                    q.text = "Cat"; q.answer = "cat"; q.full = "cat"; q.options = ["cat", "dog"];
                }

                setQuestion(q); setTimer(30);
                if(timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000);
            };

            const handleAnswer = (val) => {
                const ans = val || userAnswer;
                const isCorrect = ans.toLowerCase().trim() === question.answer.toLowerCase();
                if(isCorrect) {
                    playSFX('win'); setFeedback('correct');
                    const newStats = JSON.parse(JSON.stringify(stats));
                    if(gameMode.includes('math')) newStats[playerKey].dailyMathLevel = dailyLevel;
                    else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                    newStats[playerKey].dailyScore += 100; 
                    saveAll(newStats);
                    setTimeout(()=>{
                        if(dailyLevel%5===0) setScreen('result'); else { setDailyLevel(l=>l+1); nextTurn(gameMode); }
                    }, 1000);
                } else {
                    playSFX('hit'); setFeedback('wrong');
                }
            };

            const char = CHARACTERS[playerKey] || CHARACTERS.daughter;

            return (
                <div className={`w-full h-screen flex flex-col items-center justify-center relative ${char.bg} transition-colors duration-500`}>
                    {showHelp && <GameManual onClose={()=>setShowHelp(false)} />}
                    {showLeaderboard && <LeaderboardModal stats={stats} onClose={()=>setShowLeaderboard(false)} />}

                    {screen === 'menu' && !audioEnabled && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={toggleAudio}>
                            <div className="text-center animate-pulse text-white">
                                <div className="text-6xl mb-4">ğŸ”Š</div><h2 className="text-3xl font-bold">é»æ“Šå•Ÿå‹•éŠæˆ²</h2>
                            </div>
                        </div>
                    )}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center gap-6 z-10 w-full max-w-md">
                            <h1 className="text-4xl font-black text-yellow-400 drop-shadow-lg">å°å®¶è‹±é›„æ¦œ</h1>
                            <div className="flex gap-2">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={()=>setPlayerKey(c.id)} className={`p-3 rounded-xl border-2 transition-all ${playerKey===c.id?'border-yellow-400 bg-white/20':'border-transparent opacity-50'}`}>
                                        <div className="text-3xl">{c.avatar}</div>
                                    </button>
                                ))}
                            </div>
                            <div className="bg-white/10 p-8 rounded-[3rem] w-full border-2 border-white/20 text-center relative">
                                <div className="scale-125 mb-4"><FullBodyChar charId={playerKey} items={stats[playerKey]?.earnedItems} /></div>
                                <h2 className="text-xl font-bold mb-4">{char.name}</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={()=>handleStartClick('daily_math')} className="bg-orange-600 p-3 rounded-xl font-bold shadow-lg">æ•¸å­¸ Lv.{stats[playerKey]?.dailyMathLevel || 0}</button>
                                    <button onClick={()=>handleStartClick('daily_english')} className="bg-blue-600 p-3 rounded-xl font-bold shadow-lg">è‹±æ–‡ Lv.{stats[playerKey]?.dailyEnglishLevel || 0}</button>
                                </div>
                            </div>
                            
                            {/* Mode Choice Modal */}
                            {showModeChoice && (
                                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50 animate-pop">
                                    <div className="bg-slate-800 w-full max-w-md rounded-3xl p-6 border-2 border-blue-400 text-white">
                                        <h3 className="text-2xl font-bold text-center mb-6 text-blue-300">é¸æ“‡è‹±æ–‡æˆ°é¬¥é¢¨æ ¼</h3>
                                        <div className="space-y-4">
                                            {(stats[playerKey]?.dailyEnglishLevel || 0) < 60 && <button onClick={()=>startGame('daily_english', 'select')} className="w-full bg-white/10 p-4 rounded-2xl border border-white/20 hover:bg-white/20 text-left"><div className="font-bold text-lg text-white">ğŸŸ¢ é¸æ“‡é¡Œæ¨¡å¼ (Easy)</div><div className="text-xs text-gray-400">åˆ©ï¼šé»æ“Šé€Ÿåº¦å¿«ã€‚</div></button>}
                                            <button onClick={()=>startGame('daily_english', 'type')} className="w-full bg-blue-600/50 p-4 rounded-2xl border-2 border-blue-400 text-left"><div className="font-bold text-lg text-yellow-400">ğŸ”¥ æ‹¼å­—é¡Œæ¨¡å¼ (Hard)</div><div className="text-xs text-blue-100">1.5 å€åˆ†æ•¸åŠ æˆï¼</div></button>
                                        </div>
                                        <button onClick={()=>setShowModeChoice(false)} className="mt-6 w-full py-2 text-gray-400">è¿”å›</button>
                                    </div>
                                </div>
                            )}

                            <div className="flex gap-4 text-sm text-gray-400 font-bold">
                                <button onClick={() => setShowLeaderboard(true)} className="bg-white/10 px-3 py-1 rounded-full flex items-center gap-1"><LucideIcon name="trophy"/> æ’è¡Œ</button>
                                <button onClick={() => setShowHelp(true)} className="bg-white/10 px-3 py-1 rounded-full flex items-center gap-1"><LucideIcon name="info"/> èªªæ˜</button>
                                <button onClick={()=>{if(prompt("å¯†ç¢¼")===PARENT_PASSWORD) setScreen('settings')}} className="bg-white/10 px-3 py-1 rounded-full flex items-center gap-1"><LucideIcon name="settings"/> ç®¡ç†</button>
                            </div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full w-full flex flex-col relative z-10 bg-slate-900/80">
                            <div className="p-4 flex justify-between items-center text-white">
                                <div className="text-3xl">{char.avatar}</div>
                                <div className="text-4xl font-mono">{timer}</div>
                                <div className="text-4xl">{MONSTERS[dailyLevel % MONSTERS.length]}</div>
                            </div>
                            <div className="flex-1 flex items-center justify-center">
                                <div className="scale-150"><FullBodyChar charId={playerKey} items={stats[playerKey]?.earnedItems} /></div>
                            </div>
                            <div className="p-6 bg-slate-800 rounded-t-3xl text-center">
                                <h2 className="text-3xl font-black text-white mb-4">{question?.text}</h2>
                                {inputMode === 'select' ? (
                                    <div className="grid grid-cols-2 gap-4">
                                        {question.options?.map(o => (<button key={o} onClick={()=>handleAnswer(o)} className="bg-white/10 p-4 rounded-xl font-bold">{o}</button>))}
                                    </div>
                                ) : (
                                    <div className="flex gap-2">
                                        <input value={userAnswer} onChange={e=>setUserAnswer(e.target.value)} className="flex-1 bg-black/50 p-3 text-2xl text-white rounded-xl text-center" placeholder="ç­”æ¡ˆ" type={gameMode.includes('math')?'tel':'text'} />
                                        <button onClick={()=>handleAnswer()} className="bg-yellow-400 text-black px-6 rounded-xl font-bold">GO</button>
                                    </div>
                                )}
                                {feedback && <div className={`mt-4 text-4xl font-bold ${feedback==='correct'?'text-green-500':'text-red-500'}`}>{feedback==='correct'?'â­•':'âŒ'}</div>}
                            </div>
                        </div>
                    )}

                    {screen === 'settings' && (
                        <div className="h-full bg-slate-900 p-6 z-20 text-white">
                            <h2 className="text-2xl font-bold mb-6">ç®¡ç†ä¸­å¿ƒ</h2>
                            <div className="bg-white/10 p-4 rounded-xl mb-4">
                                <h3 className="font-bold mb-2">â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                                {userObj ? <button onClick={async ()=>{await window.signOut(window.auth); setUserObj(null);}} className="bg-red-600 px-4 py-2 rounded w-full">ç™»å‡º {userObj.email}</button> : <button onClick={handleLogin} className="bg-white text-black px-4 py-2 rounded w-full">Google ç™»å…¥</button>}
                            </div>
                            <button onClick={()=>setScreen('menu')} className="bg-gray-600 px-4 py-2 rounded w-full">è¿”å›</button>
                        </div>
                    )}

                    {screen === 'result' && (
                        <div className="h-full flex flex-col items-center justify-center bg-slate-900 text-white p-8 text-center animate-pop">
                            <div className="text-8xl mb-4">ğŸ†</div>
                            <h2 className="text-4xl font-bold mb-4">é€šéç¬¬ {dailyLevel} é—œ!</h2>
                            <button onClick={()=>setScreen('menu')} className="bg-white text-black px-8 py-3 rounded-xl font-bold">è¿”å›</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
