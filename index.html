<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šçŸ¥è­˜å¤§å†’éšª</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase (ä½¿ç”¨ try-catch åŒ…è¦†ï¼Œç¢ºä¿ä¸å´©æ½°) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- è«‹ç¢ºèªæ‚¨çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCagXSigdL09-OK4G5jF20Hj3iXnRVQs-M",
            authDomain: "family-hero-f89f7.firebaseapp.com",
            projectId: "family-hero-f89f7",
            storageBucket: "family-hero-f89f7.firebasestorage.app",
            messagingSenderId: "900050172486",
            appId: "1:900050172486:web:bdb1904fd5bc7cf9eba847",
            measurementId: "G-G3FBB69BBD"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.provider = new GoogleAuthProvider();
            // æ›è¼‰å…¨åŸŸè®Šæ•¸ä¾› React ä½¿ç”¨
            window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; 
            window.onSnapshot = onSnapshot; window.updateDoc = updateDoc; window.increment = increment;
            window.signInWithPopup = signInWithPopup; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
            console.log("ğŸ”¥ Firebase é€£ç·šæ¨¡çµ„è¼‰å…¥æˆåŠŸ");
        } catch (e) { 
            console.warn("âš ï¸ Firebase é€£ç·šå¤±æ•— (å¯èƒ½æœªè¨­å®šæˆ–ç¶²è·¯å•é¡Œ)ï¼Œå°‡ä½¿ç”¨å–®æ©Ÿæ¨¡å¼ã€‚", e); 
        }
    </script>

    <style>
        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 90% { transform: translate(-5px, 0); } 50% { transform: translate(5px, 0); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes pulse-fast { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-heartbeat { animation: pulse-fast 0.8s infinite; }
        @keyframes attack-rush { 0% { transform: translateX(0); } 50% { transform: translateX(50px) scale(1.2); } 100% { transform: translateX(0); } }
        .animate-attack { animation: attack-rush 0.3s ease-out; }
        @keyframes boss-float { 0%, 100% { transform: translateY(0) scale(1.5); } 50% { transform: translateY(-20px) scale(1.55); } }
        .boss-mode { animation: boss-float 3s ease-in-out infinite; filter: drop-shadow(0 0 20px red); }
        @keyframes fire-border { 0% { box-shadow: inset 0 0 20px red; } 50% { box-shadow: inset 0 0 50px orange; } 100% { box-shadow: inset 0 0 20px red; } }
        .fever-mode { animation: fire-border 1s infinite; border: 2px solid #fbbf24; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop-in { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        body { margin: 0; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; background-color: #1e1b4b; color: white; }
        .bg-forest { background: linear-gradient(to bottom, #14532d, #064e3b); }
        .bg-desert { background: linear-gradient(to bottom, #7c2d12, #451a03); }
        .bg-ice { background: linear-gradient(to bottom, #1e3a8a, #172554); }
        .bg-volcano { background: linear-gradient(to bottom, #7f1d1d, #450a0a); }
        
        /* è§’è‰²æ§‹é€  */
        .char-container { position: relative; width: 100px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        .char-head { font-size: 3.5rem; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .char-body { width: 36px; height: 45px; border-radius: 8px; position: relative; z-index: 5; margin-top: -10px; }
        .char-body.princess { background: linear-gradient(180deg, #ec4899, #be185d); }
        .char-body.hero { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
        .char-limb { width: 8px; height: 25px; background: #fda4af; position: absolute; border-radius: 4px; }
        .arm-l { left: -6px; top: 5px; transform: rotate(20deg); }
        .arm-r { right: -6px; top: 5px; transform: rotate(-20deg); }
        .leg-l { left: 6px; bottom: -20px; height: 30px; background: #374151; }
        .leg-r { right: 6px; bottom: -20px; height: 30px; background: #374151; }
        
        .slot-hat { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 20; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .slot-weapon { position: absolute; top: 30px; right: -25px; font-size: 2rem; z-index: 20; transform: rotate(-15deg); filter: drop-shadow(0 0 5px gold); }
        .slot-pet { position: absolute; bottom: 0; left: -40px; font-size: 1.8rem; animation: pulse-fast 3s infinite; }
    </style>
</head>
<body>
    <div id="root" class="flex h-screen w-full items-center justify-center text-xl font-bold animate-pulse">
        ğŸš€ éŠæˆ²è¼‰å…¥ä¸­... (å¦‚æœå¡ä½è«‹é‡æ–°æ•´ç†)
    </div>

    <!-- éŒ¯èª¤è™•ç†è…³æœ¬ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').innerHTML = `
                <div class="p-8 text-center bg-red-900 text-white">
                    <h1 class="text-2xl font-bold mb-4">âš ï¸ å“å‘€ï¼ç™¼ç”ŸéŒ¯èª¤</h1>
                    <p class="mb-4">å¯èƒ½æ˜¯å­˜æª”è³‡æ–™è¡çªæˆ–ç¨‹å¼éŒ¯èª¤ã€‚</p>
                    <p class="text-xs bg-black p-2 rounded mb-4 text-left font-mono">${message}</p>
                    <button onclick="localStorage.clear(); location.reload();" class="bg-white text-red-900 px-4 py-2 rounded font-bold">
                        é‡ç½®æ‰€æœ‰å­˜æª”ä¸¦ä¿®å¾© (Reset)
                    </button>
                </div>
            `;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- æ ¸å¿ƒè³‡æ–™ ---
        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I can see a ___.", hint: "æˆ‘çœ‹è¦‹ä¸€å€‹..." }, { text: "Do you like the ___?", hint: "ä½ å–œæ­¡é€™å€‹...å—ï¼Ÿ" }, { text: "The ___ is over there.", hint: "é‚£å€‹...åœ¨é‚£é‚Š" }, { text: "I have a ___.", hint: "æˆ‘æœ‰ä¸€å€‹..." }],
            verb: [{ text: "I like to ___.", hint: "æˆ‘å–œæ­¡..." }, { text: "Can you ___?", hint: "ä½ æœƒ...å—ï¼Ÿ" }, { text: "Let's ___ together.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }, { text: "Please ___ now.", hint: "è«‹ç¾åœ¨..." }],
            adj: [{ text: "It looks very ___.", hint: "å®ƒçœ‹èµ·ä¾†å¾ˆ..." }, { text: "The cat is ___.", hint: "é€™éš»è²“å¾ˆ..." }, { text: "I feel ___ today.", hint: "æˆ‘ä»Šå¤©è¦ºå¾—å¾ˆ..." }],
            number: [{ text: "I have ___ apples.", hint: "æˆ‘æœ‰...é¡†è˜‹æœ" }, { text: "Count to ___.", hint: "æ•¸åˆ°..." }]
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "pig", type: "noun", mean: "è±¬" }, { word: "bird", type: "noun", mean: "é³¥" }, { word: "lion", type: "noun", mean: "ç…å­" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "banana", type: "noun", mean: "é¦™è•‰" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶", u: true }, { word: "water", type: "noun", mean: "æ°´", u: true },
            { word: "book", type: "noun", mean: "æ›¸" }, { word: "pen", type: "noun", mean: "ç­†" }, { word: "bus", type: "noun", mean: "å…¬è»Š" }, { word: "car", type: "noun", mean: "è»Šå­" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" }, { word: "swim", type: "verb", mean: "æ¸¸æ³³" }, { word: "eat", type: "verb", mean: "åƒ" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" }, { word: "happy", type: "adj", mean: "å¿«æ¨‚çš„" }, { word: "sad", type: "adj", mean: "é›£éçš„" }, { word: "red", type: "adj", mean: "ç´…è‰²çš„" }, { word: "blue", type: "adj", mean: "è—è‰²çš„" }
        ];

        const NUMBERS_1_10 = [{ word: "one", type: "number", mean: "ä¸€", isFocus: true }, { word: "two", type: "number", mean: "äºŒ", isFocus: true }, { word: "three", type: "number", mean: "ä¸‰", isFocus: true }, { word: "four", type: "number", mean: "å››", isFocus: true }, { word: "five", type: "number", mean: "äº”", isFocus: true }, { word: "six", type: "number", mean: "å…­", isFocus: true }, { word: "seven", type: "number", mean: "ä¸ƒ", isFocus: true }, { word: "eight", type: "number", mean: "å…«", isFocus: true }, { word: "nine", type: "number", mean: "ä¹", isFocus: true }, { word: "ten", type: "number", mean: "å", isFocus: true }];
        const BROTHER_EXTRAS = [{ word: "tired", type: "adj", mean: "ç´¯çš„", isFocus: true }, { word: "angry", type: "adj", mean: "ç”Ÿæ°£çš„", isFocus: true }, { word: "strong", type: "adj", mean: "å¼·å£¯çš„", isFocus: true }, { word: "thin", type: "adj", mean: "ç˜¦çš„", isFocus: true }, { word: "short", type: "adj", mean: "çŸ­/çŸ®çš„", isFocus: true }, { word: "tall", type: "adj", mean: "é«˜çš„", isFocus: true }];

        const ITEMS_DB = {
            princess: {
                math: [{ id: 'pm1', icon: 'ğŸª„', type: 'weapon', effect: 'magic' }, { id: 'pm2', icon: 'ğŸ‘‘', type: 'head' }, { id: 'pm3', icon: 'ğŸ§šâ€â™€ï¸', type: 'pet' }, { id: 'pm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'pm5', icon: 'ğŸ§ª', type: 'skill_heal', name:'è–æ°´' }],
                english: [{ id: 'pe1', icon: 'ğŸŒŸ', type: 'weapon', effect: 'magic' }, { id: 'pe2', icon: 'ğŸ‘’', type: 'head' }, { id: 'pe3', icon: 'ğŸ¦„', type: 'pet' }, { id: 'pe4', icon: 'ğŸ“–', type: 'shield' }, { id: 'pe5', icon: 'â³', type: 'skill_time', name:'æ‡·éŒ¶' }]
            },
            hero: {
                math: [{ id: 'hm1', icon: 'âš”ï¸', type: 'weapon', effect: 'slash' }, { id: 'hm2', icon: 'â›‘ï¸', type: 'head' }, { id: 'hm3', icon: 'ğŸ²', type: 'pet' }, { id: 'hm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'hm5', icon: 'ğŸ–', type: 'skill_heal', name:'çƒ¤è‚‰' }],
                english: [{ id: 'he1', icon: 'ğŸ—¡ï¸', type: 'weapon', effect: 'slash' }, { id: 'he2', icon: 'ğŸ§¢', type: 'head' }, { id: 'he3', icon: 'ğŸº', type: 'pet' }, { id: 'he4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'he5', icon: 'â°', type: 'skill_time', name:'é¬§é˜' }]
            }
        };

        const SCENARIOS = [
            { text: "é­é‡å²èŠå§†ï¼", emoji: "ğŸŸ¢" }, { text: "ç™¼ç¾å¯¶ç®±æ€ªï¼", emoji: "ğŸ“¦" }, { text: "é‡ç‹¼æ“‹è·¯ï¼", emoji: "ğŸº" }, { text: "è™è ä¾†è¥²ï¼", emoji: "ğŸ¦‡" }, { text: "å®ˆè¡›çŸ³åƒï¼", emoji: "ğŸ—¿" }
        ];

        const getWeekId = () => {
            const d = new Date();
            const year = d.getFullYear();
            const firstJan = new Date(year, 0, 1);
            const week = Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay() + 1) / 7);
            return `${year}-W${week}`;
        };

        // å®‰å…¨çš„é è¨­è³‡æ–™ç”¢ç”Ÿå™¨
        const getInitialStats = () => ({ lastPlayedDate: '', lastWeekId: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, earnedItems: [], stickerBook: [] });
        const INITIAL_DB_STRUCTURE = { daughter: getInitialStats(), son: getInitialStats(), mom: getInitialStats(), challenger: getInitialStats() };
        
        const INITIAL_MATH_SETTINGS = { daughter: { slots: [{ range: 10, weight: 5 }, { range: 20, weight: 3 }, { range: 50, weight: 2 }] }, son: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } }, challenger: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } } };
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'è¶…äººåŠ›éœ¸æ¦•', avatar: 'ğŸ¦¸â€â™€ï¸', needPwd: true, theme: 'princess', attackType: 'beam' }, 
            son: { id: 'son', name: 'ç”²èŸ²ç‹è€…å¸Œ', avatar: 'ğŸª²', needPwd: true, theme: 'hero', attackType: 'charge' }, 
            mom: { id: 'mom', name: 'ç¥åŠ›å¥³è¶…äºº', avatar: 'ğŸ‘¸', needPwd: true, theme: 'princess', attackType: 'magic' }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', needPwd: false, theme: 'hero', attackType: 'slash' } 
        };
        const PARENT_PASSWORD = "28825252";
        const FAMILY_PASSWORD = "168";

        // --- éŸ³æ¨‚éŸ³æ•ˆ ---
        let audioCtx = null;
        let musicInterval = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, t, v=0.2, d=0.1) => { if(!audioCtx)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=t; o.frequency.value=f; g.gain.value=v; g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); };
        const stopMusic = () => { if (musicInterval) clearInterval(musicInterval); };
        const playMusic = (style) => {
            stopMusic(); if (!audioCtx) return;
            let scale = [261, 329, 392, 523]; let tempo = 400; let wave = 'sine';
            if (style === 'battle') { scale = [130, 155, 196, 261]; tempo = 200; wave = 'sawtooth'; }
            else if (style === 'tense') { scale = [110, 116, 130]; tempo = 150; wave = 'square'; }
            musicInterval = setInterval(() => { if (Math.random() > 0.4) playTone(scale[Math.floor(Math.random() * scale.length)], tempo / 1000, wave); }, tempo);
        };
        const playSFX = (t) => {
            if (!audioCtx) return;
            if (t==='attack') { playTone(200,'square',0.3); setTimeout(()=>playTone(150,'square',0.3),100); }
            else if (t==='win') { [440,554,659].forEach((f,i)=>setTimeout(()=>playTone(f,'sine',0.2,0.3),i*100)); }
            else if (t==='hurt') { playTone(100,'sawtooth',0.4); setTimeout(()=>playTone(80,'sawtooth',0.4),100); }
            else if (t==='beam') { playTone(800,'sawtooth',0.3,0.5); setTimeout(()=>playTone(600,'sawtooth',0.3,0.5),100); }
            else if (t==='charge') { playTone(100,'square',0.5,0.4); setTimeout(()=>playTone(200,'square',0.5,0.4),200); }
        };
        const speakWord = (text) => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u); } };

        const getInitialVocab = (role) => {
            let list = [...BASE_VOCAB];
            if (role === 'daughter' || role === 'son') list = [...list, ...NUMBERS_1_10];
            if (role === 'son') {
                list = [...list, ...BROTHER_EXTRAS];
                list = list.map(v => (['happy','sad'].includes(v.word) ? { ...v, isFocus: true } : v));
            }
            const unique = []; const map = new Map();
            for (const item of list) { if(!map.has(item.word)){ map.set(item.word, true); unique.push(item); } else if (item.isFocus) { const idx = unique.findIndex(u => u.word === item.word); unique[idx] = item; } }
            return unique;
        };

        const FullBodyChar = ({ charId, items, isAnimating }) => {
            const char = CHARACTERS[charId];
            const theme = char.theme;
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            const myGear = allItems.filter(i => items && items.includes(i.id));
            const hat = myGear.find(i => i.type === 'head');
            const weapon = myGear.find(i => i.type === 'weapon');
            const shield = myGear.find(i => i.type === 'shield');
            const pet = myGear.find(i => i.type === 'pet');

            return (
                <div className={`char-container transition-transform duration-200 ${isAnimating === 'attack' ? 'translate-x-10' : ''} ${isAnimating === 'hurt' ? 'animate-shake' : ''}`}>
                    {hat && <div className="slot-hat">{hat.icon}</div>}
                    <div className="char-head">{char.avatar}</div>
                    <div className={`char-body ${theme}`}>
                        <div className="char-limb arm-l"></div>
                        <div className="char-limb arm-r"></div>
                        <div className="char-limb leg-l"></div>
                        <div className="char-limb leg-r"></div>
                    </div>
                    {weapon && <div className="slot-weapon">{weapon.icon}</div>}
                    {shield && <div className="slot-shield">{shield.icon}</div>}
                    {pet && <div className="slot-pet">{pet.icon}</div>}
                </div>
            );
        };

        const LucideIcon = ({ name }) => {
            const [Icon, setIcon] = useState(null);
            useEffect(() => { if(window.lucide && window.lucide.icons) { const n = name.replace(/-([a-z])/g, g=>g[1].toUpperCase()); const N = n.charAt(0).toUpperCase() + n.slice(1); setIcon(window.lucide.icons[N]); } }, [name]);
            return Icon ? <Icon size={18} /> : <span>âš™ï¸</span>;
        };

        // --- æ’è¡Œæ¦œ ---
        const LeaderboardModal = ({ stats, onClose }) => {
            const [tab, setTab] = useState('daily');
            const getSorted = (type) => {
                const list = Object.entries(stats).map(([key, data]) => ({
                    key,
                    name: CHARACTERS[key].name,
                    avatar: CHARACTERS[key].avatar,
                    score: type === 'daily' ? data.dailyScore : 
                           type === 'all' ? data.allTimeBest.score : 
                           (data.weeklyHistory || []).reduce((acc, cur) => acc + cur.score, 0),
                    extra: type === 'daily' ? `Lv.${Math.max(data.dailyMathLevel, data.dailyEnglishLevel)}` : ''
                }));
                return list.sort((a, b) => b.score - a.score);
            };
            const data = getSorted(tab);
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-pop">
                    <div className="bg-slate-800 w-full max-w-md rounded-2xl border-2 border-yellow-400 flex flex-col overflow-hidden text-white shadow-2xl">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-indigo-900">
                            <h2 className="text-xl font-bold text-yellow-300 flex items-center gap-2">ğŸ† è‹±é›„æ¦œ</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><LucideIcon name="x" /></button>
                        </div>
                        <div className="flex bg-slate-700">
                            <button onClick={()=>setTab('daily')} className={`flex-1 py-3 font-bold ${tab==='daily'?'bg-blue-600 text-white':'text-gray-400'}`}>ä»Šæ—¥æˆ°ç¸¾</button>
                            <button onClick={()=>setTab('week')} className={`flex-1 py-3 font-bold ${tab==='week'?'bg-purple-600 text-white':'text-gray-400'}`}>æœ¬é€±éœ¸ä¸»</button>
                            <button onClick={()=>setTab('all')} className={`flex-1 py-3 font-bold ${tab==='all'?'bg-yellow-600 text-white':'text-gray-400'}`}>æ­·å²å‚³å¥‡</button>
                        </div>
                        <div className="p-4 space-y-3 overflow-y-auto max-h-[60vh]">
                            {data.map((p, i) => (
                                <div key={p.key} className="flex items-center bg-white/10 p-3 rounded-xl border border-white/5">
                                    <div className={`w-8 h-8 flex items-center justify-center rounded-full font-black mr-3 ${i===0?'bg-yellow-400 text-black':(i===1?'bg-gray-400 text-black':(i===2?'bg-orange-700 text-white':'bg-slate-700 text-gray-400'))}`}>{i+1}</div>
                                    <div className="text-2xl mr-3">{p.avatar}</div>
                                    <div className="flex-1"><div className="font-bold text-sm">{p.name}</div>{p.extra && <div className="text-xs text-gray-400">{p.extra}</div>}</div>
                                    <div className="text-xl font-mono font-bold text-yellow-300">{p.score}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const GameManual = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 animate-pop">
                <div className="bg-slate-800 w-full max-w-lg max-h-[85vh] rounded-2xl border-2 border-yellow-400 flex flex-col overflow-hidden text-white shadow-2xl">
                    <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-indigo-900">
                        <h2 className="text-xl font-bold text-yellow-300 flex items-center gap-2"><LucideIcon name="book-open"/> å†’éšªæŒ‡å—</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-white"><LucideIcon name="x" /></button>
                    </div>
                    <div className="p-6 overflow-y-auto space-y-6 text-sm leading-relaxed">
                        <section><h3 className="text-lg font-bold text-blue-300 mb-2">âš”ï¸ é›™è»ŒæŒ‘æˆ°è¦å‰‡</h3><p className="text-gray-300">ç‚ºäº†æˆç‚ºå…¨èƒ½è‹±é›„ï¼Œæ•¸å­¸å’Œè‹±æ–‡å¿…é ˆä¸€èµ·é€²æ­¥ï¼å¦‚æœæ‚¨åœ¨æŸä¸€ç§‘ç·´åˆ°äº† <strong>Lv.20, Lv.40...</strong> ç­‰æ•´æ•¸é—œå¡ï¼Œå¿…é ˆæŠŠå¦ä¸€ç§‘ä¹Ÿç·´ä¸Šä¾†ï¼Œæ‰èƒ½è§£é–ä¸‹ä¸€éšæ®µå–”ï¼</p></section>
                        <section><h3 className="text-lg font-bold text-green-400 mb-2">ğŸ’ è£å‚™èˆ‡é‡ç½®</h3><ul className="list-disc pl-5 space-y-1 text-gray-300"><li><strong>æ‰è½æ©Ÿåˆ¶ï¼š</strong>æ¯é€šé 10 é—œï¼ˆä¾‹å¦‚ Lv.10, 20...ï¼‰ï¼Œæ‰“æ•— BOSS å¾Œæœƒæ‰è½å¯¶ç®±ï¼</li><li><strong>æ¯é€±é‡ç½®ï¼š</strong>ç‚ºäº†ä¿æŒæŒ‘æˆ°æ€§ï¼Œæ¯é€±ä¸€è£å‚™æœƒæ­¸é›¶ã€‚</li><li><strong>æ°¸ä¹…åœ–é‘‘ï¼š</strong>åˆ¥æ“”å¿ƒï¼åªè¦ç²å¾—éçš„å¯¶ç‰©ï¼Œéƒ½æœƒæ°¸ä¹…è¨˜éŒ„åœ¨ã€Œåœ–é‘‘ã€è£¡ã€‚</li></ul></section>
                        <section><h3 className="text-lg font-bold text-yellow-400 mb-2">ğŸ”¥ å¾—åˆ†ç§˜è¨£</h3><p className="text-gray-300"><strong>åŸºç¤åˆ† (100) + é€Ÿåº¦çå‹µ + é€£æ“ŠåŠ æˆ</strong>ã€‚ç­”å¾—è¶Šå¿«åˆ†æ•¸è¶Šé«˜ï¼Œé€£çºŒç­”å°é‚„èƒ½é€²å…¥ Fever æ¨¡å¼åˆ†æ•¸åŠ å€ï¼</p></section>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [momMode, setMomMode] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_DB_STRUCTURE);
            const [vocabMap, setVocabMap] = useState({ daughter: getInitialVocab('daughter'), son: getInitialVocab('son'), mom: getInitialVocab('mom'), challenger: getInitialVocab('challenger') });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [rewards, setRewards] = useState({ levelRewards: {}, dailyScore: Array(5).fill({score:0, reward:""}) });
            const [raidData, setRaidData] = useState({ hp: 10000, maxHp: 10000 });
            const [audioStarted, setAudioStarted] = useState(false);
            
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [inputMode, setInputMode] = useState('select');
            const [scenario, setScenario] = useState(SCENARIOS[0]);
            
            const [animState, setAnimState] = useState('idle');
            const [effectText, setEffectText] = useState(null);
            const [newItem, setNewItem] = useState(null);
            const [userObj, setUserObj] = useState(null);
            const [skillUsed, setSkillUsed] = useState({ heal: false, time: false });
            const [combo, setCombo] = useState(0);
            const [fever, setFever] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [showLeaderboard, setShowLeaderboard] = useState(false);

            const gameRuleKeyRef = useRef('daughter');
            const timerRef = useRef(null);

            // --- å¼·åŒ–çš„è³‡æ–™è¼‰å…¥èˆ‡ä¿®å¾© ---
            useEffect(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('fh_v11_final'));
                    const currentWeek = getWeekId();
                    const today = new Date().toISOString().split('T')[0];
                    
                    let loadedStats = { ...INITIAL_DB_STRUCTURE };
                    
                    if (saved) {
                        // æ·±åº¦åˆä½µï¼Œç¢ºä¿æ–°è§’è‰² key å­˜åœ¨
                        Object.keys(INITIAL_DB_STRUCTURE).forEach(role => {
                            if (saved.stats && saved.stats[role]) {
                                loadedStats[role] = { ...INITIAL_DB_STRUCTURE[role], ...saved.stats[role] };
                            }
                        });
                        if (saved.vocabMap) setVocabMap(saved.vocabMap);
                        if (saved.mathSettings) setMathSettings(saved.mathSettings);
                        if (saved.rewards) setRewards(saved.rewards);
                    }

                    // é‡ç½®é‚è¼¯
                    Object.keys(loadedStats).forEach(k => {
                        if (loadedStats[k].lastWeekId !== currentWeek) { loadedStats[k].earnedItems = []; loadedStats[k].lastWeekId = currentWeek; }
                        if (loadedStats[k].lastPlayedDate !== today) { loadedStats[k].dailyScore = 0; loadedStats[k].lastPlayedDate = today; }
                    });
                    
                    setStats(loadedStats);

                    // Firebase Listener
                    if (window.db) {
                        const unsubRaid = window.onSnapshot(window.doc(window.db, "system", "raidBoss"), (doc) => {
                            if (doc.exists()) setRaidData(doc.data());
                            else window.setDoc(window.doc(window.db, "system", "raidBoss"), { hp: 10000, maxHp: 10000 });
                        });
                        const unsubAuth = window.onAuthStateChanged(window.auth, (u) => {
                            setUserObj(u);
                            if(u && saved) saveToCloud(u, { stats: loadedStats, vocabMap, mathSettings, rewards });
                        });
                        return () => { unsubRaid(); unsubAuth(); };
                    }
                } catch (e) {
                    console.error("Data Load Error, resetting...", e);
                    // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼é˜²æ­¢ç™½ç•«é¢
                    setStats(INITIAL_DB_STRUCTURE);
                }
            }, []);

            useEffect(() => { 
                localStorage.setItem('fh_v11_final', JSON.stringify({ stats, vocabMap, mathSettings, rewards })); 
            }, [stats, vocabMap, mathSettings, rewards]);

            const saveToCloud = async (u, data) => {
                if (!window.db) return;
                try { await window.setDoc(window.doc(window.db, "users", u.uid), data || { stats, vocabMap, mathSettings, rewards }); } catch (e) {}
            };

            const handleRaidDamage = async (dmg) => {
                if (window.db) {
                    await window.updateDoc(window.doc(window.db, "system", "raidBoss"), { hp: window.increment(-dmg) });
                }
            };

            const pickWeighted = (opts) => { let total = opts.reduce((a,c)=>a+c.weight,0); let r = Math.random()*total; for(let o of opts){ if(r<o.weight)return o.item; r-=o.weight; } return opts[0].item; };
            
            const generateMathQuestion = (role) => {
                const sRole = role === 'challenger' ? 'son' : role;
                if (sRole === 'daughter') {
                    const range = pickWeighted(mathSettings.daughter.slots.map(s => ({ item: s.range, weight: s.weight })));
                    const n1 = Math.floor(Math.random()*range)+1; const n2 = Math.floor(Math.random()*range)+1;
                    return Math.random()>0.5 ? {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:30} : {text:`${Math.max(n1,n2)}-${Math.min(n1,n2)}=?`, answer:(Math.max(n1,n2)-Math.min(n1,n2)).toString(), time:30};
                } else {
                    const settings = mathSettings[sRole] || mathSettings.son;
                    const mode = pickWeighted(Object.keys(settings.weights).map(k=>({item:k, weight:settings.weights[k]})));
                    if(mode.includes('mult')) { const n1=Math.floor(Math.random()*9)+1; const n2=Math.floor(Math.random()*9)+1; return {text:`${n1}x${n2}=?`, answer:(n1*n2).toString(), time:60}; }
                    else if(mode.includes('div')) { const n2=Math.floor(Math.random()*8)+2; const ans=Math.floor(Math.random()*9)+1; const r=mode==='div-remain'?Math.floor(Math.random()*(n2-1))+1:0; return {text:`${n2*ans+r}Ã·${n2}=?`, answer:mode==='div-remain'?`${ans}r${r}`:ans.toString(), time:90, isRemain:mode==='div-remain'}; }
                    else { const n1=Math.floor(Math.random()*50)+10; const n2=Math.floor(Math.random()*50)+10; return {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:60}; }
                }
            };

            const generateEnglishQuestion = (role) => {
                const pool = vocabMap[role] || BASE_VOCAB;
                const weightedPool = []; pool.forEach(w => { weightedPool.push(w); if (w.isFocus) { weightedPool.push(w); weightedPool.push(w); } });
                const w = weightedPool[Math.floor(Math.random()*weightedPool.length)];
                const tmpl = SENTENCE_TEMPLATES[w.type] ? SENTENCE_TEMPLATES[w.type][0] : SENTENCE_TEMPLATES.noun[0];
                let txt = tmpl.text.replace('___', '_____');
                if (txt.includes("a _____")) { if (w.u) txt=txt.replace("a _____","some _____"); else if(['a','e','i','o','u'].includes(w.word[0])) txt=txt.replace("a _____","an _____"); }
                const full = tmpl.text.replace('___', w.word);
                const opts = pool.filter(v=>v.word!==w.word).sort(()=>0.5-Math.random()).slice(0,3).map(v=>v.word);
                return { text:txt, fullSentence:full, answer:w.word, options:[w.word,...opts].sort(()=>0.5-Math.random()), time:30, wordObj:w, hint:w.mean };
            };

            const handleStart = (mode) => {
                if (CHARACTERS[playerKey].needPwd) {
                    if (prompt("è«‹è¼¸å…¥å®¶äººå¯†ç¢¼ (168)ï¼š") !== FAMILY_PASSWORD) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
                }
                initAudio();
                const rule = (playerKey==='mom'||playerKey==='challenger') ? momMode : playerKey;
                gameRuleKeyRef.current = rule;
                setGameMode(mode); setPlayerHp(100); setHp(100); setScore(stats[playerKey].dailyScore); setCombo(0); setFever(false); setSkillUsed({heal:false, time:false});
                const myLv = mode.includes('math') ? stats[playerKey].dailyMathLevel : stats[playerKey].dailyEnglishLevel;
                const otherLv = mode.includes('math') ? stats[playerKey].dailyEnglishLevel : stats[playerKey].dailyMathLevel;
                if (myLv > 0 && myLv % 20 === 0 && otherLv < myLv) { alert(`ğŸš§ æ•¸å­¸èˆ‡è‹±æ–‡è¦å¹³è¡¡ç™¼å±•å–”ï¼è«‹å…ˆæŠŠå¦ä¸€ç§‘è¿½åˆ° Lv.${myLv}ï¼`); return; }
                const startLv = Math.floor(myLv / 10) * 10 + 1;
                setDailyLevel(startLv); nextTurn(mode); setScreen('game');
            };

            const nextTurn = (mode) => {
                setAnimState('idle'); setUserAnswer(''); setFeedback(null);
                const lv = dailyLevel;
                const isBoss = lv > 0 && lv % 10 === 0;
                let bgClass = 'bg-forest';
                if(lv > 30) bgClass = 'bg-volcano'; else if(lv > 20) bgClass = 'bg-ice'; else if(lv > 10) bgClass = 'bg-desert';
                document.body.className = bgClass;
                const isListening = lv % 10 === 5 && mode.includes('english');
                const q = mode.includes('math') ? generateMathQuestion(gameRuleKeyRef.current) : generateEnglishQuestion(gameRuleKeyRef.current);
                setQuestion({ ...q, isListening, isBoss });
                setTimer(q.time); setScenario(isBoss ? {text:"BOSSé™è‡¨!", emoji:"ğŸ‘¹"} : SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)]);
                if (mode.includes('english')) setTimeout(()=>speakWord(q.fullSentence), 500);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000);
            };

            const checkItemDrop = () => {
                if (dailyLevel > 0 && dailyLevel % 10 === 0) {
                    const theme = CHARACTERS[playerKey].theme;
                    const type = gameMode.includes('math') ? 'math' : 'english';
                    const pool = ITEMS_DB[theme][type];
                    const earned = stats[playerKey].earnedItems || [];
                    const avail = pool.filter(i => !earned.includes(i.id));
                    if (avail.length > 0) {
                        const drop = avail[Math.floor(Math.random()*avail.length)];
                        const newStats = {...stats}; 
                        if (!newStats[playerKey].earnedItems) newStats[playerKey].earnedItems = [];
                        newStats[playerKey].earnedItems.push(drop.id);
                        if (!newStats[playerKey].stickerBook) newStats[playerKey].stickerBook = [];
                        if (!newStats[playerKey].stickerBook.includes(drop.id)) newStats[playerKey].stickerBook.push(drop.id);
                        setStats(newStats); if (userObj) saveToCloud(userObj, { stats: newStats, vocabMap, mathSettings, rewards });
                        setNewItem(drop); playSFX('item'); setTimeout(() => setNewItem(null), 3000);
                    }
                }
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const isCorrect = val.toString().toLowerCase().trim() === question.answer.toString().toLowerCase();
                
                if (isCorrect) {
                    const newCombo = combo + 1; setCombo(newCombo); setFever(newCombo >= 3);
                    const dmg = fever ? 200 : 100; handleRaidDamage(dmg);
                    setAnimState('attack'); playSFX(CHARACTERS[playerKey].attackType); 
                    
                    const basePoints = 100;
                    const speedBonus = timer * 5;
                    const feverMult = fever ? 1.5 : 1;
                    const pts = Math.round((basePoints + speedBonus) * feverMult);
                    
                    setScore(s => s + pts);
                    setFeedback('correct'); setEffectText(fever ? "ğŸ”¥ FEVER!" : "NICE!");
                    if(question.wordObj) speakWord(question.fullSentence);
                } else {
                    setCombo(0); setFever(false); setAnimState('hurt'); playSFX('hurt'); setFeedback('wrong'); setEffectText("OUCH!");
                    setPlayerHp(h=>h-(gameMode.startsWith('daily')?34:20));
                }

                setTimeout(() => {
                    if (playerHp <= (isCorrect?0:34)) setScreen('result');
                    else if (isCorrect) {
                        if (dailyLevel % 10 === 0) { 
                            checkItemDrop(); setAnimState('victory'); playSFX('win');
                            const newStats = {...stats};
                            if (gameMode.includes('math')) newStats[playerKey].dailyMathLevel = dailyLevel;
                            else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                            newStats[playerKey].dailyScore = score;
                            if (score > newStats[playerKey].allTimeBest.score) {
                                newStats[playerKey].allTimeBest = { score, date: new Date().toISOString().split('T')[0] };
                            }
                            saveAll(newStats); 
                            setTimeout(()=>setScreen('result'), 2000);
                        } else { setDailyLevel(l=>l+1); nextTurn(gameMode); }
                    } else nextTurn(gameMode);
                }, 1500);
            };

            const useSkill = (type) => {
                if (type === 'heal' && !skillUsed.heal) { setPlayerHp(h => Math.min(100, h + 30)); setSkillUsed({...skillUsed, heal:true}); playSFX('item'); } 
                else if (type === 'time' && !skillUsed.time) { clearInterval(timerRef.current); setSkillUsed({...skillUsed, time:true}); playSFX('item'); setTimeout(() => { timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000); }, 5000); }
            };

            const myItems = stats[playerKey].earnedItems || [];
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            const hasHeal = allItems.some(i => myItems.includes(i.id) && i.type === 'skill_heal');
            const hasTime = allItems.some(i => myItems.includes(i.id) && i.type === 'skill_time');

            const StickerBook = () => (
                <div className="h-full bg-slate-900 p-6 overflow-y-auto">
                    <div className="flex justify-between mb-4 text-white"><h2 className="text-2xl font-bold">ğŸ“š æ°¸ä¹…åœ–é‘‘</h2><button onClick={()=>setScreen('menu')} className="bg-gray-700 px-4 rounded">è¿”å›</button></div>
                    <div className="grid grid-cols-4 gap-4">
                        {allItems.map(item => {
                            const owned = stats[playerKey].stickerBook && stats[playerKey].stickerBook.includes(item.id);
                            return ( <div key={item.id} className={`p-2 rounded-xl text-center border-2 ${owned ? 'bg-white/20 border-yellow-400' : 'bg-black/40 border-gray-700 opacity-50 grayscale'}`}><div className="text-4xl mb-1">{item.icon}</div><div className="text-xs text-white">{owned ? item.name : '???'}</div></div> );
                        })}
                    </div>
                </div>
            );

            const SettingsScreen = () => {
                const [settingTab, setSettingTab] = useState('vocab');
                const [settingChar, setSettingChar] = useState('daughter');
                return (
                    <div className="h-full bg-slate-900 p-6 overflow-y-auto z-20 text-white">
                        <div className="flex justify-between mb-6"><h2 className="text-xl font-bold text-yellow-400">ç®¡ç†ä¸­å¿ƒ</h2><button onClick={()=>setScreen('menu')} className="bg-gray-700 px-4 rounded">é€€å‡º</button></div>
                        <div className="bg-white/5 p-4 rounded-xl mb-4">
                            <h3 className="font-bold mb-2">â˜ï¸ é›²ç«¯åŒæ­¥</h3>
                            {userObj ? <button onClick={async ()=>{await window.signOut(window.auth); setUserObj(null);}} className="bg-red-600 px-4 py-2 rounded font-bold w-full">ç™»å‡º: {userObj.email}</button> : <button onClick={handleLogin} className="bg-white text-black px-4 py-2 rounded font-bold w-full">Google ç™»å…¥</button>}
                        </div>
                        <div className="flex gap-2 mb-4 bg-black/20 p-1 rounded-lg overflow-x-auto scrollbar-hide">{Object.values(CHARACTERS).filter(c=>c.id!=='mom').map(c => (<button key={c.id} onClick={()=>setSettingChar(c.id)} className={`flex-1 py-2 px-3 whitespace-nowrap rounded font-bold ${settingChar===c.id ? 'bg-indigo-600 text-white':'text-gray-400'}`}>{c.name}</button>))}</div>
                        <div className="flex gap-2 mb-4"><button onClick={()=>setSettingTab('vocab')} className={`flex-1 py-2 rounded border border-white/10 ${settingTab==='vocab'?'bg-blue-600':'bg-white/5'}`}>ğŸ“š å–®å­—è¨­å®š (â­é‡é»)</button><button onClick={()=>setSettingTab('math')} className={`flex-1 py-2 rounded border border-white/10 ${settingTab==='math'?'bg-orange-600':'bg-white/5'}`}>ğŸ”¢ æ•¸å­¸é›£åº¦</button></div>
                        {settingTab === 'vocab' && <VocabSettings charKey={settingChar} />}
                        {settingTab === 'math' && <MathSettings charKey={settingChar} />}
                    </div>
                );
            };

            const VocabSettings = ({ charKey }) => {
                const [input, setInput] = useState({ word: '', mean: '', type: 'noun' });
                const list = vocabMap[charKey] || [];
                const add = () => { if(!input.word) return; const newItem = { ...input, isFocus: false }; const newList = [...list, newItem]; setVocabMap({ ...vocabMap, [charKey]: newList }); saveAll(null, { ...vocabMap, [charKey]: newList }); setInput({ word: '', mean: '', type: 'noun' }); };
                const remove = (idx) => { const newList = [...list]; newList.splice(idx, 1); setVocabMap({ ...vocabMap, [charKey]: newList }); saveAll(null, { ...vocabMap, [charKey]: newList }); };
                const toggleFocus = (idx) => { const newList = [...list]; newList[idx] = { ...newList[idx], isFocus: !newList[idx].isFocus }; setVocabMap({ ...vocabMap, [charKey]: newList }); saveAll(null, { ...vocabMap, [charKey]: newList }); };
                return (
                    <div className="bg-white/5 p-4 rounded-xl mt-4">
                        <div className="flex gap-2 mb-2">
                            <input value={input.word} onChange={e=>setInput({...input, word:e.target.value})} placeholder="è‹±æ–‡" className="w-1/3 bg-black/40 p-2 rounded text-sm"/>
                            <input value={input.mean} onChange={e=>setInput({...input, mean:e.target.value})} placeholder="ä¸­æ–‡" className="w-1/3 bg-black/40 p-2 rounded text-sm"/>
                            <select value={input.type} onChange={e=>setInput({...input, type:e.target.value})} className="bg-black/40 p-2 rounded text-sm"><option value="noun">åè©</option><option value="verb">å‹•è©</option><option value="adj">å½¢å®¹è©</option><option value="number">æ•¸å­—</option></select>
                            <button onClick={add} className="bg-green-600 px-3 rounded"><LucideIcon name="plus" size={16}/></button>
                        </div>
                        <div className="max-h-60 overflow-y-auto space-y-2">
                            {list.map((v, i) => (
                                <div key={i} className={`flex justify-between items-center p-2 rounded ${v.isFocus ? 'bg-yellow-500/20 border border-yellow-500/50' : 'bg-black/30'}`}>
                                    <div className="flex items-center gap-2"><button onClick={()=>toggleFocus(i)} className={`text-xl ${v.isFocus ? 'opacity-100' : 'opacity-30 grayscale'}`}>â­</button><span className="font-bold text-blue-300">{v.word}</span><span className="text-xs text-gray-400">{v.mean}</span></div>
                                    <button onClick={()=>remove(i)} className="text-gray-500 hover:text-red-500"><LucideIcon name="trash-2" size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const MathSettings = ({ charKey }) => {
                const isDaughter = charKey === 'daughter';
                const settings = mathSettings[charKey] || (isDaughter ? INITIAL_MATH_SETTINGS.daughter : INITIAL_MATH_SETTINGS.son);
                const updateSlot = (idx, field, val) => { const newS = { ...mathSettings }; newS.daughter.slots[idx][field] = parseInt(val) || 0; setMathSettings(newS); saveAll(null, null, newS); };
                const updateWeight = (key, val) => { const newS = { ...mathSettings }; if (!newS[charKey]) newS[charKey] = { weights: { ...INITIAL_MATH_SETTINGS.son.weights } }; newS[charKey].weights[key] = parseInt(val) || 0; setMathSettings(newS); saveAll(null, null, newS); };
                if (isDaughter) {
                    return (<div className="bg-white/5 p-4 rounded-xl mt-4 space-y-2">{settings.slots.map((s, i) => (<div key={i} className="flex items-center gap-2 bg-black/20 p-2 rounded"><span className="text-gray-400 font-bold">#{i+1}</span><input type="number" value={s.range} onChange={e=>updateSlot(i,'range',e.target.value)} className="w-16 bg-black/40 text-center rounded p-1"/><span className="text-xs">ä»¥å…§</span><input type="range" max="10" value={s.weight} onChange={e=>updateSlot(i,'weight',e.target.value)} className="flex-1"/><span className="w-4 text-center text-pink-400 font-bold">{s.weight}</span></div>))}</div>);
                } else {
                    const weights = settings.weights || INITIAL_MATH_SETTINGS.son.weights;
                    const labels = { '2-digit-add-sub': '2ä½æ•¸åŠ æ¸›', '3-digit-add-sub': '3ä½æ•¸åŠ æ¸›', '1-digit-mult': '2ä½x1ä½ä¹˜', '2-digit-mult': '2ä½x2ä½ä¹˜', 'div-exact': 'æ•´é™¤', 'div-remain': 'é¤˜æ•¸' };
                    return (<div className="bg-white/5 p-4 rounded-xl mt-4 grid grid-cols-1 gap-2">{Object.keys(weights).map(k => (<div key={k} className="flex items-center justify-between bg-black/20 p-2 rounded"><span className="text-xs text-gray-300">{labels[k]}</span><div className="flex items-center gap-2 w-32"><input type="range" max="10" value={weights[k]} onChange={e=>updateWeight(k,e.target.value)} className="flex-1"/><span className="w-4 text-center text-blue-400 font-bold">{weights[k]}</span></div></div>))}</div>);
                }
            };

            return (
                <div className={`w-full h-screen flex flex-col overflow-hidden relative transition-all duration-1000 ${fever ? 'fever-mode' : ''}`}>
                    {showHelp && <GameManual onClose={()=>setShowHelp(false)} />}
                    {showLeaderboard && <LeaderboardModal stats={stats} onClose={()=>setShowLeaderboard(false)} />}
                    {newItem && (<div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 animate-pop"><div className="bg-gradient-to-b from-yellow-400 to-orange-500 p-8 rounded-3xl text-center border-4 border-white shadow-2xl"><h3 className="text-2xl font-black text-white mb-4">ğŸ‰ ç²å¾—å¯¶ç‰©ï¼</h3><div className="text-8xl mb-4 animate-bounce">{newItem.icon}</div><div className="text-3xl font-bold text-black">{newItem.name}</div><div className="text-sm text-white mt-2 font-bold opacity-80">å·²åŠ å…¥åœ–é‘‘</div></div></div>)}

                    {screen === 'menu' && !audioStarted && (<div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={()=>{initAudio(); setAudioStarted(true); playMusic('menu');}}><div className="text-center animate-pulse"><div className="text-6xl mb-4">ğŸµ</div><h2 className="text-2xl font-bold text-white">é»æ“Šç•«é¢é–‹å§‹éŠæˆ²</h2><p className="text-gray-400 text-sm mt-2">é–‹å•ŸéŸ³æ•ˆèˆ‡èƒŒæ™¯éŸ³æ¨‚</p></div></div>)}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center justify-center h-full relative z-10 bg-indigo-900 text-white">
                            <h1 className="text-4xl font-black text-yellow-400 mb-6 drop-shadow-lg">âš”ï¸ å°å®¶è‹±é›„æ¦œ</h1>
                            
                            <div className="w-full max-w-lg bg-red-900/80 p-2 rounded-xl mb-4 border-2 border-red-500 flex items-center gap-3">
                                <div className="text-3xl animate-bounce">ğŸ²</div>
                                <div className="flex-1">
                                    <div className="text-xs text-red-200 font-bold uppercase flex justify-between"><span>ä¸–ç•Œæƒ¡é¾è¨ä¼</span><span>{Math.max(0, raidData.hp)}/{raidData.maxHp}</span></div>
                                    <div className="h-2 w-full bg-black rounded-full overflow-hidden mt-1"><div className="h-full bg-red-500 transition-all duration-500" style={{width: `${(raidData.hp/raidData.maxHp)*100}%`}}></div></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-4 gap-2 mb-4 bg-black/20 p-2 rounded-xl w-full max-w-lg">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={() => setPlayerKey(c.id)} className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all ${playerKey === c.id ? 'bg-yellow-500 text-black scale-105 shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}>
                                        <span className="text-2xl mb-1">{c.avatar}</span><span className="text-xs font-bold">{c.name}</span>{c.subName && <span className="text-[9px] block text-green-300">{c.subName}</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-white/10 p-6 rounded-[2.5rem] border-4 border-white/20 flex flex-col items-center backdrop-blur-sm w-full max-w-sm mb-6 relative">
                                <div className="relative mb-6 scale-110">
                                    <FullBodyChar charId={playerKey} items={stats[playerKey].earnedItems} isAnimating="idle" />
                                </div>
                                {(playerKey === 'mom' || playerKey === 'challenger') && (
                                    <div className="flex bg-black/30 rounded-full p-1 mb-4 w-full text-sm font-bold">
                                        <button onClick={()=>setMomMode('daughter')} className={`flex-1 py-1 rounded-full ${momMode==='daughter'?'bg-pink-600':'text-gray-400'}`}>æ¸¬å¦¹å¦¹</button>
                                        <button onClick={()=>setMomMode('son')} className={`flex-1 py-1 rounded-full ${momMode==='son'?'bg-blue-600':'text-gray-400'}`}>æ¸¬å“¥å“¥</button>
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-3 w-full">
                                    <button onClick={()=>handleStart('daily_math')} className="bg-orange-500 p-4 rounded-xl font-bold flex flex-col items-center shadow-lg active:scale-95"><div className="text-2xl mb-1">ğŸ§®</div>æŒ‘æˆ°æ•¸å­¸<div className="text-xs opacity-70 bg-black/20 px-2 rounded mt-1">Lv.{stats[playerKey].dailyMathLevel}</div></button>
                                    <button onClick={()=>handleStart('daily_english')} className="bg-blue-500 p-4 rounded-xl font-bold flex flex-col items-center shadow-lg active:scale-95"><div className="text-2xl mb-1">ğŸ—£ï¸</div>æŒ‘æˆ°è‹±æ–‡<div className="text-xs opacity-70 bg-black/20 px-2 rounded mt-1">Lv.{stats[playerKey].dailyEnglishLevel}</div></button>
                                </div>
                            </div>
                            <div className="flex gap-4 text-sm text-gray-400">
                                <button onClick={() => setScreen('sticker')} className="bg-white/5 px-3 py-1 rounded flex items-center gap-1"><LucideIcon name="book-open" size={14}/> åœ–é‘‘</button>
                                <button onClick={() => setShowLeaderboard(true)} className="bg-white/5 px-3 py-1 rounded flex items-center gap-1"><LucideIcon name="trophy" size={14}/> æ’è¡Œ</button>
                                <button onClick={() => setShowHelp(true)} className="bg-white/5 px-3 py-1 rounded flex items-center gap-1"><LucideIcon name="info" size={14}/> èªªæ˜</button>
                                <button onClick={enterSettings} className="bg-white/5 px-3 py-1 rounded flex items-center gap-1"><LucideIcon name="settings" size={14}/> ç®¡ç†</button>
                            </div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full flex flex-col bg-slate-900/50 text-white relative z-10">
                            <div className="p-3 flex justify-between items-center bg-black/30 backdrop-blur">
                                <div className="flex items-center gap-2"><div className="text-2xl">{CHARACTERS[playerKey].avatar}</div><div className="w-24 h-3 bg-gray-700 rounded-full overflow-hidden"><div className="h-full bg-green-500 transition-all" style={{width:`${playerHp}%`}}/></div></div>
                                <div className={`text-center ${fever ? 'scale-110 text-yellow-300' : ''}`}><div className="text-xs font-bold">LV.{dailyLevel} {fever && 'ğŸ”¥FEVER!'}</div><div className="text-3xl font-mono font-bold">{timer}</div></div>
                                <div className={`text-2xl ${question.isBoss ? 'boss-mode' : ''}`}>{scenario.emoji}</div>
                            </div>
                            <div className="flex-1 flex flex-col items-center justify-center p-4 relative overflow-hidden">
                                <div className="absolute inset-0 flex justify-between items-center px-4 pointer-events-none opacity-80"><div className={`text-9xl transition-transform duration-300 ${animState==='attack'?'translate-x-20':''} ${animState==='hurt'?'animate-shake':''}`}><FullBodyChar charId={playerKey} items={stats[playerKey].earnedItems} /></div><div className={`text-9xl transition-transform duration-300 ${animState==='attack'?'animate-shake':''} ${animState==='hurt'?'-translate-x-20':''}`}>{scenario.emoji}</div></div>
                                {effectText && <div className="absolute top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black text-yellow-300 drop-shadow-lg animate-float-up z-20">{effectText}</div>}
                                <div className="absolute bottom-4 left-4 flex gap-2 z-20">
                                    {hasHeal && <button onClick={()=>useSkill('heal')} disabled={skillUsed.heal} className={`p-3 rounded-full text-2xl shadow-lg border-2 border-white ${skillUsed.heal ? 'bg-gray-500 opacity-50' : 'bg-green-500 animate-bounce'}`}>ğŸ§ª</button>}
                                    {hasTime && <button onClick={()=>useSkill('time')} disabled={skillUsed.time} className={`p-3 rounded-full text-2xl shadow-lg border-2 border-white ${skillUsed.time ? 'bg-gray-500 opacity-50' : 'bg-blue-500 animate-bounce'}`}>â³</button>}
                                </div>
                                <div className={`bg-white/10 backdrop-blur-md p-6 rounded-3xl w-full max-w-md text-center border border-white/20 shadow-2xl relative z-10 transition-transform ${feedback?'scale-105':''}`}>
                                    {feedback && <div className={`absolute inset-0 flex items-center justify-center text-8xl font-bold bg-black/60 rounded-3xl z-20 ${feedback==='correct'?'text-green-500':'text-red-500'}`}>{feedback==='correct'?'â­•':'âŒ'}</div>}
                                    <div className="mb-4">
                                        <span className="text-blue-300 text-xs font-bold uppercase bg-black/40 px-2 py-1 rounded">{gameMode.includes('math')?'MATH':`ENGLISH`}</span>
                                        {question.isListening ? (<div className="mt-4 text-4xl font-bold animate-pulse text-yellow-300 cursor-pointer" onClick={()=>speakWord(question.fullSentence)}>ğŸ”Š é»æ“Šè½é¡Œç›®</div>) : (<h2 className="text-4xl font-black mt-2 leading-tight">{gameMode.includes('math')?question.text:question.display}</h2>)}
                                    </div>
                                    {gameMode.includes('english') && inputMode === 'select' ? (<div className="grid grid-cols-2 gap-3">{question.options.map(opt=><button key={opt} onClick={()=>handleAnswer(opt)} className="bg-white/10 p-4 rounded-xl font-bold text-xl border border-white/10 active:bg-indigo-600 transition-colors">{opt}</button>)}</div>) : (<div className="flex gap-2"><input value={userAnswer} onChange={e=>setUserAnswer(e.target.value)} className="flex-1 bg-black/50 border-2 border-white/20 rounded-xl p-3 text-2xl text-center outline-none focus:border-yellow-400 text-white" placeholder="è¼¸å…¥..." type={gameMode.includes('math')?'tel':'text'}/><button onClick={()=>handleAnswer(userAnswer)} className="bg-yellow-500 text-black px-6 rounded-xl font-black text-xl shadow-lg active:scale-95">GO</button></div>)}
                                    {gameMode.includes('english') && <div className="mt-4 flex justify-center gap-2"><button onClick={()=>setInputMode('select')} className={`px-3 py-1 rounded-full text-xs font-bold ${inputMode==='select'?'bg-blue-600':'bg-white/10'}`}>é¸æ“‡é¡Œ</button><button onClick={()=>setInputMode('type')} className={`px-3 py-1 rounded-full text-xs font-bold ${inputMode==='type'?'bg-purple-600':'bg-white/10'}`}>æ‹¼å­—é¡Œ</button></div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'sticker' && <StickerBook />}
                    {screen === 'result' && <div className="h-full flex flex-col items-center justify-center p-8 text-center bg-indigo-900 text-white"><div className="text-6xl mb-4">{dailyLevel%10===0?'ğŸ†':'ğŸ’€'}</div><h2 className="text-3xl font-bold mb-4">{dailyLevel%10===0?'æŒ‘æˆ°æˆåŠŸï¼':'å†æ¥å†å²'}</h2><div className="text-xl text-yellow-300 mb-4">æœ¬æ¬¡å¾—åˆ†: {score}</div><button onClick={()=>setScreen('menu')} className="bg-white text-black px-8 py-3 rounded-xl font-bold">è¿”å›</button></div>}
                    {screen === 'vocab' && <div className="h-full p-4 overflow-y-auto bg-indigo-900 text-white"><button onClick={()=>setScreen('menu')} className="mb-4 bg-gray-700 px-3 py-1 rounded">è¿”å›</button><div className="grid grid-cols-2 gap-2">{(vocabMap[playerKey]||BASE_VOCAB).map((v,i)=><div key={i} onClick={()=>speakWord(v.word)} className="bg-white/10 p-2 rounded border border-white/5">{v.word} <span className="text-xs text-gray-400">{v.mean}</span></div>)}</div></div>}
                    {screen === 'settings' && <SettingsScreen />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
