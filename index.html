<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šçµ‚æ¥µé€²åŒ–</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- è«‹ç¢ºèªæ‚¨çš„ Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCagXSigdL09-OK4G5jF20Hj3iXnRVQs-M",
            authDomain: "family-hero-f89f7.firebaseapp.com",
            projectId: "family-hero-f89f7",
            storageBucket: "family-hero-f89f7.firebasestorage.app",
            messagingSenderId: "900050172486",
            appId: "1:900050172486:web:bdb1904fd5bc7cf9eba847",
            measurementId: "G-G3FBB69BBD"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.provider = new GoogleAuthProvider();
            window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.onSnapshot = onSnapshot; window.updateDoc = updateDoc; window.increment = increment;
            window.signInWithPopup = signInWithPopup; window.signOut = signOut; window.onAuthStateChanged = onAuthStateChanged;
            console.log("ğŸ”¥ Firebase Ready");
        } catch (e) { console.error("Firebase init error", e); }
    </script>

    <style>
        /* å‹•ç•«å®šç¾© */
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 90% { transform: translate(-5px, 0); } 50% { transform: translate(5px, 0); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes pulse-fast { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-heartbeat { animation: pulse-fast 0.8s infinite; }
        @keyframes attack-rush { 0% { transform: translateX(0); } 50% { transform: translateX(50px) scale(1.2); } 100% { transform: translateX(0); } }
        .animate-attack { animation: attack-rush 0.3s ease-out; }
        @keyframes boss-float { 0%, 100% { transform: translateY(0) scale(1.5); } 50% { transform: translateY(-20px) scale(1.55); } }
        .boss-mode { animation: boss-float 3s ease-in-out infinite; filter: drop-shadow(0 0 20px red); }
        @keyframes fire-border { 0% { box-shadow: inset 0 0 20px red; } 50% { box-shadow: inset 0 0 50px orange; } 100% { box-shadow: inset 0 0 20px red; } }
        .fever-mode { animation: fire-border 1s infinite; border: 2px solid #fbbf24; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop-in { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        body { margin: 0; overflow: hidden; font-family: "Segoe UI", system-ui, sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* ç”Ÿæ…‹ç³»èƒŒæ™¯ */
        .bg-forest { background: linear-gradient(to bottom, #14532d, #166534); }
        .bg-desert { background: linear-gradient(to bottom, #7c2d12, #b45309); }
        .bg-ice { background: linear-gradient(to bottom, #1e3a8a, #0ea5e9); }
        .bg-volcano { background: linear-gradient(to bottom, #450a0a, #7f1d1d); }
        
        /* è§’è‰²æ§‹é€  */
        .char-container { position: relative; width: 100px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        .char-head { font-size: 3.5rem; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .char-body { width: 36px; height: 45px; border-radius: 8px; position: relative; z-index: 5; margin-top: -10px; }
        .char-body.princess { background: linear-gradient(180deg, #ec4899, #be185d); }
        .char-body.hero { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
        .char-limb { width: 8px; height: 25px; background: #fda4af; position: absolute; border-radius: 4px; }
        .arm-l { left: -6px; top: 5px; transform: rotate(20deg); }
        .arm-r { right: -6px; top: 5px; transform: rotate(-20deg); }
        .leg-l { left: 6px; bottom: -20px; height: 30px; background: #374151; }
        .leg-r { right: 6px; bottom: -20px; height: 30px; background: #374151; }
        
        /* è£å‚™æ›é» */
        .slot-hat { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 20; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .slot-weapon { position: absolute; top: 30px; right: -25px; font-size: 2rem; z-index: 20; transform: rotate(-15deg); filter: drop-shadow(0 0 5px gold); }
        .slot-pet { position: absolute; bottom: 0; left: -40px; font-size: 1.8rem; animation: float 3s infinite; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- æ ¸å¿ƒè³‡æ–™ ---
        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I can see a ___.", hint: "æˆ‘çœ‹è¦‹ä¸€å€‹..." }, { text: "Do you like the ___?", hint: "ä½ å–œæ­¡é€™å€‹...å—ï¼Ÿ" }, { text: "The ___ is over there.", hint: "é‚£å€‹...åœ¨é‚£é‚Š" }, { text: "I have a ___.", hint: "æˆ‘æœ‰ä¸€å€‹..." }],
            verb: [{ text: "I like to ___.", hint: "æˆ‘å–œæ­¡..." }, { text: "Can you ___?", hint: "ä½ æœƒ...å—ï¼Ÿ" }, { text: "Let's ___ together.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }, { text: "Please ___ now.", hint: "è«‹ç¾åœ¨..." }],
            adj: [{ text: "It looks very ___.", hint: "å®ƒçœ‹èµ·ä¾†å¾ˆ..." }, { text: "The cat is ___.", hint: "é€™éš»è²“å¾ˆ..." }, { text: "I feel ___ today.", hint: "æˆ‘ä»Šå¤©è¦ºå¾—å¾ˆ..." }],
            number: [{ text: "I have ___ apples.", hint: "æˆ‘æœ‰...é¡†è˜‹æœ" }, { text: "Count to ___.", hint: "æ•¸åˆ°..." }]
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "pig", type: "noun", mean: "è±¬" }, { word: "bird", type: "noun", mean: "é³¥" }, { word: "lion", type: "noun", mean: "ç…å­" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "banana", type: "noun", mean: "é¦™è•‰" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶", u: true }, { word: "water", type: "noun", mean: "æ°´", u: true },
            { word: "book", type: "noun", mean: "æ›¸" }, { word: "pen", type: "noun", mean: "ç­†" }, { word: "bus", type: "noun", mean: "å…¬è»Š" }, { word: "car", type: "noun", mean: "è»Šå­" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" }, { word: "swim", type: "verb", mean: "æ¸¸æ³³" }, { word: "eat", type: "verb", mean: "åƒ" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" }, { word: "happy", type: "adj", mean: "å¿«æ¨‚çš„" }, { word: "sad", type: "adj", mean: "é›£éçš„" }, { word: "red", type: "adj", mean: "ç´…è‰²çš„" }, { word: "blue", type: "adj", mean: "è—è‰²çš„" }
        ];

        const NUMBERS_1_10 = [{ word: "one", type: "number", mean: "ä¸€", isFocus: true }, { word: "two", type: "number", mean: "äºŒ", isFocus: true }, { word: "three", type: "number", mean: "ä¸‰", isFocus: true }, { word: "four", type: "number", mean: "å››", isFocus: true }, { word: "five", type: "number", mean: "äº”", isFocus: true }, { word: "six", type: "number", mean: "å…­", isFocus: true }, { word: "seven", type: "number", mean: "ä¸ƒ", isFocus: true }, { word: "eight", type: "number", mean: "å…«", isFocus: true }, { word: "nine", type: "number", mean: "ä¹", isFocus: true }, { word: "ten", type: "number", mean: "å", isFocus: true }];
        const BROTHER_EXTRAS = [{ word: "tired", type: "adj", mean: "ç´¯çš„", isFocus: true }, { word: "angry", type: "adj", mean: "ç”Ÿæ°£çš„", isFocus: true }, { word: "strong", type: "adj", mean: "å¼·å£¯çš„", isFocus: true }, { word: "thin", type: "adj", mean: "ç˜¦çš„", isFocus: true }, { word: "short", type: "adj", mean: "çŸ­/çŸ®çš„", isFocus: true }, { word: "tall", type: "adj", mean: "é«˜çš„", isFocus: true }];

        const ITEMS_DB = {
            princess: {
                math: [{ id: 'pm1', icon: 'ğŸª„', type: 'weapon', effect: 'magic' }, { id: 'pm2', icon: 'ğŸ‘‘', type: 'head' }, { id: 'pm3', icon: 'ğŸ§šâ€â™€ï¸', type: 'pet' }, { id: 'pm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'pm_potion', icon: 'ğŸ§ª', type: 'skill_heal', name:'è–æ°´' }],
                english: [{ id: 'pe1', icon: 'ğŸŒŸ', type: 'weapon', effect: 'magic' }, { id: 'pe2', icon: 'ğŸ‘’', type: 'head' }, { id: 'pe3', icon: 'ğŸ¦„', type: 'pet' }, { id: 'pe4', icon: 'ğŸ“–', type: 'shield' }, { id: 'pe_time', icon: 'â³', type: 'skill_time', name:'æ‡·éŒ¶' }]
            },
            hero: {
                math: [{ id: 'hm1', icon: 'âš”ï¸', type: 'weapon', effect: 'slash' }, { id: 'hm2', icon: 'â›‘ï¸', type: 'head' }, { id: 'hm3', icon: 'ğŸ²', type: 'pet' }, { id: 'hm4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'hm_potion', icon: 'ğŸ–', type: 'skill_heal', name:'çƒ¤è‚‰' }],
                english: [{ id: 'he1', icon: 'ğŸ—¡ï¸', type: 'weapon', effect: 'slash' }, { id: 'he2', icon: 'ğŸ§¢', type: 'head' }, { id: 'he3', icon: 'ğŸº', type: 'pet' }, { id: 'he4', icon: 'ğŸ›¡ï¸', type: 'shield' }, { id: 'he_time', icon: 'â°', type: 'skill_time', name:'é¬§é˜' }]
            }
        };

        const SCENARIOS = [
            { text: "é­é‡å²èŠå§†ï¼", emoji: "ğŸŸ¢" }, { text: "ç™¼ç¾å¯¶ç®±æ€ªï¼", emoji: "ğŸ“¦" }, { text: "é‡ç‹¼æ“‹è·¯ï¼", emoji: "ğŸº" }, { text: "è™è ä¾†è¥²ï¼", emoji: "ğŸ¦‡" }, { text: "å®ˆè¡›çŸ³åƒï¼", emoji: "ğŸ—¿" }
        ];

        const getWeekId = () => {
            const d = new Date();
            const year = d.getFullYear();
            const firstJan = new Date(year, 0, 1);
            const week = Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay() + 1) / 7);
            return `${year}-W${week}`;
        };

        const INITIAL_STATS = {
            daughter: { lastPlayedDate: '', lastWeekId: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, earnedItems: [], stickerBook: [] },
            son: { lastPlayedDate: '', lastWeekId: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, earnedItems: [], stickerBook: [] },
            mom: { lastPlayedDate: '', lastWeekId: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, earnedItems: [], stickerBook: [] },
            challenger: { lastPlayedDate: '', lastWeekId: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, earnedItems: [], stickerBook: [] }
        };

        const INITIAL_MATH_SETTINGS = { daughter: { slots: [{ range: 10, weight: 5 }, { range: 20, weight: 3 }, { range: 50, weight: 2 }] }, son: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } }, challenger: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } } };
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'å°å“æ¦•', avatar: 'ğŸ‘§', needPwd: true, theme: 'princess' }, 
            son: { id: 'son', name: 'å°æ™¨å¸Œ', avatar: 'ğŸ‘¦', needPwd: true, theme: 'hero' }, 
            mom: { id: 'mom', name: 'å°åª½åª½', avatar: 'ğŸ‘©', needPwd: true, theme: 'princess' }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', needPwd: false, theme: 'hero' } 
        };
        const PARENT_PASSWORD = "28825252";
        const FAMILY_PASSWORD = "168";

        let audioCtx = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, t, v=0.1) => { if(!audioCtx)return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.frequency.value=f; o.type=t; g.gain.value=v; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1); };
        const playSFX = (t) => {
            if (!audioCtx) return; 
            if(t==='attack') { playTone(200,'square',0.3); setTimeout(()=>playTone(150,'square',0.3),100); }
            else if(t==='win') { [440,554,659].forEach((f,i)=>setTimeout(()=>playTone(f,'sine',0.2),i*100)); }
            else if(t==='hurt') { playTone(100,'sawtooth',0.4); setTimeout(()=>playTone(80,'sawtooth',0.4),100); }
            else if(t==='boss') { playTone(80,'square',0.5); }
        };
        const speakWord = (text) => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u); } };

        const getInitialVocab = (role) => {
            let list = [...BASE_VOCAB];
            if (role === 'daughter' || role === 'son') list = [...list, ...NUMBERS_1_10];
            if (role === 'son') {
                list = [...list, ...BROTHER_EXTRAS];
                list = list.map(v => (['happy','sad'].includes(v.word) ? { ...v, isFocus: true } : v));
            }
            const unique = []; const map = new Map();
            for (const item of list) {
                if(!map.has(item.word)){ map.set(item.word, true); unique.push(item); } 
                else if (item.isFocus) { const idx = unique.findIndex(u => u.word === item.word); unique[idx] = item; }
            }
            return unique;
        };

        // --- å…¨èº«è§’è‰²çµ„ä»¶ ---
        const FullBodyChar = ({ charId, items, isAnimating }) => {
            const char = CHARACTERS[charId];
            const theme = char.theme;
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            const myGear = allItems.filter(i => items.includes(i.id));
            const hat = myGear.find(i => i.type === 'head');
            const weapon = myGear.find(i => i.type === 'weapon');
            const shield = myGear.find(i => i.type === 'shield');
            const pet = myGear.find(i => i.type === 'pet');

            return (
                <div className={`char-container transition-transform duration-200 ${isAnimating === 'attack' ? 'translate-x-10' : ''} ${isAnimating === 'hurt' ? 'animate-shake' : ''}`}>
                    {hat && <div className="slot-hat">{hat.icon}</div>}
                    <div className="char-head">{char.avatar}</div>
                    <div className={`char-body ${theme}`}>
                        <div className="char-limb arm-l"></div>
                        <div className="char-limb arm-r"></div>
                        <div className="char-limb leg-l"></div>
                        <div className="char-limb leg-r"></div>
                    </div>
                    {weapon && <div className="slot-weapon">{weapon.icon}</div>}
                    {shield && <div className="slot-shield">{shield.icon}</div>}
                    {pet && <div className="slot-pet">{pet.icon}</div>}
                </div>
            );
        };

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [momMode, setMomMode] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [vocabMap, setVocabMap] = useState({ daughter: getInitialVocab('daughter'), son: getInitialVocab('son'), mom: getInitialVocab('mom'), challenger: getInitialVocab('challenger') });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [rewards, setRewards] = useState({ levelRewards: {}, dailyScore: Array(5).fill({score:0, reward:""}) });
            const [raidData, setRaidData] = useState({ hp: 10000, maxHp: 10000 });
            
            // Game State
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [inputMode, setInputMode] = useState('select');
            const [scenario, setScenario] = useState(SCENARIOS[0]);
            const [animState, setAnimState] = useState('idle');
            const [combo, setCombo] = useState(0);
            const [fever, setFever] = useState(false);
            const [newItem, setNewItem] = useState(null);
            const [userObj, setUserObj] = useState(null);
            const [skillUsed, setSkillUsed] = useState({ heal: false, time: false });

            const gameRuleKeyRef = useRef('daughter');
            const timerRef = useRef(null);

            // --- é›²ç«¯ & è®€å– ---
            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('fh_v8_ultimate'));
                const currentWeek = getWeekId();
                if (saved) { 
                    const loadedStats = { ...INITIAL_STATS, ...saved.stats };
                    Object.keys(loadedStats).forEach(k => {
                        if (loadedStats[k].lastWeekId !== currentWeek) { loadedStats[k].earnedItems = []; loadedStats[k].lastWeekId = currentWeek; }
                    });
                    setStats(loadedStats); 
                    setVocabMap({ ...vocabMap, ...saved.vocabMap });
                    setMathSettings({ ...INITIAL_MATH_SETTINGS, ...saved.mathSettings });
                    setRewards(saved.rewards); 
                }
                
                // Raid Boss Listener
                if (window.db) {
                    const unsub = window.onSnapshot(window.doc(window.db, "system", "raidBoss"), (doc) => {
                        if (doc.exists()) setRaidData(doc.data());
                        else window.setDoc(window.doc(window.db, "system", "raidBoss"), { hp: 10000, maxHp: 10000 });
                    });
                    const authUnsub = window.onAuthStateChanged(window.auth, (u) => {
                        setUserObj(u);
                        if(u && saved) saveToCloud(u); // Sync on login
                    });
                    return () => { unsub(); authUnsub(); };
                }
            }, []);

            useEffect(() => { 
                localStorage.setItem('fh_v8_ultimate', JSON.stringify({ stats, vocabMap, mathSettings, rewards })); 
            }, [stats, vocabMap, mathSettings, rewards]);

            const saveToCloud = async (u) => {
                if (!window.db) return;
                try { await window.setDoc(window.doc(window.db, "users", u.uid), { stats, vocabMap, mathSettings, rewards }); } catch (e) {}
            };

            const handleRaidDamage = async (dmg) => {
                if (window.db) {
                    await window.updateDoc(window.doc(window.db, "system", "raidBoss"), { hp: window.increment(-dmg) });
                }
            };

            const pickWeighted = (opts) => { let total = opts.reduce((a,c)=>a+c.weight,0); let r = Math.random()*total; for(let o of opts){ if(r<o.weight)return o.item; r-=o.weight; } return opts[0].item; };
            
            const generateMathQuestion = (role) => {
                const sRole = role === 'challenger' ? 'son' : role;
                if (sRole === 'daughter') {
                    const range = pickWeighted(mathSettings.daughter.slots.map(s => ({ item: s.range, weight: s.weight })));
                    const n1 = Math.floor(Math.random()*range)+1; const n2 = Math.floor(Math.random()*range)+1;
                    const op = Math.random()>0.5?'+':'-';
                    return op==='+' ? {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:30} : {text:`${Math.max(n1,n2)}-${Math.min(n1,n2)}=?`, answer:(Math.max(n1,n2)-Math.min(n1,n2)).toString(), time:30};
                } else {
                    const settings = mathSettings[sRole] || mathSettings.son;
                    const mode = pickWeighted(Object.keys(settings.weights).map(k=>({item:k, weight:settings.weights[k]})));
                    if(mode.includes('mult')) { const n1=Math.floor(Math.random()*9)+1; const n2=Math.floor(Math.random()*9)+1; return {text:`${n1}x${n2}=?`, answer:(n1*n2).toString(), time:60}; }
                    else { const n1=Math.floor(Math.random()*50)+10; const n2=Math.floor(Math.random()*50)+10; return {text:`${n1}+${n2}=?`, answer:(n1+n2).toString(), time:60}; }
                }
            };

            const generateEnglishQuestion = (role) => {
                const pool = vocabMap[role] || BASE_VOCAB;
                const w = pool[Math.floor(Math.random()*pool.length)];
                const tmpl = SENTENCE_TEMPLATES[w.type] ? SENTENCE_TEMPLATES[w.type][0] : SENTENCE_TEMPLATES.noun[0];
                const txt = tmpl.text.replace('___', '_____');
                const full = tmpl.text.replace('___', w.word);
                const opts = pool.filter(v=>v.word!==w.word).sort(()=>0.5-Math.random()).slice(0,3).map(v=>v.word);
                return { text:txt, fullSentence:full, answer:w.word, options:[w.word,...opts].sort(()=>0.5-Math.random()), time:30, wordObj:w, hint:w.mean };
            };

            const handleStart = (mode) => {
                if (CHARACTERS[playerKey].needPwd) {
                    if (prompt("è«‹è¼¸å…¥å®¶äººå¯†ç¢¼ (168)ï¼š") !== FAMILY_PASSWORD) { alert("å¯†ç¢¼éŒ¯èª¤"); return; }
                }
                initAudio();
                const rule = (playerKey==='mom'||playerKey==='challenger') ? momMode : playerKey;
                gameRuleKeyRef.current = rule;
                setGameMode(mode); setPlayerHp(100); setScore(stats[playerKey].dailyScore); setCombo(0); setFever(false); setSkillUsed({heal:false, time:false});
                const myLv = mode === 'daily_math' ? stats[playerKey].dailyMathLevel : stats[playerKey].dailyEnglishLevel;
                const startLv = Math.floor(myLv / 10) * 10 + 1;
                setDailyLevel(startLv); nextTurn(mode); setScreen('game');
            };

            const nextTurn = (mode) => {
                setAnimState('idle'); setUserAnswer(''); setFeedback(null);
                const lv = dailyLevel;
                // Boss Check
                const isBoss = lv > 0 && lv % 10 === 0;
                // Biome Check
                let bgClass = 'bg-forest';
                if(lv > 30) bgClass = 'bg-volcano'; else if(lv > 20) bgClass = 'bg-ice'; else if(lv > 10) bgClass = 'bg-desert';
                document.body.className = `no-select ${bgClass}`;

                // Listening Mode check (Level ends with 5)
                const isListening = lv % 10 === 5 && mode.includes('english');

                const q = mode.includes('math') ? generateMathQuestion(gameRuleKeyRef.current) : generateEnglishQuestion(gameRuleKeyRef.current);
                setQuestion({ ...q, isListening, isBoss });
                setTimer(q.time); setScenario(isBoss ? {text:"BOSSé™è‡¨!", emoji:"ğŸ‘¹"} : SCENARIOS[Math.floor(Math.random()*SCENARIOS.length)]);
                
                if (mode.includes('english')) setTimeout(()=>speakWord(q.fullSentence), 500);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000);
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const isCorrect = val.toString().toLowerCase().trim() === question.answer.toString().toLowerCase();
                
                if (isCorrect) {
                    const newCombo = combo + 1;
                    setCombo(newCombo);
                    const isFever = newCombo >= 3;
                    setFever(isFever);
                    
                    const dmg = isFever ? 200 : 100; // Raid Damage
                    handleRaidDamage(dmg);
                    
                    setAnimState('attack'); playSFX('attack'); setFeedback('correct'); 
                    setScore(s => s + timer * 10 * (isFever ? 2 : 1));
                    if(question.wordObj) speakWord(question.fullSentence);
                } else {
                    setCombo(0); setFever(false);
                    setAnimState('hurt'); playSFX('hurt'); setFeedback('wrong'); setPlayerHp(h=>h-(gameMode.startsWith('daily')?34:20));
                }

                setTimeout(() => {
                    if (playerHp <= (isCorrect?0:34)) setScreen('result');
                    else if (isCorrect) {
                        if (dailyLevel % 10 === 0) { 
                            // Item Drop
                            const theme = CHARACTERS[playerKey].theme;
                            const type = gameMode.includes('math') ? 'math' : 'english';
                            const pool = ITEMS_DB[theme][type];
                            const earned = stats[playerKey].earnedItems;
                            const avail = pool.filter(i => !earned.includes(i.id));
                            let drop = null;
                            if (avail.length > 0) {
                                drop = avail[Math.floor(Math.random()*avail.length)];
                                const newStats = {...stats}; 
                                newStats[playerKey].earnedItems.push(drop.id);
                                if (!newStats[playerKey].stickerBook.includes(drop.id)) newStats[playerKey].stickerBook.push(drop.id); // Add to Sticker Book
                                if (gameMode.includes('math')) newStats[playerKey].dailyMathLevel = dailyLevel;
                                else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                                setStats(newStats); 
                                localStorage.setItem('fh_v8_ultimate', JSON.stringify({ stats: newStats, vocabMap, mathSettings, rewards }));
                                if (userObj) saveToCloud(userObj);
                            }
                            setNewItem(drop);
                            setScreen('result'); playSFX('win');
                        }
                        else { setDailyLevel(l=>l+1); nextTurn(gameMode); }
                    } else nextTurn(gameMode);
                }, 1500);
            };

            const useSkill = (type) => {
                if (type === 'heal' && !skillUsed.heal) {
                    setPlayerHp(h => Math.min(100, h + 30)); setSkillUsed({...skillUsed, heal:true}); playSFX('item');
                } else if (type === 'time' && !skillUsed.time) {
                    clearInterval(timerRef.current); setSkillUsed({...skillUsed, time:true}); playSFX('item');
                    setTimeout(() => { timerRef.current = setInterval(()=>setTimer(t=>t>0?t-1:0), 1000); }, 5000);
                }
            };

            // Check if player has skill items
            const myItems = stats[playerKey].earnedItems || [];
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            const hasHeal = allItems.some(i => myItems.includes(i.id) && i.type === 'skill_heal');
            const hasTime = allItems.some(i => myItems.includes(i.id) && i.type === 'skill_time');

            // UI
            const StickerBook = () => (
                <div className="h-full bg-slate-900 p-6 overflow-y-auto">
                    <div className="flex justify-between mb-4 text-white"><h2 className="text-2xl font-bold">ğŸ“š æ°¸ä¹…åœ–é‘‘</h2><button onClick={()=>setScreen('menu')} className="bg-gray-700 px-4 rounded">è¿”å›</button></div>
                    <div className="grid grid-cols-4 gap-4">
                        {allItems.map(item => {
                            const owned = stats[playerKey].stickerBook && stats[playerKey].stickerBook.includes(item.id);
                            return (
                                <div key={item.id} className={`p-2 rounded-xl text-center border-2 ${owned ? 'bg-white/20 border-yellow-400' : 'bg-black/40 border-gray-700 opacity-50 grayscale'}`}>
                                    <div className="text-4xl mb-1">{item.icon}</div>
                                    <div className="text-xs text-white">{owned ? item.name : '???'}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className={`w-full h-screen flex flex-col overflow-hidden relative transition-all duration-1000 ${fever ? 'fever-mode' : ''}`}>
                    {newItem && (<div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 animate-pop"><div className="bg-gradient-to-b from-yellow-400 to-orange-500 p-8 rounded-3xl text-center border-4 border-white shadow-2xl"><h3 className="text-2xl font-black text-white mb-4">ğŸ‰ ç²å¾—å¯¶ç‰©ï¼</h3><div className="text-8xl mb-4 animate-bounce">{newItem.icon}</div><div className="text-3xl font-bold text-black">{newItem.name}</div><div className="text-sm text-white mt-2 font-bold opacity-80">å·²åŠ å…¥åœ–é‘‘</div></div></div>)}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center justify-center h-full relative z-10 bg-indigo-900 text-white">
                            <h1 className="text-4xl font-black text-yellow-400 mb-6 drop-shadow-lg">âš”ï¸ å°å®¶è‹±é›„æ¦œ</h1>
                            
                            {/* Raid Boss Banner */}
                            <div className="w-full max-w-lg bg-red-900/80 p-3 rounded-xl mb-4 border-2 border-red-500 flex items-center gap-3">
                                <div className="text-4xl animate-bounce">ğŸ²</div>
                                <div className="flex-1">
                                    <div className="text-xs text-red-200 font-bold uppercase flex justify-between"><span>ä¸–ç•Œæƒ¡é¾è¨ä¼</span><span>{Math.max(0, raidData.hp)}/{raidData.maxHp}</span></div>
                                    <div className="h-3 w-full bg-black rounded-full overflow-hidden mt-1"><div className="h-full bg-red-500 transition-all duration-500" style={{width: `${(raidData.hp/raidData.maxHp)*100}%`}}></div></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-4 gap-2 mb-6 bg-black/20 p-2 rounded-xl w-full max-w-lg">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={() => setPlayerKey(c.id)} className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all ${playerKey === c.id ? 'bg-yellow-500 text-black scale-105 shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}>
                                        <span className="text-2xl mb-1">{c.avatar}</span><span className="text-xs font-bold">{c.name}</span>{c.subName && <span className="text-[9px] block text-green-300">{c.subName}</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-white/10 p-6 rounded-[2.5rem] border-4 border-white/20 flex flex-col items-center backdrop-blur-sm w-full max-w-sm mb-6 relative">
                                <div className="relative mb-6 scale-110">
                                    <FullBodyChar charId={playerKey} items={stats[playerKey].earnedItems} isAnimating="idle" />
                                </div>
                                {(playerKey === 'mom' || playerKey === 'challenger') && (
                                    <div className="flex bg-black/30 rounded-full p-1 mb-4 w-full text-sm font-bold">
                                        <button onClick={()=>setMomMode('daughter')} className={`flex-1 py-1 rounded-full ${momMode==='daughter'?'bg-pink-600':'text-gray-400'}`}>æ¸¬å¦¹å¦¹</button>
                                        <button onClick={()=>setMomMode('son')} className={`flex-1 py-1 rounded-full ${momMode==='son'?'bg-blue-600':'text-gray-400'}`}>æ¸¬å“¥å“¥</button>
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-3 w-full">
                                    <button onClick={()=>handleStart('daily_math')} className="bg-orange-500 p-4 rounded-xl font-bold flex flex-col items-center shadow-lg active:scale-95"><div className="text-2xl mb-1">ğŸ§®</div>æŒ‘æˆ°æ•¸å­¸<div className="text-xs opacity-70 bg-black/20 px-2 rounded mt-1">Lv.{stats[playerKey].dailyMathLevel}</div></button>
                                    <button onClick={()=>handleStart('daily_english')} className="bg-blue-500 p-4 rounded-xl font-bold flex flex-col items-center shadow-lg active:scale-95"><div className="text-2xl mb-1">ğŸ—£ï¸</div>æŒ‘æˆ°è‹±æ–‡<div className="text-xs opacity-70 bg-black/20 px-2 rounded mt-1">Lv.{stats[playerKey].dailyEnglishLevel}</div></button>
                                </div>
                            </div>
                            <div className="flex gap-4 text-sm text-gray-400">
                                <button onClick={() => setScreen('sticker')} className="bg-white/5 px-3 py-1 rounded">ğŸ“’ åœ–é‘‘</button>
                                <button onClick={() => {if(prompt("å¯†ç¢¼?")===PARENT_PASSWORD) setScreen('settings')}} className="bg-white/5 px-3 py-1 rounded">âš™ï¸ ç®¡ç†</button>
                            </div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full flex flex-col bg-slate-900/50 text-white relative z-10">
                            {/* HUD */}
                            <div className="p-3 flex justify-between items-center bg-black/30 backdrop-blur">
                                <div className="flex items-center gap-2">
                                    <div className="text-2xl">{CHARACTERS[playerKey].avatar}</div>
                                    <div className="w-24 h-3 bg-gray-700 rounded-full overflow-hidden"><div className="h-full bg-green-500 transition-all" style={{width:`${playerHp}%`}}/></div>
                                </div>
                                <div className={`text-center ${fever ? 'scale-110 text-yellow-300' : ''}`}>
                                    <div className="text-xs font-bold">LV.{dailyLevel} {fever && 'ğŸ”¥FEVER!'}</div>
                                    <div className="text-3xl font-mono font-bold">{timer}</div>
                                </div>
                                <div className={`text-2xl ${question.isBoss ? 'boss-mode' : ''}`}>{scenario.emoji}</div>
                            </div>
                            
                            <div className="flex-1 flex flex-col items-center justify-center p-4 relative overflow-hidden">
                                {/* Visuals */}
                                <div className="absolute inset-0 flex justify-between items-center px-4 pointer-events-none opacity-80">
                                    <div className={`text-9xl transition-transform duration-300 ${animState==='attack'?'translate-x-20':''} ${animState==='hurt'?'animate-shake':''}`}><FullBodyChar charId={playerKey} items={stats[playerKey].earnedItems} /></div>
                                    <div className={`text-9xl transition-transform duration-300 ${animState==='attack'?'animate-shake':''} ${animState==='hurt'?'-translate-x-20':''}`}>{scenario.emoji}</div>
                                </div>

                                {/* Skills */}
                                <div className="absolute bottom-4 left-4 flex gap-2 z-20">
                                    {hasHeal && <button onClick={()=>useSkill('heal')} disabled={skillUsed.heal} className={`p-3 rounded-full text-2xl shadow-lg border-2 border-white ${skillUsed.heal ? 'bg-gray-500 opacity-50' : 'bg-green-500 animate-bounce'}`}>ğŸ§ª</button>}
                                    {hasTime && <button onClick={()=>useSkill('time')} disabled={skillUsed.time} className={`p-3 rounded-full text-2xl shadow-lg border-2 border-white ${skillUsed.time ? 'bg-gray-500 opacity-50' : 'bg-blue-500 animate-bounce'}`}>â³</button>}
                                </div>

                                {/* Question Card */}
                                <div className={`bg-white/10 backdrop-blur-md p-6 rounded-3xl w-full max-w-md text-center border border-white/20 shadow-2xl relative z-10 transition-transform ${feedback?'scale-105':''}`}>
                                    {feedback && <div className={`absolute inset-0 flex items-center justify-center text-8xl font-bold bg-black/60 rounded-3xl z-20 ${feedback==='correct'?'text-green-500':'text-red-500'}`}>{feedback==='correct'?'â­•':'âŒ'}</div>}
                                    <div className="mb-4">
                                        <span className="text-blue-300 text-xs font-bold uppercase bg-black/40 px-2 py-1 rounded">{gameMode.includes('math')?'MATH':`ENGLISH`}</span>
                                        {question.isListening ? (
                                            <div className="mt-4 text-4xl font-bold animate-pulse text-yellow-300 cursor-pointer" onClick={()=>speakWord(question.fullSentence)}>ğŸ”Š é»æ“Šè½é¡Œç›®</div>
                                        ) : (
                                            <h2 className="text-4xl font-black mt-2 leading-tight">{gameMode.includes('math')?question.text:question.display}</h2>
                                        )}
                                    </div>
                                    {gameMode.includes('english') && inputMode === 'select' ? (<div className="grid grid-cols-2 gap-3">{question.options.map(opt=><button key={opt} onClick={()=>handleAnswer(opt)} className="bg-white/10 p-4 rounded-xl font-bold text-xl border border-white/10 active:bg-indigo-600 transition-colors">{opt}</button>)}</div>) : (<div className="flex gap-2"><input value={userAnswer} onChange={e=>setUserAnswer(e.target.value)} className="flex-1 bg-black/50 border-2 border-white/20 rounded-xl p-3 text-2xl text-center outline-none focus:border-yellow-400 text-white" placeholder="è¼¸å…¥..." type={gameMode.includes('math')?'tel':'text'}/><button onClick={()=>handleAnswer(userAnswer)} className="bg-yellow-500 text-black px-6 rounded-xl font-black text-xl">GO</button></div>)}
                                    {gameMode.includes('english') && <div className="mt-4 flex justify-center gap-2"><button onClick={()=>setInputMode('select')} className={`px-3 py-1 rounded-full text-xs font-bold ${inputMode==='select'?'bg-blue-600':'bg-white/10'}`}>é¸æ“‡é¡Œ</button><button onClick={()=>setInputMode('type')} className={`px-3 py-1 rounded-full text-xs font-bold ${inputMode==='type'?'bg-purple-600':'bg-white/10'}`}>æ‹¼å­—é¡Œ</button></div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'sticker' && <StickerBook />}
                    {/* (ä¿ç•™ Vocab, Settings, Result ç•«é¢ä»£ç¢¼ï¼Œèˆ‡å‰ç‰ˆç›¸åŒï¼Œç‚ºç¯€çœç©ºé–“çœç•¥) */}
                    {screen === 'result' && <div className="h-full flex flex-col items-center justify-center p-8 text-center bg-indigo-900 text-white"><div className="text-6xl mb-4">{dailyLevel%10===0?'ğŸ†':'ğŸ’€'}</div><h2 className="text-3xl font-bold mb-4">{dailyLevel%10===0?'æŒ‘æˆ°æˆåŠŸï¼':'å†æ¥å†å²'}</h2><button onClick={()=>setScreen('menu')} className="bg-white text-black px-8 py-3 rounded-xl font-bold">è¿”å›</button></div>}
                    {screen === 'vocab' && <div className="h-full p-4 overflow-y-auto bg-indigo-900 text-white"><button onClick={()=>setScreen('menu')} className="mb-4 bg-gray-700 px-3 py-1 rounded">è¿”å›</button><div className="grid grid-cols-2 gap-2">{(vocabMap[playerKey]||BASE_VOCAB).map((v,i)=><div key={i} onClick={()=>speakWord(v.word)} className="bg-white/10 p-2 rounded">{v.word} <span className="text-xs text-gray-400">{v.mean}</span></div>)}</div></div>}
                    {screen === 'settings' && <div className="h-full p-4 bg-slate-900 text-white"><button onClick={()=>setScreen('menu')} className="mb-4 bg-gray-700 px-3 py-1 rounded">é€€å‡º</button><div className="text-center text-gray-400">è«‹ç¢ºèª Firebase Config æ˜¯å¦å·²å¡«å…¥</div></div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
