<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å®¶è‹±é›„æ¦œï¼šçŸ¥è­˜å¤§å†’éšª</title>
    <!-- CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); } 20%, 40%, 60%, 80% { transform: translate(5px, 0); } }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        body { background-color: black; color: white; margin: 0; overflow: hidden; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- æ ¸å¿ƒè³‡æ–™èˆ‡æ¨¡æ¿ ---
        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I can see the ___.", hint: "æˆ‘çœ‹è¦‹é‚£å€‹..." }, { text: "Do you like the ___?", hint: "ä½ å–œæ­¡é€™å€‹...å—ï¼Ÿ" }, { text: "The ___ is over there.", hint: "é‚£å€‹...åœ¨é‚£é‚Š" }, { text: "I have a ___.", hint: "æˆ‘æœ‰ä¸€å€‹..." }],
            verb: [{ text: "I like to ___.", hint: "æˆ‘å–œæ­¡..." }, { text: "Can you ___?", hint: "ä½ æœƒ...å—ï¼Ÿ" }, { text: "Let's ___ together.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }, { text: "Please ___ now.", hint: "è«‹ç¾åœ¨..." }, { text: "Don't ___ here.", hint: "ä¸è¦åœ¨é€™è£¡..." }],
            adj: [{ text: "It looks very ___.", hint: "å®ƒçœ‹èµ·ä¾†å¾ˆ..." }, { text: "Are you ___?", hint: "ä½ è¦ºå¾—...å—ï¼Ÿ" }, { text: "The cat is ___.", hint: "é€™éš»è²“å¾ˆ..." }, { text: "I feel ___ today.", hint: "æˆ‘ä»Šå¤©è¦ºå¾—å¾ˆ..." }]
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "pig", type: "noun", mean: "è±¬" }, { word: "bird", type: "noun", mean: "é³¥" }, { word: "duck", type: "noun", mean: "é´¨å­" }, { word: "lion", type: "noun", mean: "ç…å­" }, { word: "fish", type: "noun", mean: "é­š" }, { word: "monkey", type: "noun", mean: "çŒ´å­" }, { word: "tiger", type: "noun", mean: "è€è™" }, { word: "zebra", type: "noun", mean: "æ–‘é¦¬" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "banana", type: "noun", mean: "é¦™è•‰" }, { word: "egg", type: "noun", mean: "è›‹" }, { word: "cake", type: "noun", mean: "è›‹ç³•" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶" }, { word: "water", type: "noun", mean: "æ°´" }, { word: "rice", type: "noun", mean: "ç±³é£¯" }, { word: "candy", type: "noun", mean: "ç³–æœ" },
            { word: "sun", type: "noun", mean: "å¤ªé™½" }, { word: "moon", type: "noun", mean: "æœˆäº®" }, { word: "star", type: "noun", mean: "æ˜Ÿæ˜Ÿ" }, { word: "tree", type: "noun", mean: "æ¨¹" }, { word: "flower", type: "noun", mean: "èŠ±" }, { word: "book", type: "noun", mean: "æ›¸" }, { word: "pen", type: "noun", mean: "ç­†" }, { word: "bag", type: "noun", mean: "æ›¸åŒ…" }, { word: "bus", type: "noun", mean: "å…¬è»Š" }, { word: "car", type: "noun", mean: "è»Šå­" },
            { word: "eye", type: "noun", mean: "çœ¼ç›" }, { word: "nose", type: "noun", mean: "é¼»å­" }, { word: "mouth", type: "noun", mean: "å˜´å·´" }, { word: "hand", type: "noun", mean: "æ‰‹" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" }, { word: "walk", type: "verb", mean: "èµ°è·¯" }, { word: "swim", type: "verb", mean: "æ¸¸æ³³" }, { word: "fly", type: "verb", mean: "é£›" }, { word: "eat", type: "verb", mean: "åƒ" }, { word: "drink", type: "verb", mean: "å–" }, { word: "sleep", type: "verb", mean: "ç¡è¦º" }, { word: "draw", type: "verb", mean: "ç•«ç•«" }, { word: "sing", type: "verb", mean: "å”±æ­Œ" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" }, { word: "hot", type: "adj", mean: "ç†±çš„" }, { word: "cold", type: "adj", mean: "å†·çš„" }, { word: "happy", type: "adj", mean: "å¿«æ¨‚çš„" }, { word: "sad", type: "adj", mean: "é›£éçš„" }, { word: "red", type: "adj", mean: "ç´…è‰²çš„" }, { word: "blue", type: "adj", mean: "è—è‰²çš„" }
        ];

        const SCENARIOS = [
            { text: "å¤±ç«äº†ï¼å¿«å¹«å¿™æ»…ç«ï¼", emoji: "ğŸ”¥", type: "tense" }, { text: "æœ‰å°å·ï¼å¿«æŠ“ä½ä»–ï¼", emoji: "ğŸ¦¹", type: "tense" }, { text: "ç—…äººéœ€è¦æ€¥æ•‘ï¼", emoji: "ğŸš‘", type: "tense" }, { text: "å¤–é€è¨‚å–®å¿«é²åˆ°äº†ï¼", emoji: "ğŸ›µ", type: "happy" }, { text: "æˆ¿é–“å¤ªäº‚äº†ï¼", emoji: "ğŸ§¹", type: "happy" }, { text: "è‚šå­å¥½é¤“å–”ï¼", emoji: "ğŸ±", type: "happy" }, { text: "é‡ç”Ÿå™´ç«é¾å‡ºç¾ï¼", emoji: "ğŸ‰", type: "battle" }, { text: "ç™¼ç¾ç¥ç§˜å¯¶ç®±ï¼", emoji: "ğŸ’", type: "battle" }, { text: "æœ€å¾Œä¸€ç§’æŠ•ç±ƒï¼", emoji: "ğŸ€", type: "tense" }, { text: "å¹«çˆ¸çˆ¸æ¥èƒŒï¼", emoji: "ğŸ‘¨", type: "happy" }
        ];

        const INITIAL_STATS = {
            daughter: { lastPlayedDate: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, weeklyHistory: [] },
            son: { lastPlayedDate: '', dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, allTimeBest: { score: 0, date: '-' }, weeklyHistory: [] }
        };

        const CHARACTERS = { daughter: { id: 'daughter', name: 'å°å“æ¦•', avatar: 'ğŸ‘§' }, son: { id: 'son', name: 'å°æ™¨å¸Œ', avatar: 'ğŸ‘¦' } };
        const PARENT_PASSWORD = "28825252";

        // --- éŸ³æ¨‚èˆ‡éŸ³æ•ˆå¼•æ“ ---
        let audioCtx = null;
        let musicInterval = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, d, w = 'sine', v = 0.05) => { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = w; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d); };
        const stopMusic = () => { if (musicInterval) clearInterval(musicInterval); };
        const playMusic = (style) => {
            stopMusic(); if (!audioCtx) return;
            let scale = [261, 329, 392, 523]; let tempo = 400; let wave = 'sine';
            if (style === 'battle') { scale = [130, 155, 196, 261]; tempo = 200; wave = 'sawtooth'; }
            musicInterval = setInterval(() => { if (Math.random() > 0.4) playTone(scale[Math.floor(Math.random() * scale.length)], tempo / 1000, wave); }, tempo);
        };
        const playSFX = (t) => { if (!audioCtx) return; const n = audioCtx.currentTime; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); if (t === 'attack') { o.frequency.setValueAtTime(200, n); o.frequency.linearRampToValueAtTime(800, n + 0.1); g.gain.setValueAtTime(0.1, n); o.start(); o.stop(n + 0.1); } else if (t === 'win') { [0, 0.1, 0.2].forEach((s, i) => { const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain(); o2.connect(g2); g2.connect(audioCtx.destination); o2.frequency.setValueAtTime(440 + i * 110, n + s); g2.gain.setValueAtTime(0.1, n + s); o2.start(n + s); o2.stop(n + s + 0.3); }); } };

        // --- çµ„ä»¶ ---
        const LucideIcon = ({ name, className }) => {
            const [IconComp, setIconComp] = useState(null);
            useEffect(() => {
                const camelName = name[0].toUpperCase() + name.slice(1).replace(/-([a-z])/g, g => g[1].toUpperCase());
                setIconComp(window.lucide.icons[camelName]);
            }, [name]);
            return IconComp ? <IconComp className={className} /> : null;
        };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [vocabMap, setVocabMap] = useState({ daughter: [...BASE_VOCAB], son: [...BASE_VOCAB] });
            const [mathSettings, setMathSettings] = useState({ daughter: { slots: [{ range: 10, weight: 1 }] }, son: { weights: { '2-digit-add-sub': 1 } } });
            const [rewards, setRewards] = useState({ levelRewards: {} });
            const [audioStarted, setAudioStarted] = useState(false);
            
            // éŠæˆ²é‹è¡Œç‹€æ…‹
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [hp, setHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [scenario, setScenario] = useState(SCENARIOS[0]);
            const timerRef = useRef(null);

            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('fh_v4_github'));
                if (saved) { setStats(saved.stats); setVocabMap(saved.vocabMap); setMathSettings(saved.mathSettings); setRewards(saved.rewards); }
            }, []);

            useEffect(() => {
                localStorage.setItem('fh_v4_github', JSON.stringify({ stats, vocabMap, mathSettings, rewards }));
            }, [stats, vocabMap, mathSettings, rewards]);

            const handleStart = (mode) => {
                initAudio(); setAudioStarted(true);
                const p = stats[playerKey];
                const myLv = mode === 'daily_math' ? p.dailyMathLevel : p.dailyEnglishLevel;
                const otherLv = mode === 'daily_math' ? p.dailyEnglishLevel : p.dailyMathLevel;
                if (myLv > 0 && myLv % 20 === 0 && otherLv < myLv) {
                    alert(`ğŸš§ éšæ®µé–å®šï¼šè«‹å…ˆæŠŠå¦ä¸€ç§‘ç›®çš„ç­‰ç´š(Lv.${otherLv})è¿½ä¸Šä¾†åˆ° Lv.${myLv}ï¼`);
                    return;
                }
                setGameMode(mode); setScore(p.dailyScore); setPlayerHp(100); setHp(100); setScenario(SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)]);
                const startLv = Math.floor(myLv / 10) * 10 + 1;
                setDailyLevel(startLv); setScreen('game'); nextTurn(mode); playMusic(scenario.type);
            };

            const nextTurn = (mode) => {
                const qType = mode === 'daily_math' ? 'math' : 'english';
                const q = qType === 'math' ? { text: "1 + 1 = ?", answer: "2", time: 30 } : { text: "A is for ___.", display: "A is for _____.", answer: "apple", options: ["apple", "dog", "cat", "pig"], time: 30 };
                // æ­¤è™•ç°¡åŒ–å‡ºé¡Œé‚è¼¯ä¾›ç¤ºæ„
                setQuestion(q); setTimer(q.time); setUserAnswer(''); setFeedback(null); setHp(100); setScenario(SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)]);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => setTimer(t => t > 0 ? t - 1 : 0), 1000);
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const isCorrect = val.trim().toLowerCase() === question.answer.toLowerCase();
                if (isCorrect) { playSFX('attack'); setScore(s => s + timer * 10); setFeedback('correct'); }
                else { playTone(100, 0.3, 'sawtooth'); setPlayerHp(h => h - 34); setFeedback('wrong'); }
                setTimeout(() => {
                    if (playerHp <= 0 && !isCorrect) setScreen('result');
                    else if (isCorrect) {
                        if (dailyLevel % 10 === 0) {
                            const newStats = { ...stats };
                            if (gameMode === 'daily_math') newStats[playerKey].dailyMathLevel = dailyLevel;
                            else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                            setStats(newStats); setScreen('result'); playSFX('win');
                        } else { setDailyLevel(l => l + 1); nextTurn(gameMode); }
                    } else nextTurn(gameMode);
                }, 1500);
            };

            return (
                <div className="w-full h-screen bg-indigo-900 overflow-hidden flex flex-col">
                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center justify-center h-full">
                            <h1 className="text-4xl font-black text-yellow-400 mb-8">âš”ï¸ å°å®¶è‹±é›„æ¦œ âš”ï¸</h1>
                            <div className="flex gap-4 mb-8">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={() => setPlayerKey(c.id)} className={`p-4 rounded-2xl flex flex-col items-center border-4 ${playerKey === c.id ? 'border-yellow-400 bg-white/20' : 'border-transparent bg-white/5'}`}>
                                        <div className="text-6xl">{c.avatar}</div>
                                        <div className="font-bold mt-2">{c.name}</div>
                                    </button>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
                                <button onClick={() => handleStart('daily_math')} className="bg-orange-500 p-6 rounded-3xl font-bold flex flex-col items-center shadow-xl">
                                    <LucideIcon name="calculator" className="mb-2" /> æŒ‘æˆ°æ•¸å­¸
                                    <div className="text-xs opacity-70">Lv.{stats[playerKey].dailyMathLevel}</div>
                                </button>
                                <button onClick={() => handleStart('daily_english')} className="bg-blue-500 p-6 rounded-3xl font-bold flex flex-col items-center shadow-xl">
                                    <LucideIcon name="languages" className="mb-2" /> æŒ‘æˆ°è‹±æ–‡
                                    <div className="text-xs opacity-70">Lv.{stats[playerKey].dailyEnglishLevel}</div>
                                </button>
                            </div>
                            <div className="mt-8 flex gap-4 text-sm text-gray-400">
                                <button onClick={() => setScreen('vocab')} className="underline">å–®å­—æœ¬</button>
                                <button onClick={() => { const p = prompt("å¯†ç¢¼?"); if (p === PARENT_PASSWORD) setScreen('settings'); }} className="underline">å®¶é•·è¨­å®š</button>
                            </div>
                        </div>
                    )}
                    {screen === 'game' && (
                        <div className="h-full flex flex-col bg-slate-900 text-white p-4">
                            <div className="flex justify-between items-center mb-8">
                                <div className="text-4xl">{CHARACTERS[playerKey].avatar} <span className="text-sm font-bold">{playerHp} HP</span></div>
                                <div className="text-center font-mono"><div className="text-yellow-400 text-xs">Lv.{dailyLevel}</div><div className="text-4xl">{timer}</div></div>
                                <div className="text-4xl">{scenario.emoji} <span className="text-xs text-gray-400">{scenario.text}</span></div>
                            </div>
                            <div className="flex-1 flex flex-col items-center justify-center">
                                <div className="bg-white/5 p-12 rounded-[3rem] w-full max-w-xl text-center shadow-2xl relative overflow-hidden">
                                    {feedback && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-4xl font-bold">{feedback === 'correct' ? 'âœ…' : 'âŒ'}</div>}
                                    <h2 className="text-5xl font-black mb-8">{gameMode === 'daily_math' ? question.text : question.display}</h2>
                                    <div className="flex gap-4">
                                        <input value={userAnswer} onChange={e => setUserAnswer(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAnswer(userAnswer)} placeholder="ç­”æ¡ˆ..." className="flex-1 bg-black/40 p-4 text-3xl rounded-xl text-center outline-none" autoFocus />
                                        <button onClick={() => handleAnswer(userAnswer)} className="bg-yellow-400 text-black px-8 rounded-xl font-bold">GO</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    {screen === 'result' && (
                        <div className="h-full flex flex-col items-center justify-center p-8 text-center">
                            <Trophy size={100} className="text-yellow-400 mb-4" />
                            <h2 className="text-4xl font-black mb-8">æŒ‘æˆ°çµæŸ</h2>
                            <button onClick={() => setScreen('menu')} className="bg-white text-indigo-900 px-12 py-4 rounded-xl font-bold text-xl">è¿”å›é¦–é </button>
                        </div>
                    )}
                    {screen === 'settings' && (
                        <div className="h-full p-6 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">å®¶é•·è¨­å®š</h2><button onClick={() => setScreen('menu')}>è¿”å›</button></div>
                            <button onClick={() => { const code = JSON.stringify({ stats, vocabMap, mathSettings, rewards }); navigator.clipboard.writeText(code); alert("å­˜æª”ä»£ç¢¼å·²è¤‡è£½ï¼"); }} className="w-full bg-blue-600 p-4 rounded mb-4">è¤‡è£½å‚™ä»½ä»£ç¢¼</button>
                            <button onClick={() => { const code = prompt("è²¼ä¸Šå­˜æª”ä»£ç¢¼"); if (code) { const d = JSON.parse(code); setStats(d.stats); setVocabMap(d.vocabMap); setMathSettings(d.mathSettings); setRewards(d.rewards); alert("é‚„åŸæˆåŠŸï¼"); } }} className="w-full bg-orange-600 p-4 rounded">è®€å–å‚™ä»½ä»£ç¢¼</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>