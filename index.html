<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šçŸ¥è­˜å¤§å†’éšª</title>
    <!-- React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); } 20%, 40%, 60%, 80% { transform: translate(5px, 0); } }
        .animate-shake { animation: shake 0.5s ease-in-out; }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }
        .animate-pop { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        body { background-color: #312e81; color: white; margin: 0; overflow-x: hidden; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-select { user-select: none; -webkit-user-select: none; }
        button:active { transform: scale(0.95); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è£å‚™ä½ç½®å®šç¾© */
        .item-slot-weapon { position: absolute; right: -20px; bottom: 10px; font-size: 2.5rem; filter: drop-shadow(0 0 5px rgba(255,255,0,0.5)); transform: rotate(15deg); z-index: 10; }
        .item-slot-head { position: absolute; left: 50%; top: -25px; transform: translateX(-50%); font-size: 2rem; z-index: 10; }
        .item-slot-pet { position: absolute; left: -30px; bottom: 20px; font-size: 2rem; animation: float 3s infinite; z-index: 5; }
        .item-slot-shield { position: absolute; right: 40px; bottom: -10px; font-size: 2rem; z-index: 10; }
        
        /* æ”»æ“Šç‰¹æ•ˆ */
        @keyframes slash { 0% { transform: scale(0) rotate(-45deg); opacity: 1; } 50% { transform: scale(2) rotate(0deg); opacity: 1; } 100% { transform: scale(3) rotate(45deg); opacity: 0; } }
        @keyframes magic-blast { 0% { transform: scale(0); opacity: 1; box-shadow: 0 0 10px #fff; border-radius: 50%; } 100% { transform: scale(4); opacity: 0; box-shadow: 0 0 50px #0ff; } }
        .effect-slash { position: absolute; width: 100px; height: 10px; background: white; top: 50%; left: 50%; animation: slash 0.3s ease-out; box-shadow: 0 0 10px #f00; }
        .effect-magic { position: absolute; width: 50px; height: 50px; background: radial-gradient(circle, white, cyan, transparent); top: 50%; left: 50%; animation: magic-blast 0.5s ease-out; }
    </style>
</head>
<body class="no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- è³‡æ–™èˆ‡è¨­å®š ---
        const SENTENCE_TEMPLATES = {
            noun: [{ text: "This is a ___.", hint: "é€™æ˜¯ä¸€å€‹..." }, { text: "I can see a ___.", hint: "æˆ‘çœ‹è¦‹ä¸€å€‹..." }, { text: "Do you like the ___?", hint: "ä½ å–œæ­¡é€™å€‹...å—ï¼Ÿ" }, { text: "The ___ is over there.", hint: "é‚£å€‹...åœ¨é‚£é‚Š" }, { text: "I have a ___.", hint: "æˆ‘æœ‰ä¸€å€‹..." }, { text: "Look at that ___!", hint: "çœ‹é‚£å€‹...!" }, { text: "Where is the ___?", hint: "é‚£å€‹...åœ¨å“ªè£¡ï¼Ÿ" }, { text: "Please give me a ___.", hint: "è«‹çµ¦æˆ‘ä¸€å€‹..." }, { text: "Is that a ___?", hint: "é‚£æ˜¯ä¸€å€‹...å—ï¼Ÿ" }, { text: "Draw a big ___.", hint: "ç•«ä¸€å€‹å¤§çš„..." }, { text: "My ___ is cute.", hint: "æˆ‘çš„...å¾ˆå¯æ„›" }, { text: "I want a ___.", hint: "æˆ‘æƒ³è¦ä¸€å€‹..." }, { text: "That is a ___.", hint: "é‚£æ˜¯ä¸€å€‹..." }],
            verb: [{ text: "I like to ___.", hint: "æˆ‘å–œæ­¡..." }, { text: "Can you ___?", hint: "ä½ æœƒ...å—ï¼Ÿ" }, { text: "Let's ___ together.", hint: "æˆ‘å€‘ä¸€èµ·...å§" }, { text: "Please ___ now.", hint: "è«‹ç¾åœ¨..." }, { text: "Don't ___ here.", hint: "ä¸è¦åœ¨é€™è£¡..." }, { text: "I want to ___.", hint: "æˆ‘æƒ³è¦..." }, { text: "It is time to ___.", hint: "æ˜¯æ™‚å€™...äº†" }, { text: "We ___ every day.", hint: "æˆ‘å€‘æ¯å¤©..." }, { text: "Do not ___.", hint: "ä¸è¦..." }, { text: "He likes to ___.", hint: "ä»–å–œæ­¡..." }],
            adj: [{ text: "It looks very ___.", hint: "å®ƒçœ‹èµ·ä¾†å¾ˆ..." }, { text: "Are you ___?", hint: "ä½ è¦ºå¾—...å—ï¼Ÿ" }, { text: "The cat is ___.", hint: "é€™éš»è²“å¾ˆ..." }, { text: "I feel ___ today.", hint: "æˆ‘ä»Šå¤©è¦ºå¾—å¾ˆ..." }, { text: "Don't be ___.", hint: "ä¸è¦..." }, { text: "He is so ___.", hint: "ä»–å¥½..." }, { text: "The weather is ___.", hint: "å¤©æ°£å¾ˆ..." }, { text: "Is it ___?", hint: "å®ƒ...å—ï¼Ÿ" }, { text: "My dog is ___.", hint: "æˆ‘çš„ç‹—å¾ˆ..." }],
            number: [{ text: "I have ___ apples.", hint: "æˆ‘æœ‰...é¡†è˜‹æœ" }, { text: "Count to ___.", hint: "æ•¸åˆ°..." }, { text: "The number is ___.", hint: "æ•¸å­—æ˜¯..." }, { text: "I see ___ birds.", hint: "æˆ‘çœ‹è¦‹...éš»é³¥" }, { text: "Give me ___ books.", hint: "çµ¦æˆ‘...æœ¬æ›¸" }]
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" }, { word: "pig", type: "noun", mean: "è±¬" }, { word: "bird", type: "noun", mean: "é³¥" }, { word: "duck", type: "noun", mean: "é´¨å­" }, { word: "lion", type: "noun", mean: "ç…å­" }, { word: "fish", type: "noun", mean: "é­š" }, { word: "monkey", type: "noun", mean: "çŒ´å­" }, { word: "tiger", type: "noun", mean: "è€è™" }, { word: "zebra", type: "noun", mean: "æ–‘é¦¬" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "banana", type: "noun", mean: "é¦™è•‰" }, { word: "egg", type: "noun", mean: "è›‹" }, { word: "cake", type: "noun", mean: "è›‹ç³•" }, { word: "milk", type: "noun", mean: "ç‰›å¥¶", u: true }, { word: "water", type: "noun", mean: "æ°´", u: true }, { word: "rice", type: "noun", mean: "ç±³é£¯", u: true }, { word: "candy", type: "noun", mean: "ç³–æœ", u: true },
            { word: "sun", type: "noun", mean: "å¤ªé™½", unique: true }, { word: "moon", type: "noun", mean: "æœˆäº®", unique: true }, { word: "star", type: "noun", mean: "æ˜Ÿæ˜Ÿ" }, { word: "tree", type: "noun", mean: "æ¨¹" }, { word: "flower", type: "noun", mean: "èŠ±" }, { word: "book", type: "noun", mean: "æ›¸" }, { word: "pen", type: "noun", mean: "ç­†" }, { word: "bag", type: "noun", mean: "æ›¸åŒ…" }, { word: "bus", type: "noun", mean: "å…¬è»Š" }, { word: "car", type: "noun", mean: "è»Šå­" },
            { word: "eye", type: "noun", mean: "çœ¼ç›" }, { word: "nose", type: "noun", mean: "é¼»å­" }, { word: "mouth", type: "noun", mean: "å˜´å·´" }, { word: "hand", type: "noun", mean: "æ‰‹" },
            { word: "run", type: "verb", mean: "è·‘" }, { word: "jump", type: "verb", mean: "è·³" }, { word: "walk", type: "verb", mean: "èµ°è·¯" }, { word: "swim", type: "verb", mean: "æ¸¸æ³³" }, { word: "fly", type: "verb", mean: "é£›" }, { word: "eat", type: "verb", mean: "åƒ" }, { word: "drink", type: "verb", mean: "å–" }, { word: "sleep", type: "verb", mean: "ç¡è¦º" }, { word: "draw", type: "verb", mean: "ç•«ç•«" }, { word: "sing", type: "verb", mean: "å”±æ­Œ" },
            { word: "big", type: "adj", mean: "å¤§çš„" }, { word: "small", type: "adj", mean: "å°çš„" }, { word: "hot", type: "adj", mean: "ç†±çš„" }, { word: "cold", type: "adj", mean: "å†·çš„" }, { word: "happy", type: "adj", mean: "å¿«æ¨‚çš„" }, { word: "sad", type: "adj", mean: "é›£éçš„" }, { word: "red", type: "adj", mean: "ç´…è‰²çš„" }, { word: "blue", type: "adj", mean: "è—è‰²çš„" }
        ];

        const NUMBERS_1_10 = [{ word: "one", type: "number", mean: "ä¸€", isFocus: true }, { word: "two", type: "number", mean: "äºŒ", isFocus: true }, { word: "three", type: "number", mean: "ä¸‰", isFocus: true }, { word: "four", type: "number", mean: "å››", isFocus: true }, { word: "five", type: "number", mean: "äº”", isFocus: true }, { word: "six", type: "number", mean: "å…­", isFocus: true }, { word: "seven", type: "number", mean: "ä¸ƒ", isFocus: true }, { word: "eight", type: "number", mean: "å…«", isFocus: true }, { word: "nine", type: "number", mean: "ä¹", isFocus: true }, { word: "ten", type: "number", mean: "å", isFocus: true }];
        const BROTHER_EXTRAS = [{ word: "tired", type: "adj", mean: "ç´¯çš„", isFocus: true }, { word: "angry", type: "adj", mean: "ç”Ÿæ°£çš„", isFocus: true }, { word: "strong", type: "adj", mean: "å¼·å£¯çš„", isFocus: true }, { word: "thin", type: "adj", mean: "ç˜¦çš„", isFocus: true }, { word: "short", type: "adj", mean: "çŸ­/çŸ®çš„", isFocus: true }, { word: "tall", type: "adj", mean: "é«˜çš„", isFocus: true }];

        const ITEMS_DB = {
            princess: {
                math: [
                    { id: 'pm1', name: 'æ•¸å­—æ¬Šæ–', icon: 'ğŸª„', type: 'weapon', effect: 'magic' }, { id: 'pm2', name: 'é‹ç®—ç‹å† ', icon: 'ğŸ‘‘', type: 'head' },
                    { id: 'pm3', name: 'åŠ æ³•ç²¾éˆ', icon: 'ğŸ§šâ€â™€ï¸', type: 'pet' }, { id: 'pm4', name: 'å¹¾ä½•è­·ç›¾', icon: 'ğŸ›¡ï¸', type: 'shield' },
                    { id: 'pm5', name: 'ç„¡é™å¯¶çŸ³', icon: 'ğŸ’', type: 'shield' }, { id: 'pm6', name: 'é‚è¼¯è²“å’ª', icon: 'ğŸ±', type: 'pet' },
                    { id: 'pm7', name: 'ä¸‰è§’ç¥å¼“', icon: 'ğŸ¹', type: 'weapon', effect: 'magic' }, { id: 'pm8', name: 'é‡è§’å™¨', icon: 'ğŸ“', type: 'shield' },
                    { id: 'pm9', name: 'é»ƒé‡‘ç®—ç›¤', icon: 'ğŸ§®', type: 'shield' }, { id: 'pm10', name: 'æ™ºæ…§è²“é ­é·¹', icon: 'ğŸ¦‰', type: 'pet' }
                ],
                english: [
                    { id: 'pe1', name: 'å–®å­—é­”æ–', icon: 'ğŸŒŸ', type: 'weapon', effect: 'magic' }, { id: 'pe2', name: 'èªæ³•å¸½', icon: 'ğŸ‘’', type: 'head' },
                    { id: 'pe3', name: 'ç¨è§’ç¸', icon: 'ğŸ¦„', type: 'pet' }, { id: 'pe4', name: 'å­—æ¯æ›¸', icon: 'ğŸ“–', type: 'shield' },
                    { id: 'pe5', name: 'ç™¼éŸ³é³¥', icon: 'ğŸ¦', type: 'pet' }, { id: 'pe6', name: 'æ•…äº‹å·è»¸', icon: 'ğŸ“œ', type: 'shield' },
                    { id: 'pe7', name: 'ç¾½æ¯›ç­†', icon: 'âœ’ï¸', type: 'weapon', effect: 'magic' }, { id: 'pe8', name: 'å½©è™¹èŠ±', icon: 'ğŸŒº', type: 'head' },
                    { id: 'pe9', name: 'å‚³èªªè±ç´', icon: 'ğŸµ', type: 'shield' }, { id: 'pe10', name: 'æœˆäº®å…”', icon: 'ğŸ‡', type: 'pet' }
                ]
            },
            hero: {
                math: [
                    { id: 'hm1', name: 'å…‰åŠ', icon: 'âš”ï¸', type: 'weapon', effect: 'slash' }, { id: 'hm2', name: 'å‹‡è€…é ­ç›”', icon: 'â›‘ï¸', type: 'head' },
                    { id: 'hm3', name: 'æ©Ÿæ¢°é¾', icon: 'ğŸ²', type: 'pet' }, { id: 'hm4', name: 'é‹¼éµç›¾', icon: 'ğŸ›¡ï¸', type: 'shield' },
                    { id: 'hm5', name: 'ç«ç®­é´', icon: 'ğŸš€', type: 'shield' }, { id: 'hm6', name: 'è¨ˆç®—æ©Ÿå™¨äºº', icon: 'ğŸ¤–', type: 'pet' },
                    { id: 'hm7', name: 'é›·ç¥æ§Œ', icon: 'ğŸ”¨', type: 'weapon', effect: 'slash' }, { id: 'hm8', name: 'èƒ½é‡æ‰‹å¥—', icon: 'ğŸ¥Š', type: 'weapon', effect: 'slash' },
                    { id: 'hm9', name: 'æˆ°è¡“çœ¼é¡', icon: 'ğŸ•¶ï¸', type: 'head' }, { id: 'hm10', name: 'å¤–æ˜Ÿå¯¶å¯¶', icon: 'ğŸ‘¾', type: 'pet' }
                ],
                english: [
                    { id: 'he1', name: 'ç¬¦æ–‡åŠ', icon: 'ğŸ—¡ï¸', type: 'weapon', effect: 'slash' }, { id: 'he2', name: 'ç¶­äº¬å¸½', icon: 'ğŸª–', type: 'head' },
                    { id: 'he3', name: 'æˆ°ç‹¼', icon: 'ğŸº', type: 'pet' }, { id: 'he4', name: 'çœŸç†ä¹‹ç›¾', icon: 'ğŸ›¡ï¸', type: 'shield' },
                    { id: 'he5', name: 'è€é·¹', icon: 'ğŸ¦…', type: 'pet' }, { id: 'he6', name: 'é­”æ³•åœ°åœ–', icon: 'ğŸ—ºï¸', type: 'shield' },
                    { id: 'he7', name: 'æµ·ç›œåˆ€', icon: 'ğŸ”ª', type: 'weapon', effect: 'slash' }, { id: 'he8', name: 'èˆ¹é•·å¸½', icon: 'ğŸ§¢', type: 'head' },
                    { id: 'he9', name: 'å¯¶è—ç®±', icon: 'ğŸ§³', type: 'shield' }, { id: 'he10', name: 'å¹½éˆå¤¥ä¼´', icon: 'ğŸ‘»', type: 'pet' }
                ]
            }
        };

        const getInitialVocab = (role) => {
            let list = [...BASE_VOCAB];
            if (role === 'daughter' || role === 'son') list = [...list, ...NUMBERS_1_10];
            if (role === 'son') {
                list = [...list, ...BROTHER_EXTRAS];
                list = list.map(v => (['happy','sad'].includes(v.word) ? { ...v, isFocus: true } : v));
            }
            const unique = []; const map = new Map();
            for (const item of list) {
                if(!map.has(item.word)){ map.set(item.word, true); unique.push(item); } 
                else if (item.isFocus) { const idx = unique.findIndex(u => u.word === item.word); unique[idx] = item; }
            }
            return unique;
        };

        const SCENARIOS = [
            { text: "å¤±ç«äº†ï¼å¿«å¹«å¿™æ»…ç«ï¼", emoji: "ğŸ”¥", type: "tense" }, { text: "æœ‰å°å·ï¼å¿«æŠ“ä½ä»–ï¼", emoji: "ğŸ¦¹", type: "tense" }, { text: "ç—…äººéœ€è¦æ€¥æ•‘ï¼", emoji: "ğŸš‘", type: "tense" }, { text: "å¤–é€è¨‚å–®å¿«é²åˆ°äº†ï¼", emoji: "ğŸ›µ", type: "happy" }, { text: "æˆ¿é–“å¤ªäº‚äº†ï¼", emoji: "ğŸ§¹", type: "happy" }, { text: "è‚šå­å¥½é¤“å–”ï¼", emoji: "ğŸ±", type: "happy" }, { text: "é‡ç”Ÿå™´ç«é¾å‡ºç¾ï¼", emoji: "ğŸ‰", type: "battle" }, { text: "ç™¼ç¾ç¥ç§˜å¯¶ç®±ï¼", emoji: "ğŸ’", type: "battle" }, { text: "æœ€å¾Œä¸€ç§’æŠ•ç±ƒï¼", emoji: "ğŸ€", type: "tense" }, { text: "å¹«çˆ¸çˆ¸æ¥èƒŒï¼", emoji: "ğŸ‘¨", type: "happy" }
        ];

        const getWeekId = () => {
            const d = new Date();
            const year = d.getFullYear();
            const firstJan = new Date(year, 0, 1);
            const week = Math.ceil((((d - firstJan) / 86400000) + firstJan.getDay() + 1) / 7);
            return `${year}-W${week}`;
        };

        const INITIAL_STATS_TEMPLATE = { 
            lastPlayedDate: '', lastWeekId: '', 
            dailyMathLevel: 0, dailyEnglishLevel: 0, dailyScore: 0, 
            allTimeBest: { score: 0, date: '-' }, weeklyHistory: [],
            earnedItems: [] 
        };
        
        const INITIAL_STATS = {
            daughter: { ...INITIAL_STATS_TEMPLATE },
            son: { ...INITIAL_STATS_TEMPLATE },
            mom: { ...INITIAL_STATS_TEMPLATE },
            challenger: { ...INITIAL_STATS_TEMPLATE }
        };

        const INITIAL_MATH_SETTINGS = { daughter: { slots: [{ range: 10, weight: 5 }, { range: 20, weight: 3 }, { range: 50, weight: 2 }] }, son: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } }, challenger: { weights: { '2-digit-add-sub': 5, '3-digit-add-sub': 2, '1-digit-mult': 3, '2-digit-mult': 1, 'div-exact': 2, 'div-remain': 1 } } };
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'å°å“æ¦•', avatar: 'ğŸ‘§', needPwd: true, theme: 'princess' }, 
            son: { id: 'son', name: 'å°æ™¨å¸Œ', avatar: 'ğŸ‘¦', needPwd: true, theme: 'hero' }, 
            mom: { id: 'mom', name: 'å°åª½åª½', avatar: 'ğŸ‘©', needPwd: true, theme: 'princess' }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', needPwd: false, theme: 'hero' } 
        };
        const PARENT_PASSWORD = "28825252";
        const FAMILY_PASSWORD = "168";

        let audioCtx = null;
        let musicInterval = null;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = (f, d, w = 'sine', v = 0.2) => { if (!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = w; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d); };
        const stopMusic = () => { if (musicInterval) clearInterval(musicInterval); };
        const playMusic = (style) => {
            stopMusic(); if (!audioCtx) return;
            let scale = [261, 329, 392, 523]; let tempo = 400; let wave = 'sine';
            if (style === 'battle') { scale = [130, 155, 196, 261]; tempo = 200; wave = 'sawtooth'; }
            else if (style === 'tense') { scale = [110, 116, 130]; tempo = 150; wave = 'square'; }
            musicInterval = setInterval(() => { if (Math.random() > 0.4) playTone(scale[Math.floor(Math.random() * scale.length)], tempo / 1000, wave); }, tempo);
        };
        const playSFX = (t) => { 
            if (!audioCtx) return; const n = audioCtx.currentTime; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
            if (t === 'attack') { o.frequency.setValueAtTime(200, n); o.frequency.linearRampToValueAtTime(800, n + 0.1); g.gain.setValueAtTime(0.4, n); o.start(); o.stop(n + 0.1); }
            else if (t === 'slash') { o.type='sawtooth'; o.frequency.setValueAtTime(100, n); o.frequency.linearRampToValueAtTime(600, n + 0.1); g.gain.setValueAtTime(0.4, n); o.start(); o.stop(n + 0.1); }
            else if (t === 'magic') { o.type='triangle'; o.frequency.setValueAtTime(600, n); o.frequency.exponentialRampToValueAtTime(1200, n + 0.3); g.gain.setValueAtTime(0.3, n); o.start(); o.stop(n + 0.3); }
            else if (t === 'win') { [0,0.1,0.2,0.4,0.5].forEach((s,i)=>{const o2=audioCtx.createOscillator();const g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.setValueAtTime(440+i*110,n+s);g2.gain.setValueAtTime(0.3,n+s);o2.start(n+s);o2.stop(n+s+0.3)}); }
            else if (t === 'item') { [0,0.1,0.2].forEach((s,i)=>{const o2=audioCtx.createOscillator();const g2=audioCtx.createGain();o2.type='sine';o2.frequency.setValueAtTime(800+i*200,n+s);g2.gain.setValueAtTime(0.3,n+s);o2.connect(g2);g2.connect(audioCtx.destination);o2.start(n+s);o2.stop(n+s+0.2)}); }
            else if (t === 'hurt') { o.type='sawtooth'; o.frequency.setValueAtTime(150, n); o.frequency.linearRampToValueAtTime(50, n + 0.4); g.gain.setValueAtTime(0.5, n); g.gain.linearRampToValueAtTime(0, n + 0.4); o.start(n); o.stop(n + 0.4); }
            else if (t === 'lose') { o.type='sawtooth'; o.frequency.setValueAtTime(100, n); o.frequency.linearRampToValueAtTime(20, n + 1.0); g.gain.setValueAtTime(0.3, n); g.gain.linearRampToValueAtTime(0, n + 1.0); o.start(n); o.stop(n + 1.0); }
        };
        const speakWord = (text) => { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u); } };

        const LucideIcon = ({ name, className, ...props }) => {
            const [IconComp, setIconComp] = useState(null);
            useEffect(() => { if (window.lucide && window.lucide.icons) { const camelName = name.replace(/-([a-z])/g, g => g[1].toUpperCase()); const PascalName = camelName.charAt(0).toUpperCase() + camelName.slice(1); setIconComp(window.lucide.icons[PascalName]); } }, [name]);
            return IconComp ? <IconComp className={className} {...props} /> : <span className={className}>?</span>;
        };

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [momMode, setMomMode] = useState('daughter');
            const [gameMode, setGameMode] = useState('math');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [vocabMap, setVocabMap] = useState({ daughter: getInitialVocab('daughter'), son: getInitialVocab('son'), mom: getInitialVocab('mom'), challenger: getInitialVocab('challenger') });
            const [mathSettings, setMathSettings] = useState(INITIAL_MATH_SETTINGS);
            const [rewards, setRewards] = useState({ levelRewards: {}, dailyScore: Array(5).fill({score:0, reward:""}) });
            const [audioStarted, setAudioStarted] = useState(false);
            
            const [dailyLevel, setDailyLevel] = useState(1);
            const [timer, setTimer] = useState(0);
            const [maxTime, setMaxTime] = useState(30);
            const [score, setScore] = useState(0);
            const [playerHp, setPlayerHp] = useState(100);
            const [hp, setHp] = useState(100);
            const [question, setQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [inputMode, setInputMode] = useState('select');
            const [scenario, setScenario] = useState(SCENARIOS[0]);
            
            const [animState, setAnimState] = useState('idle');
            const [effectText, setEffectText] = useState(null);
            const [newItem, setNewItem] = useState(null);

            const gameRuleKeyRef = useRef('daughter');
            const timerRef = useRef(null);

            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('fh_v6_github_items'));
                const currentWeek = getWeekId();
                const today = new Date().toISOString().split('T')[0];

                if (saved) { 
                    const loadedStats = { ...INITIAL_STATS, ...saved.stats };
                    Object.keys(loadedStats).forEach(key => {
                        const p = loadedStats[key];
                        if (p.lastWeekId !== currentWeek) { p.earnedItems = []; p.lastWeekId = currentWeek; }
                        if (p.lastPlayedDate !== today) { p.dailyScore = 0; p.lastPlayedDate = today; }
                    });
                    setStats(loadedStats); 
                    setVocabMap({ ...vocabMap, ...saved.vocabMap });
                    setMathSettings({ ...INITIAL_MATH_SETTINGS, ...saved.mathSettings });
                    setRewards(saved.rewards); 
                } else {
                    const initStats = { ...INITIAL_STATS };
                    Object.keys(initStats).forEach(k => { initStats[k].lastWeekId = currentWeek; initStats[k].lastPlayedDate = today; });
                    setStats(initStats);
                }
            }, []);

            useEffect(() => { localStorage.setItem('fh_v6_github_items', JSON.stringify({ stats, vocabMap, mathSettings, rewards })); }, [stats, vocabMap, mathSettings, rewards]);

            const pickWeighted = (options) => {
                const total = options.reduce((acc, cur) => acc + cur.weight, 0);
                if(total === 0) return options[0].item;
                let random = Math.random() * total;
                for (let opt of options) { if (random < opt.weight) return opt.item; random -= opt.weight; }
                return options[0].item;
            };

            const generateMathQuestion = (targetRole) => {
                const roleSettings = (targetRole === 'challenger') ? 'son' : targetRole;
                if (roleSettings === 'daughter') {
                    const range = pickWeighted(mathSettings.daughter.slots.map(s => ({ item: s.range, weight: s.weight })));
                    const n1 = Math.floor(Math.random() * range) + 1;
                    const n2 = Math.floor(Math.random() * range) + 1;
                    const op = Math.random() > 0.5 ? '+' : '-';
                    let ans, text;
                    if (op === '+') { ans = n1 + n2; text = `${n1} + ${n2} = ?`; } else { const b = Math.max(n1, n2), s = Math.min(n1, n2); ans = b - s; text = `${b} - ${s} = ?`; }
                    return { text, answer: ans.toString(), time: 30 };
                } else {
                    const settings = mathSettings[roleSettings] || mathSettings.son;
                    const mode = pickWeighted(Object.keys(settings.weights).map(k => ({ item: k, weight: settings.weights[k] })));
                    let n1, n2, ans, text, time = 60;
                    switch (mode) {
                        case 'div-exact': n2 = Math.floor(Math.random() * 8) + 2; ans = Math.floor(Math.random() * 9) + 1; n1 = n2 * ans; text = `${n1} Ã· ${n2} = ?`; ans = ans.toString(); break;
                        case 'div-remain': n2 = Math.floor(Math.random() * 8) + 2; const q = Math.floor(Math.random() * 9) + 1; const r = Math.floor(Math.random() * (n2 - 1)) + 1; n1 = (n2 * q) + r; text = `${n1} Ã· ${n2} = ?`; ans = `${q}r${r}`; time = 90; break;
                        case '2-digit-mult': n1 = Math.floor(Math.random() * 40) + 10; n2 = Math.floor(Math.random() * 20) + 10; ans = n1 * n2; text = `${n1} Ã— ${n2} = ?`; time = 120; break;
                        case '3-digit-add-sub': n1 = Math.floor(Math.random() * 900) + 100; n2 = Math.floor(Math.random() * 900) + 100; if (Math.random() > 0.5) { ans = n1 + n2; text = `${n1} + ${n2} = ?`; } else { ans = Math.max(n1, n2) - Math.min(n1, n2); text = `${Math.max(n1, n2)} - ${Math.min(n1, n2)} = ?`; } time = 90; break;
                        default: n1 = Math.floor(Math.random() * 90) + 10; n2 = Math.floor(Math.random() * 90) + 10; ans = Math.random() > 0.5 ? n1 + n2 : Math.max(n1, n2) - Math.min(n1, n2); text = Math.random() > 0.5 ? `${n1} + ${n2} = ?` : `${Math.max(n1, n2)} - ${Math.min(n1, n2)} = ?`; break;
                    }
                    return { text, answer: ans.toString(), time, isRemain: mode === 'div-remain' };
                }
            };

            const generateEnglishQuestion = (targetRole) => {
                const pool = vocabMap[targetRole] && vocabMap[targetRole].length > 0 ? vocabMap[targetRole] : BASE_VOCAB;
                const weightedPool = [];
                pool.forEach(w => { weightedPool.push(w); if (w.isFocus) { weightedPool.push(w); weightedPool.push(w); } });
                const wordObj = weightedPool[Math.floor(Math.random() * weightedPool.length)];
                
                const templates = SENTENCE_TEMPLATES[wordObj.type] || SENTENCE_TEMPLATES['noun'];
                const template = templates[Math.floor(Math.random() * templates.length)];
                let finalText = template.text;
                let finalDisplay = template.text.replace('___', '_____');
                
                if (finalText.includes("a ___")) {
                    if (wordObj.u) { finalText = finalText.replace("a ___", "some ___"); } 
                    else if (wordObj.unique) { finalText = finalText.replace("a ___", "the ___"); } 
                    else if (['a','e','i','o','u'].includes(wordObj.word[0].toLowerCase())) { finalText = finalText.replace("a ___", "an ___"); } 
                }
                const fullSentence = finalText.replace('___', wordObj.word);
                const distractors = pool.filter(w => w.word !== wordObj.word).sort(() => 0.5 - Math.random()).slice(0, 3).map(w => w.word);
                while(distractors.length < 3) distractors.push(["sun", "red", "run", "eye"][distractors.length]);
                const options = [wordObj.word, ...distractors].sort(() => 0.5 - Math.random());
                return { text: finalText, fullSentence: fullSentence, answer: wordObj.word, display: finalDisplay, hint: `${wordObj.mean} (${template.hint})`, options, time: 30, wordObj };
            };

            const handleCharSelect = (id) => {
                setPlayerKey(id); // æ”¹ç‚ºç›´æ¥åˆ‡æ›ï¼Œä¸éœ€å¯†ç¢¼
            };

            const handleStart = (mode) => {
                // é€²å…¥æˆ°é¬¥æ‰éœ€è¦å¯†ç¢¼
                if (CHARACTERS[playerKey].needPwd) {
                    const pwd = prompt("è«‹è¼¸å…¥å®¶äººå¯†ç¢¼ï¼š");
                    if (pwd !== FAMILY_PASSWORD) {
                        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                        return;
                    }
                }

                initAudio(); setAudioStarted(true);
                const p = stats[playerKey];
                const myLv = mode === 'daily_math' ? p.dailyMathLevel : p.dailyEnglishLevel;
                const otherLv = mode === 'daily_math' ? p.dailyEnglishLevel : p.dailyMathLevel;
                if (myLv > 0 && myLv % 20 === 0 && otherLv < myLv) { alert(`ğŸš§ éšæ®µæ€§æŒ‘æˆ°ï¼è«‹å…ˆæŠŠå¦ä¸€ç§‘ç›®çš„æŒ‘æˆ°(ç›®å‰ Lv.${otherLv})è¿½ä¸Šä¾†åˆ° Lv.${myLv} æ‰èƒ½è§£é–ä¸‹ä¸€éšæ®µå–”ï¼`); return; }
                
                const ruleKey = (playerKey === 'mom' || playerKey === 'challenger') ? momMode : playerKey;
                gameRuleKeyRef.current = ruleKey;
                setGameMode(mode); setPlayerHp(100); setHp(100); setScore(p.dailyScore);
                const startLv = Math.floor(myLv / 10) * 10 + 1;
                setDailyLevel(startLv); nextTurn(mode); setScreen('game');
            };

            const nextTurn = (mode) => {
                setAnimState('idle'); setEffectText(null);
                const currentRuleKey = gameRuleKeyRef.current;
                const q = mode.includes('math') ? generateMathQuestion(currentRuleKey) : generateEnglishQuestion(currentRuleKey);
                setQuestion(q); setTimer(q.time); setMaxTime(q.time); setUserAnswer(''); setFeedback(null); setHp(100);
                const sc = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
                setScenario(sc); playMusic(sc.type);
                if (mode.includes('english')) setTimeout(() => speakWord(q.fullSentence), 500);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => setTimer(t => t > 0 ? t - 1 : 0), 1000);
            };

            const checkItemDrop = (currentLevel) => {
                if (currentLevel > 0 && currentLevel % 10 === 0) {
                    const theme = CHARACTERS[playerKey].theme;
                    const type = gameMode.includes('math') ? 'math' : 'english';
                    const pool = ITEMS_DB[theme][type];
                    const pStats = stats[playerKey];
                    const earned = pStats.earnedItems || [];
                    const available = pool.filter(i => !earned.includes(i.id));
                    if (available.length > 0) {
                        const drop = available[Math.floor(Math.random() * available.length)];
                        const newStats = { ...stats };
                        if (!newStats[playerKey].earnedItems) newStats[playerKey].earnedItems = [];
                        newStats[playerKey].earnedItems.push(drop.id);
                        setStats(newStats);
                        setNewItem(drop); playSFX('item');
                        setTimeout(() => setNewItem(null), 3000);
                    }
                }
            };

            const handleAnswer = (val) => {
                clearInterval(timerRef.current);
                const target = question.answer.toLowerCase();
                const input = val.trim().toLowerCase();
                let isCorrect = question.isRemain ? input.replace(/[\.\s]+/g, 'r') === target : input === target;
                
                const myItems = stats[playerKey].earnedItems || [];
                const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
                const weapon = allItems.find(i => myItems.includes(i.id) && i.type === 'weapon');
                const effectType = weapon ? weapon.effect : 'attack';

                if (isCorrect) { 
                    playSFX(effectType); 
                    setAnimState('attack'); setEffectText("ğŸ’¥ POW!");
                    setScore(s => s + timer * 10); 
                    setFeedback('correct'); 
                    if(question.wordObj) speakWord(question.fullSentence); 
                } else { 
                    playSFX('hurt'); 
                    setAnimState('hurt'); setEffectText("ğŸ˜µ OUCH!");
                    setPlayerHp(h => h - 34); 
                    setFeedback('wrong'); 
                }
                
                setTimeout(() => {
                    if (playerHp <= (isCorrect ? 0 : 34)) {
                        setAnimState('dead'); playSFX('lose'); setTimeout(()=>setScreen('result'), 1000);
                    } else if (isCorrect) {
                        if (dailyLevel % 10 === 0) {
                            checkItemDrop(dailyLevel);
                            setAnimState('victory'); playSFX('grand_win');
                            const newStats = { ...stats };
                            if (gameMode === 'daily_math') newStats[playerKey].dailyMathLevel = dailyLevel;
                            else newStats[playerKey].dailyEnglishLevel = dailyLevel;
                            setStats(newStats); 
                            setTimeout(()=>setScreen('result'), 2000);
                        } else { setDailyLevel(l => l + 1); nextTurn(gameMode); }
                    } else {
                        setAnimState('idle'); setEffectText(null); nextTurn(gameMode);
                    }
                }, 1500);
            };

            const enterSettings = () => { const p = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š"); if (p === PARENT_PASSWORD) setScreen('settings'); else alert("å¯†ç¢¼éŒ¯èª¤"); };

            const Particles = () => <div className="absolute inset-0 pointer-events-none">{[...Array(20)].map((_,i)=><div key={i} className="particle" style={{left:'50%',top:'50%',backgroundColor:['#f00','#0f0','#00f','#ff0','#f0f'][Math.floor(Math.random()*5)],'--x':(Math.random()*400-200)+'px','--initialY':(Math.random()*200-100)+'px','--initialSize':(Math.random()*0.5+0.2)+'rem','--finalSize':'0rem'}}/>)}</div>;

            const ItemDisplay = ({ items }) => {
                if (!items || items.length === 0) return null;
                const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
                const myGear = allItems.filter(i => items.includes(i.id));
                return (
                    <>
                        {myGear.map(item => {
                            let className = '';
                            if (item.type === 'weapon') className = 'item-slot-weapon';
                            else if (item.type === 'head') className = 'item-slot-head';
                            else if (item.type === 'pet') className = 'item-slot-pet';
                            else className = 'item-slot-shield';
                            const style = item.type === 'pet' ? { left: `-${Math.random()*20+30}px` } : {};
                            return <div key={item.id} className={className} style={style}>{item.icon}</div>;
                        })}
                    </>
                );
            };

            const VocabSettings = ({ charKey }) => {
                const [input, setInput] = useState({ word: '', mean: '', type: 'noun' });
                const list = vocabMap[charKey] || [];
                const add = () => { if(!input.word) return; const newItem = { ...input, isFocus: false }; const newList = [...list, newItem]; setVocabMap({ ...vocabMap, [charKey]: newList }); setInput({ word: '', mean: '', type: 'noun' }); };
                const remove = (idx) => { const newList = [...list]; newList.splice(idx, 1); setVocabMap({ ...vocabMap, [charKey]: newList }); };
                const toggleFocus = (idx) => { const newList = [...list]; newList[idx] = { ...newList[idx], isFocus: !newList[idx].isFocus }; setVocabMap({ ...vocabMap, [charKey]: newList }); };
                return (
                    <div className="bg-white/5 p-4 rounded-xl mt-4">
                        <div className="flex gap-2 mb-2">
                            <input value={input.word} onChange={e=>setInput({...input, word:e.target.value})} placeholder="è‹±æ–‡" className="w-1/3 bg-black/40 p-2 rounded text-sm"/>
                            <input value={input.mean} onChange={e=>setInput({...input, mean:e.target.value})} placeholder="ä¸­æ–‡" className="w-1/3 bg-black/40 p-2 rounded text-sm"/>
                            <select value={input.type} onChange={e=>setInput({...input, type:e.target.value})} className="bg-black/40 p-2 rounded text-sm"><option value="noun">åè©</option><option value="verb">å‹•è©</option><option value="adj">å½¢å®¹è©</option><option value="number">æ•¸å­—</option></select>
                            <button onClick={add} className="bg-green-600 px-3 rounded"><LucideIcon name="plus" size={16}/></button>
                        </div>
                        <div className="max-h-60 overflow-y-auto space-y-2">
                            {list.map((v, i) => (
                                <div key={i} className={`flex justify-between items-center p-2 rounded ${v.isFocus ? 'bg-yellow-500/20 border border-yellow-500/50' : 'bg-black/30'}`}>
                                    <div className="flex items-center gap-2"><button onClick={()=>toggleFocus(i)} className={`text-xl ${v.isFocus ? 'opacity-100' : 'opacity-30 grayscale'}`}>â­</button><span className="font-bold text-blue-300">{v.word}</span><span className="text-xs text-gray-400">{v.mean}</span></div>
                                    <button onClick={()=>remove(i)} className="text-gray-500 hover:text-red-500"><LucideIcon name="trash-2" size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const MathSettings = ({ charKey }) => {
                const isDaughter = charKey === 'daughter';
                const settings = mathSettings[charKey] || (isDaughter ? INITIAL_MATH_SETTINGS.daughter : INITIAL_MATH_SETTINGS.son);
                const updateSlot = (idx, field, val) => { const newS = { ...mathSettings }; newS.daughter.slots[idx][field] = parseInt(val) || 0; setMathSettings(newS); };
                const updateWeight = (key, val) => { const newS = { ...mathSettings }; if (!newS[charKey]) newS[charKey] = { weights: { ...INITIAL_MATH_SETTINGS.son.weights } }; newS[charKey].weights[key] = parseInt(val) || 0; setMathSettings(newS); };
                
                // é¡¯ç¤ºå¥³å…’çš„æ•¸å­¸è¨­å®šä»‹é¢
                if (isDaughter) {
                    return (
                        <div className="bg-white/5 p-4 rounded-xl mt-4 space-y-2">
                            {settings.slots.map((s, i) => (<div key={i} className="flex items-center gap-2 bg-black/20 p-2 rounded"><span className="text-gray-400 font-bold">#{i+1}</span><input type="number" value={s.range} onChange={e=>updateSlot(i,'range',e.target.value)} className="w-16 bg-black/40 text-center rounded p-1"/><span className="text-xs">ä»¥å…§</span><input type="range" max="10" value={s.weight} onChange={e=>updateSlot(i,'weight',e.target.value)} className="flex-1"/><span className="w-4 text-center text-pink-400 font-bold">{s.weight}</span></div>))}
                        </div>
                    );
                } else {
                    // é¡¯ç¤ºå…’å­æˆ–æŒ‘æˆ°è€…çš„æ•¸å­¸è¨­å®šä»‹é¢ (ä½¿ç”¨ç›¸åŒçš„ weights çµæ§‹)
                    const weights = settings.weights || INITIAL_MATH_SETTINGS.son.weights;
                    const labels = { '2-digit-add-sub': '2ä½æ•¸åŠ æ¸›', '3-digit-add-sub': '3ä½æ•¸åŠ æ¸›', '1-digit-mult': '2ä½x1ä½ä¹˜', '2-digit-mult': '2ä½x2ä½ä¹˜', 'div-exact': 'æ•´é™¤', 'div-remain': 'é¤˜æ•¸' };
                    return (
                        <div className="bg-white/5 p-4 rounded-xl mt-4 grid grid-cols-1 gap-2">
                            {Object.keys(weights).map(k => (<div key={k} className="flex items-center justify-between bg-black/20 p-2 rounded"><span className="text-xs text-gray-300">{labels[k]}</span><div className="flex items-center gap-2 w-32"><input type="range" max="10" value={weights[k]} onChange={e=>updateWeight(k,e.target.value)} className="flex-1"/><span className="w-4 text-center text-blue-400 font-bold">{weights[k]}</span></div></div>))}
                        </div>
                    );
                }
            };

            const [settingTab, setSettingTab] = useState('vocab');
            const [settingChar, setSettingChar] = useState('daughter');

            return (
                <div className={`w-full h-screen flex flex-col overflow-hidden relative ${timer < 5 && screen === 'game' ? 'bg-red-900/50' : 'bg-indigo-900'} transition-colors duration-500`}>
                    {newItem && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 animate-pop">
                            <div className="bg-gradient-to-b from-yellow-400 to-orange-500 p-8 rounded-3xl text-center border-4 border-white shadow-2xl">
                                <h3 className="text-2xl font-black text-white mb-4">ğŸ‰ ç²å¾—æ–°å¯¶ç‰©ï¼</h3>
                                <div className="text-8xl mb-4 animate-bounce">{newItem.icon}</div>
                                <div className="text-3xl font-bold text-black">{newItem.name}</div>
                                <div className="text-sm text-white mt-2 font-bold opacity-80">æ¯é€±é‡ç½®ï¼Œè¶•å¿«æ”¶é›†ï¼</div>
                            </div>
                        </div>
                    )}

                    {screen === 'menu' && !audioStarted && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={()=>{initAudio(); setAudioStarted(true); playMusic('menu');}}>
                            <div className="text-center animate-pulse"><div className="text-6xl mb-4">ğŸµ</div><h2 className="text-2xl font-bold text-white">é»æ“Šç•«é¢é–‹å§‹éŠæˆ²</h2><p className="text-gray-400 text-sm mt-2">é–‹å•ŸéŸ³æ•ˆèˆ‡èƒŒæ™¯éŸ³æ¨‚</p></div>
                        </div>
                    )}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center justify-center h-full relative z-10">
                            <h1 className="text-4xl font-black text-yellow-400 mb-6 drop-shadow-lg">âš”ï¸ å°å®¶è‹±é›„æ¦œ âš”ï¸</h1>
                            <div className="grid grid-cols-4 gap-2 mb-6 bg-black/20 p-2 rounded-xl w-full max-w-lg">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={() => handleCharSelect(c.id)} className={`flex flex-col items-center justify-center py-2 rounded-lg transition-all ${playerKey === c.id ? 'bg-yellow-500 text-black scale-105 shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}>
                                        <span className="text-2xl mb-1">{c.avatar}</span>
                                        <span className="text-xs font-bold">{c.name}</span>
                                        {c.subName && <span className="text-[10px] scale-75 block text-green-300">{c.subName}</span>}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-white/10 p-6 rounded-[2.5rem] border-4 border-white/20 flex flex-col items-center backdrop-blur-sm w-full max-w-sm mb-6 relative">
                                <div className="relative">
                                    <div className="text-7xl mb-2 animate-breathe">{CHARACTERS[playerKey].avatar}</div>
                                    <ItemDisplay items={stats[playerKey].earnedItems} />
                                </div>
                                {(playerKey === 'mom' || playerKey === 'challenger') && (
                                    <div className="flex bg-black/30 rounded-full p-1 mb-4 w-full text-sm font-bold">
                                        <button onClick={() => setMomMode('daughter')} className={`flex-1 py-1 rounded-full transition-all ${momMode === 'daughter' ? 'bg-pink-600 text-white' : 'text-gray-400'}`}>æ¸¬å¦¹å¦¹</button>
                                        <button onClick={() => setMomMode('son')} className={`flex-1 py-1 rounded-full transition-all ${momMode === 'son' ? 'bg-blue-600 text-white' : 'text-gray-400'}`}>æ¸¬å“¥å“¥</button>
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-3 w-full mt-4">
                                    <button onClick={() => handleStart('daily_math')} className="bg-orange-500 p-4 rounded-2xl font-bold flex flex-col items-center relative shadow-lg active:translate-y-1 transition-all hover:bg-orange-400"><LucideIcon name="calculator" className="mb-1 w-6 h-6"/><span>æŒ‘æˆ°æ•¸å­¸</span><div className="text-xs opacity-70 bg-black/20 px-2 rounded-full mt-1">Lv.{stats[playerKey].dailyMathLevel}</div></button>
                                    <button onClick={() => handleStart('daily_english')} className="bg-blue-500 p-4 rounded-2xl font-bold flex flex-col items-center relative shadow-lg active:translate-y-1 transition-all hover:bg-blue-400"><LucideIcon name="languages" className="mb-1 w-6 h-6"/><span>æŒ‘æˆ°è‹±æ–‡</span><div className="text-xs opacity-70 bg-black/20 px-2 rounded-full mt-1">Lv.{stats[playerKey].dailyEnglishLevel}</div></button>
                                </div>
                            </div>
                            <div className="flex gap-6 text-sm font-bold text-gray-400">
                                <button onClick={() => setScreen('vocab')} className="flex items-center gap-1 hover:text-white bg-white/5 px-4 py-2 rounded-full"><LucideIcon name="book-open" className="w-4 h-4"/> å–®å­—æœ¬</button>
                                <button onClick={enterSettings} className="flex items-center gap-1 hover:text-white bg-white/5 px-4 py-2 rounded-full"><LucideIcon name="settings-2" className="w-4 h-4"/> ç®¡ç†ä¸­å¿ƒ</button>
                            </div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="h-full flex flex-col bg-slate-900/50 text-white relative z-10">
                            <div className="p-4 flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-white/10">
                                <div className="flex items-center gap-2">
                                    <div className="text-3xl relative">
                                        {CHARACTERS[playerKey].avatar}
                                        <div className="absolute -top-1 -right-1 text-xs">{stats[playerKey].earnedItems && stats[playerKey].earnedItems.length > 0 ? 'ğŸ‘‘' : ''}</div>
                                    </div>
                                    <div className="h-4 w-28 bg-gray-700 rounded-full overflow-hidden border border-gray-500 relative">
                                        <div className={`h-full transition-all duration-300 ${playerHp < 30 ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`} style={{width: `${playerHp}%`}}/>
                                        <span className="absolute inset-0 flex items-center justify-center text-[10px] font-bold">HP {Math.round(playerHp)}</span>
                                    </div>
                                </div>
                                <div className={`text-center font-mono transition-all ${timer < 5 ? 'scale-125 text-red-500 animate-heartbeat' : ''}`}>
                                    <div className="text-yellow-400 text-xs uppercase font-bold tracking-wider">LEVEL {dailyLevel}</div>
                                    <div className="text-4xl font-bold">{timer}</div>
                                </div>
                                <div className="text-right"><div className="text-3xl">{scenario.emoji}</div></div>
                            </div>
                            <div className="w-full h-2 bg-gray-800"><div className="h-full transition-all duration-1000 ease-linear" style={{width: `${(timer/maxTime)*100}%`, backgroundColor: timer < 5 ? '#ef4444' : (timer < 10 ? '#fbbf24' : '#10b981')}}/></div>
                            <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                                <div className="absolute top-10 w-full flex justify-between px-10 pointer-events-none opacity-80">
                                    <div className={`text-9xl transition-transform duration-300 relative ${animState==='attack'?'animate-attack-right':''} ${animState==='hurt'?'animate-damage':''} ${animState==='dead'?'animate-dead':'animate-breathe'}`}>
                                        {CHARACTERS[playerKey].avatar}
                                        <ItemDisplay items={stats[playerKey].earnedItems} />
                                    </div>
                                    <div className={`text-9xl transition-transform duration-300 ${animState==='hurt'?'animate-attack-left':''} ${animState==='attack'?'animate-damage':''}`}>{scenario.emoji}</div>
                                </div>
                                {effectText && <div className="absolute top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black text-yellow-300 drop-shadow-lg animate-float-up z-20">{effectText}</div>}
                                <div className={`bg-white/10 backdrop-blur-lg p-8 rounded-[2rem] w-full max-w-xl text-center border border-white/20 shadow-2xl relative overflow-hidden transition-all ${feedback ? 'scale-105' : ''}`}>
                                    <h3 className="text-blue-300 text-sm font-bold mb-4 uppercase tracking-widest bg-black/30 inline-block px-3 py-1 rounded-full">{gameMode.includes('math') ? 'MATH MISSION' : `ENGLISH: ${question.hint}`}</h3>
                                    <h2 className="text-4xl md:text-5xl font-black mb-8 leading-tight drop-shadow-md">{gameMode.includes('math') ? question.text : question.display}</h2>
                                    {gameMode.includes('english') && inputMode === 'select' ? (<div className="grid grid-cols-2 gap-4">{question.options.map(opt => (<button key={opt} onClick={()=>handleAnswer(opt)} className="bg-white/10 hover:bg-indigo-600 py-4 rounded-2xl text-xl font-bold border-2 border-white/10 active:scale-95 transition-all shadow-lg">{opt}</button>))}</div>) : (<div className="flex gap-2"><input value={userAnswer} onChange={e => setUserAnswer(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAnswer(userAnswer)} placeholder="è¼¸å…¥ç­”æ¡ˆ..." className="flex-1 bg-black/50 border-2 border-white/30 p-4 text-3xl rounded-xl text-center outline-none focus:border-yellow-400 transition-colors text-white placeholder-gray-600" autoFocus type={gameMode.includes('math') && !question.isRemain ? "tel" : "text"} /><button onClick={() => handleAnswer(userAnswer)} className="bg-yellow-400 text-black px-8 rounded-xl font-black text-xl shadow-lg active:scale-95">GO</button></div>)}
                                    {gameMode.includes('english') && (<div className="mt-8 flex justify-center gap-2 text-xs font-bold"><button onClick={()=>setInputMode('select')} className={`px-4 py-2 rounded-full transition-colors ${inputMode==='select'?'bg-blue-600 text-white':'bg-white/10 text-gray-400'}`}>é¸æ“‡é¡Œ</button><button onClick={()=>setInputMode('type')} className={`px-4 py-2 rounded-full transition-colors ${inputMode==='type'?'bg-purple-600 text-white':'bg-white/10 text-gray-400'}`}>æ‹¼å­—é¡Œ (åŠ åˆ†)</button></div>)}
                                </div>
                            </div>
                        </div>
                    )}

                    {screen === 'vocab' && (
                        <div className="h-full bg-slate-900 p-6 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4"><h2 className="text-2xl font-bold flex items-center gap-2">ğŸ“– å–®å­—æœ¬</h2><button onClick={() => setScreen('menu')} className="bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold">è¿”å›</button></div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">{(vocabMap[playerKey]||BASE_VOCAB).map((v, i) => (<div key={i} onClick={()=>speakWord(v.word)} className={`bg-white/10 p-4 rounded-xl cursor-pointer hover:bg-white/20 border border-white/5 transition-colors active:scale-95 ${v.isFocus ? 'border-yellow-500/50 bg-yellow-500/10' : ''}`}><div className="flex justify-between items-start"><div className="font-bold text-blue-300 text-lg mb-1">{v.word}</div>{v.isFocus && <span className="text-yellow-500">â­</span>}</div><div className="text-sm text-gray-400">{v.mean}</div></div>))}</div>
                        </div>
                    )}

                    {screen === 'settings' && (
                        <div className="h-full p-6 bg-slate-900 overflow-y-auto">
                            <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4"><h2 className="text-2xl font-bold text-yellow-400 flex items-center gap-2">âš™ï¸ å®¶é•·ç®¡ç†ä¸­å¿ƒ</h2><button onClick={() => setScreen('menu')} className="bg-gray-700 px-4 py-2 rounded-lg text-sm font-bold">é€€å‡º</button></div>
                            <div className="flex gap-2 mb-4 bg-black/20 p-1 rounded-lg overflow-x-auto scrollbar-hide">{Object.values(CHARACTERS).map(c => (<button key={c.id} onClick={()=>setSettingChar(c.id)} className={`flex-1 py-2 px-3 whitespace-nowrap rounded font-bold ${settingChar===c.id ? 'bg-indigo-600 text-white':'text-gray-400'}`}>{c.name}</button>))}</div>
                            <div className="flex gap-2 mb-4"><button onClick={()=>setSettingTab('vocab')} className={`flex-1 py-2 rounded border border-white/10 ${settingTab==='vocab'?'bg-blue-600':'bg-white/5'}`}>ğŸ“š å–®å­—è¨­å®š (â­é‡é»)</button><button onClick={()=>setSettingTab('math')} className={`flex-1 py-2 rounded border border-white/10 ${settingTab==='math'?'bg-orange-600':'bg-white/5'}`}>ğŸ”¢ æ•¸å­¸é›£åº¦</button></div>
                            {settingTab === 'vocab' && <VocabSettings charKey={settingChar} />}
                            {settingTab === 'math' && <MathSettings charKey={settingChar} />}
                        </div>
                    )}

                    {screen === 'result' && (
                        <div className={`h-full flex flex-col items-center justify-center p-8 text-center animate-in fade-in zoom-in duration-500 ${animState==='dead' ? 'grayscale' : ''}`}>
                            {dailyLevel % 10 === 0 && playerHp > 0 ? (
                                <><Particles/><div className="text-8xl mb-4 animate-bounce">ğŸ†</div><h2 className="text-5xl font-black text-yellow-400 mb-4 drop-shadow-lg">å¤§ç²å…¨å‹ï¼</h2><p className="text-gray-300 mb-10 text-xl font-bold">æ­å–œé€šéç¬¬ <span className="text-white text-3xl">{dailyLevel}</span> é—œ</p></>
                            ) : (<><div className="text-8xl mb-4 text-gray-500">ğŸ’€</div><h2 className="text-4xl font-black text-gray-400 mb-4">å†æ¥å†å²...</h2><p className="text-gray-500 mb-10 text-xl">è‹±é›„ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†ä¾†æŒ‘æˆ°ï¼</p></>)}
                            <button onClick={() => setScreen('menu')} className="bg-white text-indigo-900 px-16 py-5 rounded-2xl font-black text-2xl shadow-2xl hover:scale-105 transition-all">è¿”å›åŸºåœ°</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
