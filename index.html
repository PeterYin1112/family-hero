<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å®¶è‹±é›„æ¦œï¼šæ€ªç¸å¤§è¨ä¼ (Safe)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase (æš«æ™‚è¨»è§£æ‰è‡ªå‹•åŸ·è¡Œï¼Œé¿å…é€£ç·šéŒ¯èª¤å°è‡´ç™½å±) -->
    <!-- 
    <script type="module">
        // Firebase code moved inside React to control execution
    </script> 
    -->

    <style>
        body { background-color: #0f172a; color: white; margin: 0; font-family: system-ui; overflow: hidden; user-select: none; }
        .char-container { position: relative; width: 100px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        .char-head { font-size: 3.5rem; z-index: 10; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }
        .char-body { width: 36px; height: 45px; border-radius: 8px; position: relative; z-index: 5; margin-top: -10px; }
        .char-body.princess { background: linear-gradient(180deg, #ec4899, #be185d); }
        .char-body.hero { background: linear-gradient(180deg, #3b82f6, #1d4ed8); }
        .char-limb { width: 8px; height: 25px; background: #fda4af; position: absolute; border-radius: 4px; }
        .arm-l { left: -6px; top: 5px; transform: rotate(20deg); }
        .arm-r { right: -6px; top: 5px; transform: rotate(-20deg); }
        .leg-l { left: 8px; bottom: -20px; height: 32px; background: #334155; }
        .leg-r { right: 8px; bottom: -20px; height: 32px; background: #334155; }
        .slot-weapon { position: absolute; top: 30px; right: -25px; font-size: 2rem; z-index: 20; transform: rotate(-15deg); }
        .slot-hat { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 2rem; z-index: 20; }
        .slot-pet { position: absolute; bottom: 0; left: -40px; font-size: 1.8rem; }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-pulse-fast { animation: pulse 1s infinite; }
        @keyframes shake { 0% { transform: translate(0,0); } 25% { transform: translate(-5px,0); } 75% { transform: translate(5px,0); } 100% { transform: translate(0,0); } }
        .animate-shake { animation: shake 0.3s; }
        
        .bg-forest { background: linear-gradient(#14532d, #064e3b); }
        .bg-ice-castle { background: linear-gradient(#1e3a8a, #082f49); }
        .bg-beetle-forest { background: linear-gradient(#064e3b, #022c22); }
        .bg-desert { background: linear-gradient(#7c2d12, #451a03); }
        .bg-volcano { background: linear-gradient(#7f1d1d, #450a0a); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- Error Boundary ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen flex flex-col items-center justify-center bg-red-900 text-white p-8 overflow-auto">
                            <h1 className="text-3xl font-bold mb-4">âš ï¸ éŠæˆ²ç™¼ç”ŸéŒ¯èª¤</h1>
                            <p className="mb-2">è«‹æˆªåœ–æ­¤ç•«é¢çµ¦é–‹ç™¼è€… (Jules)ï¼š</p>
                            <pre className="bg-black p-4 rounded text-xs mb-4 text-left max-w-full overflow-x-auto">
                                {this.state.error && this.state.error.toString()}
                                <br/>
                                {this.state.error && this.state.error.stack}
                            </pre>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-white text-red-900 px-6 py-3 rounded-xl font-bold">
                                æ¸…é™¤å­˜æª”ä¸¦é‡è©¦
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- Data ---
        const CHARACTERS = { 
            daughter: { id: 'daughter', name: 'å†°é›ªå¥³ç‹æ¦•', avatar: 'ğŸ‘¸', theme: 'princess', color: 'text-cyan-300', bg: 'bg-ice-castle', attackType: 'ice', needPwd: true }, 
            son: { id: 'son', name: 'ç”²èŸ²ç‹è€…å¸Œ', avatar: 'ğŸ‘¦', theme: 'hero', color: 'text-green-400', bg: 'bg-beetle-forest', attackType: 'beetle', needPwd: true }, 
            mom: { id: 'mom', name: 'ç¥åŠ›å¥³è¶…äºº', avatar: 'ğŸ‘©', theme: 'princess', color: 'text-yellow-400', bg: 'bg-desert', attackType: 'magic', needPwd: true }, 
            challenger: { id: 'challenger', name: 'æŒ‘æˆ°è€…', subName: '(å…å¯†ç¢¼)', avatar: 'ğŸ¦¸', theme: 'hero', color: 'text-blue-400', bg: 'bg-volcano', attackType: 'slash', needPwd: false } 
        };

        const BASE_VOCAB = [
            { word: "cat", type: "noun", mean: "è²“" }, { word: "dog", type: "noun", mean: "ç‹—" },
            { word: "apple", type: "noun", mean: "è˜‹æœ" }, { word: "book", type: "noun", mean: "æ›¸" }
        ];

        const ITEMS_DB = {
            princess: { math: [{id:'pm1', icon:'ğŸª„', type:'weapon'}, {id:'pm2', icon:'ğŸ‘‘', type:'head'}], english: [{id:'pe1', icon:'ğŸŒŸ', type:'weapon'}, {id:'pe2', icon:'ğŸ‘’', type:'head'}] },
            hero: { math: [{id:'hm1', icon:'âš”ï¸', type:'weapon'}, {id:'hm2', icon:'â›‘ï¸', type:'head'}], english: [{id:'he1', icon:'ğŸ—¡ï¸', type:'weapon'}, {id:'he2', icon:'ğŸ§¢', type:'head'}] }
        };

        const INITIAL_STATS = { daughter: { dailyScore: 0, earnedItems: [] }, son: { dailyScore: 0, earnedItems: [] }, mom: { dailyScore: 0, earnedItems: [] }, challenger: { dailyScore: 0, earnedItems: [] } };
        
        // --- Audio ---
        let audioCtx = null;
        const initAudio = () => { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){console.warn("Audio init failed");} } if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); };
        const playTone = () => { if(!audioCtx) return; try { const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1); } catch(e){} };

        // --- Components ---
        const FullBodyChar = ({ charId, items }) => {
            const char = CHARACTERS[charId] || CHARACTERS.daughter;
            const theme = char.theme || 'hero';
            
            // Safe check for items
            const safeItems = Array.isArray(items) ? items : [];
            const allItems = [...ITEMS_DB.princess.math, ...ITEMS_DB.princess.english, ...ITEMS_DB.hero.math, ...ITEMS_DB.hero.english];
            
            // Find gear safely
            const hat = allItems.find(i => safeItems.includes(i.id) && i.type === 'head');
            const weapon = allItems.find(i => safeItems.includes(i.id) && i.type === 'weapon');
            
            return (
                <div className="char-container">
                    {hat && <div className="slot-hat">{hat.icon}</div>}
                    <div className="char-head">{char.avatar}</div>
                    <div className={`char-body ${theme}`}>
                        <div className="char-limb arm-l"></div><div className="char-limb arm-r"></div><div className="char-limb leg-l"></div><div className="char-limb leg-r"></div>
                    </div>
                    {weapon && <div className="slot-weapon">{weapon.icon}</div>}
                </div>
            );
        };

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerKey, setPlayerKey] = useState('daughter');
            const [stats, setStats] = useState(INITIAL_STATS);
            const [audioEnabled, setAudioEnabled] = useState(false);

            // Init Data
            useEffect(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('fh_v16_debug'));
                    if (saved && saved.stats) {
                        // Merge to prevent missing keys
                        const safeStats = { ...INITIAL_STATS };
                        Object.keys(INITIAL_STATS).forEach(k => {
                            if (saved.stats[k]) safeStats[k] = { ...INITIAL_STATS[k], ...saved.stats[k] };
                        });
                        setStats(safeStats);
                    }
                } catch (e) {
                    console.error("Load Error", e);
                }
            }, []);

            const toggleAudio = () => {
                try { initAudio(); setAudioEnabled(true); playTone(); } catch(e) { console.error("Audio Error", e); }
            };

            const startGame = () => {
                if(!audioEnabled) toggleAudio();
                setScreen('game');
            };

            const char = CHARACTERS[playerKey] || CHARACTERS.daughter;

            return (
                <div className={`w-full h-screen flex flex-col items-center justify-center relative ${char.bg} transition-colors duration-500`}>
                    
                    {screen === 'menu' && !audioEnabled && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center cursor-pointer" onClick={toggleAudio}>
                            <div className="text-center animate-pulse text-white">
                                <div className="text-6xl mb-4">ğŸ”Š</div>
                                <h2 className="text-3xl font-bold">é»æ“Šç•«é¢å•Ÿå‹•</h2>
                            </div>
                        </div>
                    )}

                    {screen === 'menu' && (
                        <div className="p-4 flex flex-col items-center gap-6 z-10 text-white w-full max-w-md">
                            <h1 className="text-4xl font-black text-yellow-400 drop-shadow-lg">è‹±é›„æ¦œ V16</h1>
                            
                            <div className="flex gap-2">
                                {Object.values(CHARACTERS).map(c => (
                                    <button key={c.id} onClick={()=>setPlayerKey(c.id)} className={`p-3 rounded-xl border-2 transition-all ${playerKey===c.id?'border-yellow-400 bg-white/20':'border-transparent opacity-50'}`}>
                                        <div className="text-3xl">{c.avatar}</div>
                                    </button>
                                ))}
                            </div>

                            <div className="bg-white/10 p-8 rounded-[3rem] w-full border-2 border-white/20 text-center">
                                <div className="scale-125 mb-4">
                                    <FullBodyChar charId={playerKey} items={stats[playerKey]?.earnedItems} />
                                </div>
                                <h2 className="text-xl font-bold mb-4">{CHARACTERS[playerKey].name}</h2>
                                <button onClick={startGame} className="bg-orange-600 w-full p-4 rounded-xl font-bold text-xl shadow-lg active:scale-95">
                                    é–‹å§‹å†’éšª
                                </button>
                            </div>
                            
                            <div className="text-xs text-gray-400">Build: V16 Safe Mode</div>
                        </div>
                    )}

                    {screen === 'game' && (
                        <div className="text-white text-center z-10">
                            <h1 className="text-4xl font-bold mb-8">æˆ°é¬¥ç•«é¢ç¯„ä¾‹</h1>
                            <FullBodyChar charId={playerKey} items={stats[playerKey]?.earnedItems} />
                            <button onClick={()=>setScreen('menu')} className="mt-8 bg-white text-black px-6 py-2 rounded-lg font-bold">è¿”å›</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
